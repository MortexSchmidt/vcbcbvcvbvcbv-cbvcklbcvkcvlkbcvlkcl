<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0f14;
            --card: #0f1720;
            --muted: #98a0b3;
            --text: #e6eef8;
            --accent: #6c8cff;
            --success: #22c55e;
            --danger: #ff6b6b;
            --glass: rgba(255,255,255,0.03);
            --shadow-1: 0 8px 28px rgba(2,6,23,0.6);
            --radius: 12px;
            --radius-sm: 8px;
            --gap: 14px;
            --transition: 180ms cubic-bezier(.2,.9,.2,1);
        }

        * { box-sizing: border-box; }
        html, body { height: 100%; }
    /* allow children to shrink properly inside flex/grid */
    .app-container, .app-main, .game-selection, .game-card, .view { min-width: 0 }

    /* ensure long text wraps instead of overflowing */
    .game-card, .menu-btn, .game-card button, .menu-btn, input, .bottom-nav button { word-break: break-word; white-space: normal }

    /* responsive tic-tac-toe board */
    #board { grid-template-columns: repeat(3, minmax(0, 1fr)); gap:8px; width:100%; max-width:520px }
    .ttt-cell { aspect-ratio: 1 / 1; width:100%; min-width:0; padding:0; }
        /* Disable default blue tap highlight and browser focus outlines on mobile */
        html, body, button, a, input, textarea, select {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }

        /* Remove outlines and default focus rings for interactive controls */
        button, .menu-btn, .game-card button, .ttt-cell, .game-choose, .game-lobby {
            outline: none !important;
            -webkit-appearance: none;
            appearance: none;
        }

        :focus { outline: none !important; box-shadow: none !important; }
        body {
            margin: 0;
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            background: var(--bg);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: env(safe-area-inset-top) 12px env(safe-area-inset-bottom);
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            width: 100%;
            max-width: 980px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-1);
            background: var(--card);
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 22px;
            height: calc(100vh - 28px);
        }

        /* Sidebar */
        .app-sidebar {
            padding: 18px;
            background: transparent;
            border-right: 1px solid rgba(255,255,255,0.03);
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: 100%;
        }

        .profile-row { display:flex; align-items:center; gap:12px; }
        .avatar { width:56px; height:56px; border-radius:12px; overflow:hidden; background:var(--glass); display:flex; align-items:center; justify-content:center; }
        .avatar img{ width:100%; height:100%; object-fit:cover }
        .profile-info { display:flex; flex-direction:column }
        .profile-name { font-weight:600 }
        .profile-sub { font-size:0.9rem; color:var(--muted) }

        .menu-buttons { display:flex; flex-direction:column; gap:10px; margin-top:6px }
        .menu-btn { display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:var(--text); cursor:pointer; transition:all var(--transition); font-weight:600; text-align:left; min-height:48px }
        .menu-btn.primary { background:var(--accent); color:#07102a; border:0 }
        .menu-btn.disabled { background:var(--muted); color:var(--card); cursor:not-allowed }
        .menu-btn:hover:not(.disabled){ transform:translateY(-1px); box-shadow:0 6px 18px rgba(2,6,23,0.55) }

        .app-main { padding:22px; display:flex; flex-direction:column; gap:18px; background:transparent; height:100%; overflow:auto }

        /* Game selection — on desktop column, on mobile horizontal cards */
        .game-selection { display:flex; flex-direction:column; gap:12px }
        .game-card { background:var(--card); border:1px solid var(--glass); border-radius:var(--radius); padding:16px; display:flex; flex-direction:column; gap:8px; }
        .game-card h3 { font-weight:600; color:var(--text); margin:0 }
        .game-card button { padding:12px 16px; border-radius:var(--radius-sm); border:1px solid var(--glass); background:var(--accent); color:#07102a; font-weight:700; cursor:pointer; transition:all var(--transition); }
        .game-card button.disabled { background:var(--muted); color:var(--card); cursor:not-allowed }
        .game-card button:hover:not(.disabled){ transform:translateY(-2px); box-shadow:0 8px 20px rgba(2,6,23,0.55) }

    /* Lobby list styles */
    .lobbies-list { display:flex; flex-direction:column; gap:10px }
    .lobby-card { display:flex; align-items:center; gap:12px; padding:12px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); border:1px solid rgba(255,255,255,0.03); transition:transform .12s ease, box-shadow .12s ease }
    .lobby-card:hover { transform:translateY(-4px); box-shadow:0 10px 30px rgba(2,6,23,0.5) }
    .lobby-avatar { width:44px; height:44px; border-radius:10px; background:var(--glass); display:flex; align-items:center; justify-content:center; font-weight:700; color:var(--text) }
    /* prevent avatar images from overflowing their container and keep consistent sizing */
    .lobby-avatar { overflow: hidden; flex: 0 0 44px; }
    .lobby-avatar img { width: 100%; height: 100%; object-fit: cover; display: block; border-radius: 8px; }
    .lobby-info { flex:1; min-width:0 }
    .lobby-name { font-weight:700; font-size:15px; color:var(--text); margin-bottom:4px }
    .lobby-meta { color:var(--muted); font-size:13px }
    .lobby-actions { display:flex; gap:8px }
    .lobby-actions { align-items: center; }
    .badge { padding:6px 8px; border-radius:999px; font-size:12px; font-weight:700; color:#07102a; background:var(--accent); }
    .badge.wait { background:#ffd166; color:#07102a }
    .badge.playing { background:var(--success); color:#07102a }

        /* Bottom navigation for mobile */
        .bottom-nav { display:none }

        /* Responsive adjustments for small screens (phones) */
        @media (max-width: 720px) {
            .app-container { grid-template-columns: 1fr; max-width:100%; border-radius:0; height:100vh }
            .app-sidebar { display:none }
            .app-main { padding:18px 14px 92px 14px }

            /* show cards as two columns on phones (no horizontal swipe) */
            .game-selection { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:12px; padding-bottom:12px }
            .game-card { width:100%; box-shadow: 0 6px 18px rgba(2,6,23,0.45); }

            /* bottom nav */
            .bottom-nav { position:fixed; left:0; right:0; bottom:0; height:74px; display:flex; gap:4px; align-items:center; justify-content:space-around; padding:8px calc(12px + env(safe-area-inset-left)) calc(8px + env(safe-area-inset-bottom)); background:linear-gradient(180deg, rgba(15,20,32,0.85), rgba(8,10,14,0.95)); border-top:1px solid rgba(255,255,255,0.04); backdrop-filter: blur(8px); z-index:50 }
            .bottom-nav button { background:transparent; border:none; color:var(--text); display:flex; flex-direction:column; align-items:center; gap:6px; font-weight:600; font-size:12px; padding:6px 8px; cursor:pointer }
            .bottom-nav svg { width:22px; height:22px; opacity:0.95 }

            /* Lobby header: stack input + button on very small screens */
            #view-lobby > div { justify-content: flex-start !important; align-items: flex-start; flex-direction: column; gap:8px; }
            /* place input and button on the same row, left aligned */
            #view-lobby > div > div { display:flex; flex-direction:row; gap:8px; align-items:center; }
            #lobby-name { flex: 1 1 auto; min-width:0; width: auto; margin:0; }
            #btn-create-lobby { flex: 0 0 auto; }

            /* Lobbies list layout improvements */
            .lobbies-list { padding: 6px 0; display:flex; flex-direction:column; gap:10px; }
            .lobby-card { width:100%; display:flex; flex-direction:row; align-items:center; gap:12px; padding:12px; border-radius:12px; box-shadow: 0 6px 18px rgba(2,6,23,0.25); background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent); }
            .lobby-avatar { width:44px; height:44px; flex:0 0 44px; border-radius:10px; }
            .lobby-info { flex:1 1 auto; min-width:0; }
            .lobby-actions { display:flex; gap:8px; flex:0 0 auto; }
            .lobby-name { font-size:15px; }
        }

        /* Game card selection styles + floating Play button */
        .game-card { transition: box-shadow var(--transition), outline var(--transition); }
        .game-card:focus { outline: 2px dashed rgba(108,140,255,0.18); }
    /* make selection visually robust even when global focus outlines are suppressed */
    .game-card.selected { border: 2px solid var(--accent); box-shadow: 0 14px 40px rgba(108,140,255,0.28); background: linear-gradient(180deg, rgba(20,30,60,0.6), rgba(12,20,34,0.6)); transform: translateY(-4px); animation: glow 900ms ease-in-out infinite alternate; }
        @keyframes glow { from { box-shadow: 0 8px 24px rgba(108,140,255,0.12); } to { box-shadow: 0 18px 44px rgba(108,140,255,0.28); } }

        .play-button {
            position: fixed;
            left: 50%;
            bottom: 86px; /* sits above bottom-nav */
            transform: translateX(-50%) translateY(8px) scale(.98);
            background: var(--accent);
            color: #07102a;
            padding: 12px 28px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            box-shadow: var(--shadow-1);
            opacity: 0;
            transition: opacity 260ms cubic-bezier(.2,.9,.2,1), transform 260ms cubic-bezier(.2,.9,.2,1);
            z-index: 1001;
            border: none;
            pointer-events: none;
        }
        .play-button.visible { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); pointer-events: auto; }

        @media (max-width: 720px) {
            /* hide action buttons inside game cards on phones (keep global nav) */
            .game-card .game-choose, .game-card .game-lobby, .game-card button { display: none !important; }
            .game-card { cursor: pointer; }
        }
    </style>
</head>
<body>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <div class="app-container">
        <aside class="app-sidebar">
            <div class="profile-row">
                <div class="avatar">
                    <img src="" alt="avatar" onerror="this.src='https://ui-avatars.com/api/?name=Guest&background=5865f2&color=ffffff&size=128';">
                </div>
                <div class="profile-info">
                    <div class="profile-name">Гость</div>
                    <div class="profile-sub">Не авторизован</div>
                </div>
            </div>

            <div class="menu-buttons">
                <button class="menu-btn primary" data-action="go-home">Играть</button>
                <button class="menu-btn" data-action="go-lobby">Лобби</button>
                <button class="menu-btn" data-action="go-settings">Настройки</button>
            </div>
        </aside>

        <main class="app-main">
            <!-- Views: home, lobby, game, settings -->
            <section id="view-home" class="view" data-view="home">
                <h2 style="margin:0 0 6px 0">Мини‑игры</h2>
                <p style="margin:0 0 12px 0;color:var(--muted)">Выберите игру и запустите. На телефоне — свайпните карточки.</p>

                <div class="game-selection" role="list">
                    <article class="game-card" data-game="tictactoe" role="listitem">
                        <h3>Крестики‑Нолики</h3>
                        <p style="margin:0;color:var(--muted);font-size:13px">Быстрая игра 1 на 1 в реальном времени.</p>
                        <div style="height:6px"></div>
                        <div style="display:flex;gap:8px">
                            <button class="game-choose" data-game="tictactoe">Играть</button>
                            <button class="game-lobby" data-game="tictactoe">Создать лобби</button>
                        </div>
                    </article>

                    <article class="game-card" data-game="memory" aria-disabled="true">
                        <h3>Мемо (скоро)</h3>
                        <p style="margin:0;color:var(--muted);font-size:13px">Карточная память — в разработке.</p>
                        <div style="height:6px"></div>
                        <button class="disabled">Скоро</button>
                    </article>

                    <article class="game-card" data-game="quiz" aria-disabled="true">
                        <h3>Quiz (скоро)</h3>
                        <p style="margin:0;color:var(--muted);font-size:13px">Викторина против друзей.</p>
                        <div style="height:6px"></div>
                        <button class="disabled">Скоро</button>
                    </article>
                </div>
            </section>

            <section id="view-lobby" class="view" data-view="lobby" style="display:none">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
                    <h2 style="margin:0">Лобби</h2>
                        <div style="display:flex;gap:8px;align-items:center">
                            <input id="lobby-name" placeholder="Название лобби" style="padding:10px;border-radius:10px;border:1px solid var(--glass);background:transparent;color:var(--text);flex:1;min-width:0">
                            <button id="btn-create-lobby" class="menu-btn">Создать</button>
                        </div>
                </div>

                    <div id="lobbies-list" class="lobbies-list" style="margin-top:12px"></div>
            </section>

            <section id="view-game" class="view" data-view="game" style="display:none">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
                    <h2 style="margin:0" id="game-title">Крестики‑Нолики</h2>
                    <div id="game-status" style="color:var(--muted);font-size:13px">Ожидание игрока...</div>
                </div>

                <div id="players-row" style="display:flex;gap:12px;align-items:center;margin-top:8px"></div>

                <div id="board" style="margin-top:16px;display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-width:360px">
                    <!-- cells injected here -->
                </div>

                <div style="margin-top:12px;display:flex;gap:8px">
                    <button id="btn-leave" class="menu-btn">Выйти из игры</button>
                    <button id="btn-forfeit" class="menu-btn">Сдаться</button>
                </div>
            </section>

            <section id="view-settings" class="view" data-view="settings" style="display:none">
                <h2 style="margin:0 0 10px 0">Настройки</h2>
                <p style="color:var(--muted)">Здесь будут настройки звука и уведомлений.</p>
            </section>
        </main>
    </div>

    <!-- Auth modal (blocks UI until authorized) -->
    <div id="auth-modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:200">
        <div style="width:92%;max-width:420px;background:var(--card);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 12px 40px rgba(2,6,23,0.6)">
            <h3 style="margin:0 0 8px 0">Авторизация</h3>
            <p style="margin:0 0 12px 0;color:var(--muted)">Чтобы играть в мини‑игры и использовать профиль Telegram, авторизуйтесь через бота. Это быстро и безопасно.</p>
            <div id="auth-state" style="margin-bottom:12px;color:var(--muted)">Нажмите «Получить код» и отправьте его боту командой <code>/start auth:&lt;код&gt;</code>.</div>
            <div style="display:flex;gap:8px;align-items:center">
                <button id="btn-get-code" class="menu-btn">Получить код</button>
                <input id="auth-code" readonly style="flex:1;padding:8px;border-radius:10px;border:1px solid var(--glass);background:transparent;color:var(--text);min-width:0">
                <button id="btn-copy-code" class="menu-btn">Копировать</button>
            </div>
            <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
                <button id="btn-auth-close" class="menu-btn" style="display:none">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Inline quick-match status (appears above floating play button) -->
    <div id="search-indicator" style="position:fixed;left:50%;bottom:140px;transform:translateX(-50%);display:none;z-index:1002;padding:8px 12px;border-radius:10px;background:rgba(2,6,23,0.9);border:1px solid rgba(255,255,255,0.03);font-weight:700;color:var(--text)"></div>

    <!-- Blocking match confirmation modal (appears when match found) -->
    <div id="confirm-modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.8);z-index:220">
        <div style="width:92%;max-width:520px;background:var(--card);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 12px 40px rgba(2,6,23,0.6)">
            <h3 id="confirm-title" style="margin:0 0 8px 0">Матч найден</h3>
            <p id="confirm-desc" style="margin:0 0 12px 0;color:var(--muted)">Подтвердите участие. Выйдя — вы получите временный бан.</p>
            <div style="display:flex;gap:8px;justify-content:space-between;align-items:center">
                <div id="confirm-timer" style="font-weight:700;color:var(--accent)">15</div>
                <div style="display:flex;gap:8px;justify-content:flex-end">
                    <button id="btn-decline" class="menu-btn">Отказаться</button>
                    <button id="btn-accept" class="menu-btn primary">Подтвердить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom nav для телефонов -->
    <nav class="bottom-nav" aria-hidden="false">
        <button class="bottom-play" data-action="go-home" title="Играть">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 3v18l15-9L5 3z" fill="currentColor"/></svg>
            <span>Играть</span>
        </button>
        <button class="bottom-lobby" data-action="go-lobby" title="Лобби">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5zm0 2c-3.86 0-7 3.14-7 7h2c0-2.761 2.239-5 5-5s5 2.239 5 5h2c0-3.86-3.14-7-7-7z" fill="currentColor"/></svg>
            <span>Лобби</span>
        </button>
        <button class="bottom-settings" data-action="go-settings" title="Настройки">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19.14 12.936a7.072 7.072 0 0 0 0-1.872l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.6-.22l-2.39.96a6.987 6.987 0 0 0-1.62-.94l-.36-2.54A.5.5 0 0 0 14.5 2h-4a.5.5 0 0 0-.5.42l-.36 2.54c-.57.22-1.11.52-1.62.94l-2.39-.96a.5.5 0 0 0-.6.22L2.71 8.87a.5.5 0 0 0 .12.64l2.03 1.58c-.05.31-.08.63-.08.95s.03.64.08.95L2.83 14.5a.5.5 0 0 0-.12.64l1.92 3.32c.14.24.44.34.69.22l2.39-.96c.5.42 1.05.72 1.62.94l.36 2.54c.05.28.28.48.56.48h4c.28 0 .51-.2.56-.48l.36-2.54c.57-.22 1.11-.52 1.62-.94l2.39.96c.25.1.55.02.69-.22l1.92-3.32a.5.5 0 0 0-.12-.64l-2.03-1.58zM12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7z" fill="currentColor"/></svg>
            <span>Настройки</span>
        </button>
    </nav>

    <script>
        // --- Helpers & state ---
        const tg = window.Telegram?.WebApp || {};
        try{ tg.expand?.() }catch(e){}
        try{ tg.ready?.() }catch(e){}

        const socket = io('https://vcbcbvcvbvcbv-cbvcklbcvkcvlkbcvlkcl-production.up.railway.app');
        let currentUser = null;
        let activeLobby = null; // { id, lobby }
    // global reference to floating play button (may be created later on mobile)
    let playButton = null;

        // init user from tg
        if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
            currentUser = { user_id: tg.initDataUnsafe.user.id, name: tg.initDataUnsafe.user.first_name || tg.initDataUnsafe.user.username || 'Игрок', avatar: '' };
            // notify server when connected
        }

        // update sidebar/profile UI
        function updateProfile(user){
            try{
                const profileName = document.querySelector('.profile-name');
                const profileSub = document.querySelector('.profile-sub');
                const avatarEl = document.querySelector('.avatar');
                if (!profileName || !avatarEl) return;
                profileName.textContent = user.name || ('User' + (user.user_id||''));
                profileSub.textContent = user.user_id ? ('ID: ' + user.user_id) : '';
                avatarEl.innerHTML = '';
                if (user.avatar){ const img = document.createElement('img'); img.src = user.avatar; img.alt = user.name || 'Avatar'; avatarEl.appendChild(img); }
                else { avatarEl.textContent = (user.name||'').slice(0,1).toUpperCase(); }
            }catch(e){ console.error('updateProfile err', e); }
        }

        socket.on('connect', ()=>{
            console.log('socket connected');
            if (currentUser) socket.emit('identify', currentUser);
            // refresh lobbies list when connect
            socket.emit('get_lobbies');
            // show auth modal if no init data from Telegram
            setTimeout(()=>{
                if (!(tg && tg.initDataUnsafe && tg.initDataUnsafe.user)) {
                    openAuthModal();
                }
            }, 250);
        });

        // --- Authorization modal flow ---
        function openAuthModal(){
            document.getElementById('auth-modal').style.display = 'flex';
        }

        function closeAuthModal(){
            document.getElementById('auth-modal').style.display = 'none';
        }

        document.getElementById('btn-get-code').addEventListener('click', async ()=>{
            const sid = socket.id;
            try{
                const resp = await fetch('/auth_code', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ sid }) });
                const j = await resp.json();
                if (j.code){
                    document.getElementById('auth-code').value = j.code;
                    let msg = 'Код сгенерирован. Отправьте в бота: /start auth:' + j.code + '.';
                    if (j.bot_username){
                        const tlink = 'https://t.me/' + j.bot_username + '?start=auth:' + j.code;
                        msg += ' Или нажмите ссылку ниже, чтобы открыть чат с ботом.';
                        // render link button if not present
                        if (!document.getElementById('auth-open-tg')){
                            const wrap = document.createElement('div'); wrap.style.marginTop='8px';
                            const a = document.createElement('a'); a.id='auth-open-tg'; a.href = tlink; a.target='_blank'; a.className='menu-btn'; a.textContent = 'Открыть в Telegram'; a.style.display='inline-flex'; a.style.alignItems='center'; a.style.gap='8px';
                            wrap.appendChild(a);
                            document.getElementById('auth-modal').querySelector('div').appendChild(wrap);
                        }
                    }
                    document.getElementById('auth-state').textContent = msg;
                    document.getElementById('btn-auth-close').style.display = 'inline-flex';
                } else if (j.error) {
                    document.getElementById('auth-state').textContent = 'Ошибка: ' + j.error;
                }
            }catch(e){
                document.getElementById('auth-state').textContent = 'Ошибка сети при запросе кода';
            }
        });

        document.getElementById('btn-copy-code').addEventListener('click', ()=>{
            const code = document.getElementById('auth-code').value;
            if (!code) return;
            navigator.clipboard?.writeText(code).then(()=>{ document.getElementById('auth-state').textContent = 'Код скопирован в буфер обмена'; }).catch(()=>{ document.getElementById('auth-state').textContent = 'Не удалось скопировать'; });
        });

        // server will emit 'telegram_profile' when user authorizes via bot
        socket.on('telegram_profile', (profile)=>{
            try{
                if (profile && profile.user_id){
                    currentUser = { user_id: profile.user_id, name: profile.name || ('User' + profile.user_id), avatar: profile.avatar || '' };
                    updateProfile(currentUser);
                    document.getElementById('auth-state').textContent = 'Авторизация прошла успешно!';
                    setTimeout(()=>{ closeAuthModal(); }, 800);
                }
            }catch(e){ console.error('profile handle err', e) }
        });

        document.getElementById('btn-auth-close').addEventListener('click', ()=>{ closeAuthModal(); });

        // --- View routing ---
        function showView(name){
            document.querySelectorAll('.view').forEach(v=>{ v.style.display = v.dataset.view===name ? 'block' : 'none'; v.classList.remove('view-enter'); });
            const enter = document.querySelector(`[data-view="${name}"]`);
            if (enter) { enter.classList.add('view-enter'); }
            // update bottom nav active state (optional)
        }

        // wire navigation buttons
        document.querySelectorAll('[data-action]').forEach(btn=>btn.addEventListener('click', e=>{
            const a = e.currentTarget.dataset.action;
            if (a==='go-home') showView('home');
            if (a==='go-lobby') { showView('lobby'); socket.emit('get_lobbies'); }
            if (a==='go-settings') showView('settings');
        }));

        // reauth button in settings
        (function(){
            const root = document.getElementById('view-settings');
            if (root){
                const btn = document.createElement('button'); btn.id='btn-reauth'; btn.className='menu-btn'; btn.textContent='Повторная авторизация';
                btn.style.marginTop='12px';
                btn.addEventListener('click', ()=>{ openAuthModal(); });
                root.appendChild(btn);
            }
        })();

        // Home actions: choose game or create lobby
        document.body.addEventListener('click', (e)=>{
            const choose = e.target.closest('.game-choose');
            const lobbyBtn = e.target.closest('.game-lobby');
            if (choose){
                const game = choose.dataset.game;
                if (game==='tictactoe') {
                    // quick create and wait for opponent: create lobby and stay
                    document.getElementById('lobby-name').value = `${currentUser?.name || 'Игрок'}'s lobby`;
                    showView('lobby');
                    // set focus to create button
                }
            }
            if (lobbyBtn){
                const game = lobbyBtn.dataset.game;
                showView('lobby');
            }
        });

        // Create lobby
        document.getElementById('btn-create-lobby').addEventListener('click', ()=>{
            // require auth
            if (!currentUser || !currentUser.user_id) { openAuthModal(); return; }
            const name = document.getElementById('lobby-name').value || `${currentUser?.name || 'Игрок'}'s lobby`;
            socket.emit('create_lobby', { name, player_name: currentUser?.name || 'Игрок', player_avatar: currentUser?.avatar || '', user_id: currentUser?.user_id });
        });

        // render lobbies
        function renderLobbies(list){
            const root = document.getElementById('lobbies-list');
            root.innerHTML = '';
            if (!list || list.length===0) {
                root.innerHTML = '<div style="color:var(--muted);padding:12px;border-radius:10px;border:1px dashed rgba(255,255,255,0.03)">Лобби ещё нет. Создайте своё!</div>';
                return;
            }

            // limit visible lobbies to first 10
            const visible = list.slice(0, 10);
            visible.forEach(lobby=>{
                const el = document.createElement('div');
                el.className = 'lobby-card';

                const avatar = document.createElement('div');
                avatar.className = 'lobby-avatar';
                // if avatar available from lobby.players[0].avatar use img, else show initial
                const firstPlayer = (lobby.players && lobby.players[0]) ? lobby.players[0] : null;
                if (firstPlayer && firstPlayer.avatar) {
                    const img = document.createElement('img'); img.src = firstPlayer.avatar; img.alt = firstPlayer.name || 'Игрок';
                    avatar.innerHTML = ''; avatar.appendChild(img);
                } else {
                    const initial = (lobby.name||'L').trim().slice(0,1).toUpperCase();
                    avatar.textContent = initial;
                }

                const info = document.createElement('div');
                info.className = 'lobby-info';
                info.innerHTML = `<div class="lobby-name">${escapeHtml(lobby.name || 'Лобби')}</div><div class="lobby-meta">Игроков: ${lobby.players?.length||0} • ${escapeHtml(lobby.status||'—')}</div>`;

                const actions = document.createElement('div');
                actions.className = 'lobby-actions';

                const statusBadge = document.createElement('div');
                statusBadge.className = 'badge ' + (lobby.status==='playing' ? 'playing' : 'wait');
                statusBadge.textContent = lobby.status==='playing' ? 'Игра' : 'Ожидание';

                const join = document.createElement('button'); join.className='menu-btn'; join.textContent = lobby.players && lobby.players.length>=2 ? 'Полное' : 'Войти';
                if (lobby.players && lobby.players.length>=2) join.disabled = true;
                join.addEventListener('click', ()=>{
                    if (!currentUser || !currentUser.user_id) { openAuthModal(); return; }
                    // prevent joining own lobby
                    const youIn = (lobby.players||[]).some(p=>p.user_id === currentUser.user_id || p.sid === socket.id);
                    if (youIn) { alert('Вы уже в этом лобби'); return; }
                    socket.emit('join_lobby', { lobby_id: lobby.id, player_name: currentUser?.name, player_avatar: currentUser?.avatar, user_id: currentUser?.user_id });
                });

                actions.appendChild(statusBadge);
                actions.appendChild(join);

                el.appendChild(avatar);
                el.appendChild(info);
                el.appendChild(actions);

                root.appendChild(el);
            });
        }

        socket.on('lobbies_list', (list)=>{ renderLobbies(list); });
        // when a quick-match hidden lobby is started, server emits 'lobby_started' with lobby data
        socket.on('lobby_started', (lobby)=>{
            try{
                if (!lobby) return;
                activeLobby = lobby;
                showLobby(activeLobby);
                showView('game');
                try{ SoundEngine.lobbyCreated(); }catch(e){}
            }catch(e){ console.error(e); }
        });
        // inline search indicator and play button toggle state
        let searching = false;
        let searchStart = 0;
        let searchTimer = null;

        function showSearchIndicator(){
            searching = true; searchStart = Date.now();
            document.getElementById('search-indicator').style.display = 'block';
            playButton.textContent = 'Отменить';
            playButton.classList.add('visible');
            playButton.setAttribute('aria-hidden','false');
            // start timer update
            if (searchTimer) clearInterval(searchTimer);
            searchTimer = setInterval(()=>{
                const elapsed = Math.floor((Date.now() - searchStart)/1000);
                const sec = String(elapsed).padStart(2,'0');
                document.getElementById('search-indicator').textContent = `Поиск: ${sec} — 1/2`;
            }, 500);
        }

        function hideSearchIndicator(){
            searching = false;
            document.getElementById('search-indicator').style.display = 'none';
            if (searchTimer) { clearInterval(searchTimer); searchTimer = null; }
            playButton.textContent = 'Играть';
            playButton.classList.remove('visible');
            playButton.setAttribute('aria-hidden','true');
        }

        socket.on('lobby_waiting', (data)=>{ try{ showSearchIndicator(); }catch(e){} });
        socket.on('lobby_cancelled', (data)=>{ try{ hideSearchIndicator(); }catch(e){} });

        

        // match found confirmation flow
        let confirmCountdown = null;
        socket.on('match_found', (payload)=>{
            try{
                // show blocking confirm modal
                document.getElementById('confirm-modal').style.display = 'flex';
                let timeLeft = 15;
                document.getElementById('confirm-timer').textContent = String(timeLeft);
                // start countdown
                if (confirmCountdown) clearInterval(confirmCountdown);
                confirmCountdown = setInterval(()=>{
                    timeLeft -= 1;
                    document.getElementById('confirm-timer').textContent = String(timeLeft);
                    if (timeLeft <= 0){
                        clearInterval(confirmCountdown); confirmCountdown = null;
                        // auto-decline if not confirmed
                        socket.emit('match_decline', { match_id: payload.match_id });
                        document.getElementById('confirm-modal').style.display = 'none';
                    }
                }, 1000);

                // accept/decline handlers
                document.getElementById('btn-accept').onclick = ()=>{
                    socket.emit('match_accept', { match_id: payload.match_id });
                    document.getElementById('confirm-modal').style.display = 'none';
                    if (confirmCountdown){ clearInterval(confirmCountdown); confirmCountdown=null; }
                };
                document.getElementById('btn-decline').onclick = ()=>{
                    socket.emit('match_decline', { match_id: payload.match_id });
                    document.getElementById('confirm-modal').style.display = 'none';
                    if (confirmCountdown){ clearInterval(confirmCountdown); confirmCountdown=null; }
                };
            }catch(e){ console.error(e); }
        });

        socket.on('match_cancelled', (data)=>{ try{ hideSearchIndicator(); document.getElementById('confirm-modal').style.display = 'none'; if (confirmCountdown){ clearInterval(confirmCountdown); confirmCountdown=null; } }catch(e){} });
        socket.on('lobby_created', (data)=>{
            // server returns lobby_id and lobby
            const lobby = data.lobby || data;
            // show lobby view and join room locally by id
            // We already are creator; server registered player
            activeLobby = lobby;
            showLobby(activeLobby);
            showView('game');
            try{ SoundEngine.lobbyCreated(); }catch(e){}
        });

        socket.on('update_lobby', (lobby)=>{
            // update activeLobby if matches
            if (!lobby) return;
            // if lobby object contains id
            if (activeLobby && lobby.id && activeLobby.id===lobby.id) {
                activeLobby = lobby;
            } else {
                // if not our lobby, but server sends update while in game view, swap
                activeLobby = lobby;
            }
            // if game started — show game
            if (lobby.status==='playing') { showLobby(lobby); showView('game'); }
            else { showLobby(lobby); }
        });

        socket.on('update_lobbies', (data)=>{ renderLobbies(data); });

        function showLobby(lobby){
            activeLobby = lobby;
            // players row
            const pr = document.getElementById('players-row'); pr.innerHTML = '';
            (lobby.players||[]).forEach(p=>{
                const d = document.createElement('div'); d.style.display='flex'; d.style.alignItems='center'; d.style.gap='8px';
                const imgWrap = document.createElement('div'); imgWrap.style.width='40px'; imgWrap.style.height='40px'; imgWrap.style.borderRadius='8px'; imgWrap.style.background='var(--glass)'; imgWrap.style.display='flex'; imgWrap.style.alignItems='center'; imgWrap.style.justifyContent='center'; imgWrap.style.fontWeight='600';
                if (p.avatar){ const img = document.createElement('img'); img.src = p.avatar; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; img.style.borderRadius='8px'; imgWrap.appendChild(img); }
                else { imgWrap.textContent = escapeHtml((p.name||'Игрок').slice(0,1)); }
                const infoWrap = document.createElement('div'); infoWrap.innerHTML = `<div style='font-weight:600'>${escapeHtml(p.name||'Игрок')}</div><div style='color:var(--muted);font-size:12px'>${escapeHtml(p.symbol||'')}</div>`;
                d.appendChild(imgWrap); d.appendChild(infoWrap);
                pr.appendChild(d);
            });

            const status = document.getElementById('game-status');
            status.textContent = lobby.status==='playing' ? 'Игра в процессе' : 'Ожидание игроков...';

            // render board if present
            if (lobby.board) renderBoard(lobby);
        }

        // Board rendering for tictactoe
        function renderBoard(lobby){
            const boardEl = document.getElementById('board');
            boardEl.innerHTML = '';
            const board = lobby.board || ['', '', '', '', '', '', '', '', ''];
            for (let i=0;i<9;i++){
                const cell = document.createElement('button');
                cell.className = 'ttt-cell';
                cell.dataset.pos = i;
                // use CSS aspect-ratio for square cells, set visual styles
                cell.style.borderRadius = '12px';
                cell.style.display = 'flex';
                cell.style.alignItems = 'center';
                cell.style.justifyContent = 'center';
                cell.style.fontSize = window.innerWidth < 420 ? '22px' : '28px';
                cell.style.background = 'linear-gradient(180deg, rgba(255,255,255,0.02), transparent)';
                cell.style.border = '1px solid rgba(255,255,255,0.04)';
                cell.textContent = board[i] || '';
                if (!board[i] && lobby.status==='playing'){
                    cell.addEventListener('click', ()=>{
                        // emit make_move
                        if (!activeLobby || !activeLobby.id) return;
                        socket.emit('make_move', { lobby_id: activeLobby.id, position: i });
                    });
                }
                boardEl.appendChild(cell);
            }
        }

        // leave / forfeit
        document.getElementById('btn-leave').addEventListener('click', ()=>{ activeLobby=null; showView('home'); socket.emit('get_lobbies'); });
        document.getElementById('btn-forfeit').addEventListener('click', ()=>{ if (activeLobby && activeLobby.id) socket.emit('make_move',{ lobby_id: activeLobby.id, position: -1, forfeit:true }); });

        // safe html
        function escapeHtml(s){ return String(s||'').replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

        // After initial load show home
        showView('home');

        // --- Modern WebAudio sound engine (layered synth + noise) ---
        const SoundEngine = (function(){
            let ac = null;
            let muted = false;

            function init(){ if (ac) return; ac = new (window.AudioContext || window.webkitAudioContext)(); }
            function resume(){ if (!ac) init(); if (ac.state === 'suspended') return ac.resume(); return Promise.resolve(); }

            // removed complex noise generator to avoid 8-bit artifacts; use pure tones only

            // Percussive tactile click: softened transient using sine body + filtered click + shaped noise
            function playClick(opts){
                if (!ac) init();
                const now = ac.currentTime + (opts.delay || 0);

                // body oscillator (low) for 'thud' — use sine for smoothness
                const body = ac.createOscillator(); body.type = opts.bodyType || 'sine';
                body.frequency.setValueAtTime(opts.bodyFreq || 160, now);
                const gBody = ac.createGain(); gBody.gain.setValueAtTime(0.0001, now);
                gBody.gain.linearRampToValueAtTime(opts.bodyGain || 0.10, now + 0.002);
                gBody.gain.exponentialRampToValueAtTime(0.0001, now + (opts.bodyDur || 0.12));
                body.connect(gBody);

                // click oscillator (high transient) — use sine and gentle sweep, then lowpass to remove digital harshness
                const click = ac.createOscillator(); click.type = opts.clickType || 'sine';
                click.frequency.setValueAtTime(opts.clickFreq || 2200, now);
                // gentler pitch sweep for character without chiptune artifacts
                click.frequency.linearRampToValueAtTime((opts.clickFreq || 2200) * 0.85, now + 0.035);
                const gClick = ac.createGain(); gClick.gain.setValueAtTime(0.0001, now);
                gClick.gain.linearRampToValueAtTime(opts.clickGain || 0.08, now + 0.003);
                gClick.gain.exponentialRampToValueAtTime(0.0001, now + (opts.clickDur || 0.05));
                // lowpass to soften the top end (removes '8-bit' brightness)
                const clickLP = ac.createBiquadFilter(); clickLP.type = 'lowpass'; clickLP.frequency.setValueAtTime(opts.clickLP || 3800, now);
                click.connect(clickLP);
                clickLP.connect(gClick);

                // removed noise path; rely on body + filtered click for tactile feel

                // master gain for click
                const master = ac.createGain(); master.gain.setValueAtTime(opts.masterGain || 1.0, now);

                // routing
                gBody.connect(master); gClick.connect(master);
                master.connect(ac.destination);

                // start/stop
                body.start(now); body.stop(now + (opts.bodyDur || 0.12) + 0.02);
                click.start(now); click.stop(now + (opts.clickDur || 0.05) + 0.01);
                // no noise to start
            }

            // small melodic ping for confirmations — keep smooth sine and slightly lower amplitude
            function playPing(freq, dur, amp, delay){
                if (!ac) init();
                const now = ac.currentTime + (delay || 0);
                const o = ac.createOscillator(); o.type = 'sine'; o.frequency.setValueAtTime(freq, now);
                const g = ac.createGain(); g.gain.setValueAtTime(0.0001, now);
                g.gain.linearRampToValueAtTime((amp || 0.09), now + 0.006);
                g.gain.exponentialRampToValueAtTime(0.0001, now + (dur || 0.16));
                // subtle highcut so pings aren't too bright
                const lp = ac.createBiquadFilter(); lp.type = 'lowpass'; lp.frequency.setValueAtTime(5200, now);
                o.connect(g); g.connect(lp); lp.connect(ac.destination);
                o.start(now); o.stop(now + (dur || 0.16) + 0.02);
            }

            function uiClick(kind){ // very simple UI clicks: short sine click
                resume().then(()=>{
                    if (!ac) return;
                    const now = ac.currentTime;
                    const o = ac.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(kind==='primary' ? 800 : 600, now);
                    const g = ac.createGain(); g.gain.setValueAtTime(0.0001, now);
                    g.gain.linearRampToValueAtTime(kind==='primary' ? 0.12 : 0.08, now + 0.006);
                    g.gain.exponentialRampToValueAtTime(0.0001, now + 0.09);
                    o.connect(g); g.connect(ac.destination);
                    o.start(now); o.stop(now + 0.09);
                }).catch(()=>{});
            }

            function select(){ resume().then(()=>{ uiClick('soft'); }); }
            function modalOpen(){ resume().then(()=>{ uiClick('primary'); }); }
            function create(){ resume().then(()=>{ uiClick('primary'); }); }
            function lobbyCreated(){ resume().then(()=>{ uiClick('primary'); setTimeout(()=>{ uiClick('soft'); }, 120); }); }

            // modern presets
            function setMuted(v){ muted = !!v; }
            function isMuted(){ return !!muted; }

            // no UI mute button by default (removed per request)
            // init muted default false
            (function(){ muted = false; })();

            return { init, resume, uiClick, select, modalOpen, create, lobbyCreated };
        })();

        // --- Game selection: mobile-friendly selection + floating Play button ---
        (function(){
            const isMobile = window.matchMedia && window.matchMedia('(max-width: 720px)').matches;
            if (!isMobile) return; // only change behaviour on small screens

            // create floating play button if not present
            playButton = document.querySelector('.play-button');
            if (!playButton) {
                playButton = document.createElement('button');
                playButton.className = 'play-button';
                playButton.setAttribute('aria-hidden', 'true');
                playButton.textContent = 'Играть';
                document.body.appendChild(playButton);
            }

            let selected = null;

            function updateListeners(){
                const cards = document.querySelectorAll('.game-selection .game-card');
                cards.forEach(card => {
                    card.setAttribute('role','button');
                    card.setAttribute('tabindex','0');
                    card.onclick = null;
                    card.addEventListener('click', (e)=>{
                        e.stopPropagation();
                        // do not allow selecting disabled/coming-soon cards
                        if (card.getAttribute('aria-disabled') === 'true' || card.querySelector('.disabled')) return;

                        if (selected === card) {
                            card.classList.remove('selected');
                            card.setAttribute('aria-selected','false');
                            selected = null;
                            playButton.classList.remove('visible');
                            playButton.setAttribute('aria-hidden','true');
                        } else {
                            if (selected) { selected.classList.remove('selected'); selected.setAttribute('aria-selected','false'); }
                            selected = card;
                            card.classList.add('selected');
                            card.setAttribute('aria-selected','true');
                            // force focus and repaint so visual border appears immediately
                            try{ card.focus(); card.getBoundingClientRect(); }catch(e){}
                            // show animated play button
                            playButton.classList.add('visible');
                            playButton.setAttribute('aria-hidden','false');
                            // ensure audio context is allowed by user gesture and play a select sound
                            try{ SoundEngine.init(); SoundEngine.select(); }catch(e){}
                        }
                    });
                    card.addEventListener('keydown', (ev)=>{
                        if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); card.click(); }
                    });
                });
            }

            updateListeners();

            // hide selection when tapping outside
            document.addEventListener('click', (ev)=>{
                // if clicked outside both card and modal and not on playButton — clear selection
                if (!ev.target.closest('.game-card') && !ev.target.closest('.play-button') && !ev.target.closest('.game-modal')){
                    if (selected) { selected.classList.remove('selected'); selected.setAttribute('aria-selected','false'); selected = null; }
                    playButton.classList.remove('visible');
                    playButton.setAttribute('aria-hidden','true');
                }
            });

            // clicking floating Play triggers quick-match (fast play) for selected game
            playButton.addEventListener('click', (ev)=>{
                ev.stopPropagation();
                if (!selected) return;
                // quick match: emit 'quick_match' to server (hidden lobby)
                if (!currentUser || !currentUser.user_id) { openAuthModal(); return; }
                socket.emit('quick_match', { player_name: currentUser?.name, player_avatar: currentUser?.avatar, user_id: currentUser?.user_id });
                try{ SoundEngine.modalOpen(); }catch(e){}
            });

            // Modal: show selected game and allow create lobby
            function openGameModal(card){
                // if modal exists, remove
                const existing = document.querySelector('.game-modal');
                if (existing) existing.remove();

                const game = card.dataset.game || '';
                const title = card.querySelector('h3')?.textContent || game;

                const overlay = document.createElement('div');
                overlay.className = 'game-modal';
                overlay.style.position = 'fixed';
                overlay.style.inset = '0';
                overlay.style.display = 'flex';
                overlay.style.alignItems = 'center';
                overlay.style.justifyContent = 'center';
                overlay.style.background = 'rgba(2,6,23,0.6)';
                overlay.style.zIndex = 1200;

                const box = document.createElement('div');
                box.style.width = '92%'; box.style.maxWidth = '420px'; box.style.background = 'var(--card)'; box.style.border = '1px solid var(--glass)'; box.style.borderRadius='12px'; box.style.padding='18px'; box.style.boxShadow='0 14px 40px rgba(2,6,23,0.6)';

                box.innerHTML = `<h3 style="margin:0 0 8px 0">${escapeHtml(title)}</h3><p style="margin:0 0 12px 0;color:var(--muted)">Создать лобби и ждать противника. Название лобби можно изменить.</p>`;
                const input = document.createElement('input');
                input.value = `${currentUser?.name || 'Игрок'}'s lobby`;
                input.style.width='100%'; input.style.padding='10px'; input.style.borderRadius='10px'; input.style.border='1px solid var(--glass)'; input.style.background='transparent'; input.style.color='var(--text)'; input.style.marginBottom='12px';

                const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.justifyContent='flex-end';
                const btnCreate = document.createElement('button'); btnCreate.className='menu-btn primary'; btnCreate.textContent='Создать лобби';
                const btnClose = document.createElement('button'); btnClose.className='menu-btn'; btnClose.textContent='Отмена';
                row.appendChild(btnClose); row.appendChild(btnCreate);

                box.appendChild(input); box.appendChild(row);
                overlay.appendChild(box);
                document.body.appendChild(overlay);

                // prevent outside clicks from closing modal unintentionally
                overlay.addEventListener('click', (e)=>{ if (e.target === overlay){ /* click outside closes modal */ overlay.remove(); } });
                btnClose.addEventListener('click', ()=>{ overlay.remove(); });

                btnCreate.addEventListener('click', ()=>{
                    const name = input.value || `${currentUser?.name || 'Игрок'}'s lobby`;
                    // emit create_lobby — socket handler on server will send 'lobby_created' and client will switch to game view
                    socket.emit('create_lobby', { name, player_name: currentUser?.name || 'Игрок', player_avatar: currentUser?.avatar || '', user_id: currentUser?.user_id });
                    try{ SoundEngine.create(); }catch(e){}
                    // show waiting state in modal
                    box.innerHTML = `<h3 style="margin:0 0 8px 0">${escapeHtml(title)}</h3><p style="margin:0 0 12px 0;color:var(--muted)">Лобби создаётся. Ожидание игроков...</p><div style="display:flex;gap:8px;justify-content:flex-end;"><button class="menu-btn">Закрыть</button></div>`;
                    const closeNow = box.querySelector('.menu-btn');
                    closeNow.addEventListener('click', ()=>{ overlay.remove(); });
                });
            }
        })();

        // Delegated UI sound handler — covers buttons, menu-btn, links, input interactions
        (function(){
            document.addEventListener('click', (ev)=>{
                const btn = ev.target.closest('button, [role=button], a, input, select, textarea');
                if (!btn) return;
                // ignore decorative controls
                if (btn.disabled) return;
                // decide kind
                let kind = 'neutral';
                if (btn.classList && btn.classList.contains('primary')) kind = 'primary';
                else if (btn.classList && btn.classList.contains('danger')) kind = 'destructive';
                else if (btn.classList && btn.classList.contains('menu-btn')) kind = 'soft';
                try{ SoundEngine.uiClick(kind); }catch(e){}
            }, { capture: true });

            // also keyboard activation (Enter/Space)
            document.addEventListener('keydown', (ev)=>{
                if (ev.key !== 'Enter' && ev.key !== ' ') return;
                const el = document.activeElement;
                if (!el) return;
                const interactive = el.matches && el.matches('button, [role=button], a, input[type=checkbox], input[type=radio]');
                if (!interactive) return;
                let kind = 'neutral';
                if (el.classList && el.classList.contains('primary')) kind = 'primary';
                try{ SoundEngine.uiClick(kind); }catch(e){}
            });
        })();
    </script>
</body>
</html>