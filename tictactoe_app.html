<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Dark, human-made flat UI — no gradients, readable, comfortable */
        :root{
            --bg: #0b0f14;          /* page background - very dark */
            --card: #0f1720;        /* cards and panels */
            --muted: #98a0b3;       /* secondary text (lighter for dark bg) */
            --text: #e6eef8;        /* primary text */
            --accent: #6c8cff;      /* accent color */
            --success: #22c55e;
            --danger: #ff6b6b;
            --glass: rgba(255,255,255,0.03);
            --shadow-1: 0 8px 28px rgba(2,6,23,0.6);
            --radius: 12px;
            --radius-sm: 8px;
            --gap: 14px;
            --transition: 180ms cubic-bezier(.2,.9,.2,1);
        }

        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            margin:0;
            font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            background:var(--bg);
            color:var(--text);
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            display:flex;
            align-items:center;
            justify-content:center;
            padding:22px;
        }

        .app-container{
            width:100%;
            max-width:920px;
            border-radius:16px;
            overflow:hidden;
            box-shadow:var(--shadow-1);
            background:var(--card);
            display:grid;
            grid-template-columns: 320px 1fr;
            gap:22px;
        }

        /* Sidebar */
        .app-sidebar{
            padding:18px;
            background:transparent;
            border-right:1px solid rgba(255,255,255,0.03);
            display:flex;
            flex-direction:column;
            gap:12px;
        }

    .app-header{display:flex;align-items:center;gap:12px}
    .app-title{
      margin:0;font-weight:700;font-size:1.25rem;display:flex;align-items:center;gap:12px;color:var(--text)
    }
    .app-title i{color:var(--accent);font-size:1.4rem}

    .profile-row{display:flex;align-items:center;gap:12px}
    .avatar{
            width:56px;height:56px;max-width:56px;max-height:56px;border-radius:12px;flex:0 0 56px;overflow:hidden;background:var(--glass);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--card);
    }
    .avatar img{width:100%;height:100%;object-fit:cover}
        /* Normalize other avatar images across UI */
        .player-display-avatar-img, .lobby-player-avatar-img, .player-avatar-img, .player-display img {
            width:48px;height:48px;border-radius:8px;object-fit:cover;display:block;flex-shrink:0;
        }

    .profile-info{display:flex;flex-direction:column}
    .profile-name{font-weight:600}
    .profile-sub{font-size:0.9rem;color:var(--muted)}

    .menu-buttons{display:flex;flex-direction:column;gap:10px;margin-top:6px}
    /* Menu buttons: allow wrapping, prevent icon wrap, consistent min height */
    .menu-btn{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);cursor:pointer;transition:all var(--transition);font-weight:600;white-space:normal;word-break:break-word;text-align:left;min-height:48px;line-height:1.15;overflow-wrap:anywhere}
    .menu-btn i{width:28px;text-align:center;color:var(--accent);flex-shrink:0;flex-basis:28px}
    .menu-btn.primary{background:var(--accent);color:#07102a;border:0}
    .menu-btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(2,6,23,0.55)}

    /* Main area */
    .app-main{padding:22px;display:flex;flex-direction:column;gap:18px;background:transparent}
    /* Sections keep the card background to ensure consistent dark surfaces */
    .section{background:var(--card);border-radius:12px;padding:16px;border:1px solid var(--glass)}
    .section-title{display:flex;align-items:center;gap:10px;font-weight:700;color:var(--text);margin:0 0 8px 0}
    .section-title i{color:var(--accent)}

    .lobby-grid{display:flex;flex-direction:column;gap:12px}
    .lobby-card{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent}
    .lobby-meta{display:flex;align-items:center;gap:12px}
    .lobby-name{font-weight:600}
    .lobby-players{display:flex;gap:8px;align-items:center}
    .player-small{width:36px;height:36px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent)}

    .lobby-actions{display:flex;gap:8px}
    .action-btn{padding:8px 12px;border-radius:10px;border:1px solid var(--glass);background:transparent;cursor:pointer;font-weight:600;min-height:40px;line-height:1.05}
    .action-btn.primary{background:var(--accent);color:#07102a;border:0}
    .action-btn.ghost{background:transparent;color:var(--muted)}

    /* Board */
    .game-board{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:10px}
    .game-cell{aspect-ratio:1;border-radius:12px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;font-size:2.1rem;font-weight:800;color:var(--text);cursor:pointer;border:1px solid rgba(255,255,255,0.03);transition:transform var(--transition),box-shadow var(--transition);padding:4px}
    .game-cell:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,0.5)}
    .game-cell.taken{opacity:0.9;cursor:default}

    .game-controls{display:flex;gap:10px;justify-content:center}
    .game-btn{padding:10px 14px;border-radius:10px;border:1px solid var(--glass);background:transparent;cursor:pointer;font-weight:700;min-height:44px;line-height:1.05}
    .game-btn.primary{background:var(--accent);color:#07102a;border:0}
    .game-btn.danger{background:transparent;color:var(--danger);border:1px solid rgba(220,38,38,0.12)}

    /* Modal / overlay tweaks */
    .modal-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:60}
    .modal-content{width:420px;background:#0c1318;border-radius:12px;padding:20px;border:1px solid rgba(255,255,255,0.03);box-shadow:var(--shadow-1)}

    /* Auth overlay uses same modal style but centered */
    /* Auth overlay uses modal-like fullscreen styling to avoid white flashes */
    .auth-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:70}

    /* Responsive */
        @media (max-width:880px){
            .app-container{grid-template-columns:1fr;max-width:920px}
            .app-sidebar{order:2}
            .app-main{order:1}
            body{padding:18px}
        }

        /* Smaller devices: reduce button font-size to avoid clipping */
        @media (max-width:480px){
            .menu-btn{font-size:0.95rem;padding:10px;min-height:46px}
            .game-cell{font-size:1.45rem}
        }

    /* Small helpers */
    .muted{color:var(--muted);font-size:0.95rem}
    .center{display:flex;align-items:center;justify-content:center}
    /* Lobby layout helpers: place control buttons at bottom of lobby room */
    #lobbyRoom{display:flex;flex-direction:column;gap:12px;min-height:220px}
    #lobbyPlayersList{flex:1;overflow:auto}
    #lobbyRoomBtns{margin-top:auto;display:flex;gap:8px;flex-wrap:wrap}
    </style>
    <style>
    /* Toasts */
    .toast-wrap{position:fixed;right:18px;top:18px;display:flex;flex-direction:column;gap:8px;z-index:9999}
    .toast{min-width:220px;padding:10px 14px;border-radius:10px;color:#fff;font-weight:600;box-shadow:0 8px 22px rgba(8,12,20,0.12);transform-origin:right top;transition:transform 200ms ease,opacity 200ms ease}
    .toast.info{background:var(--accent)}
    .toast.success{background:var(--success)}
    .toast.warn{background:#ff8c00}
    .toast.error{background:var(--danger)}
    .toast{color:#07102a}
    .toast.hide{opacity:0;transform:translateX(12px) scale(.98)}
    </style>
</head>
<body>
    <div id="mainContainer" class="app-container">
        <aside class="app-sidebar">
            <div class="app-header">
                <i class="fas fa-chess-knight"></i>
                <h1 class="app-title">Крестики‑Нолики</h1>
            </div>

            <div class="profile-row">
                <div class="avatar" id="profileAvatar">
                    <img id="profileAvatarImg" src="" alt="avatar" onerror="this.style.display='none'">
                </div>
                <div class="profile-info">
                    <div class="profile-name" id="profileName">Гость</div>
                    <div class="profile-sub muted" id="profileSub">Не авторизован</div>
                </div>
            </div>
                <div class="toast-wrap" id="toastWrap" aria-live="polite"></div>

            <div class="menu-buttons">
                <button class="menu-btn primary" id="createLobbyBtn"><i class="fas fa-plus-circle"></i>Создать лобби</button>
                <button class="menu-btn" id="refreshProfileBtn"><i class="fas fa-sync-alt"></i>Обновить профиль</button>
                <button class="menu-btn" id="authorizeBtn"><i class="fab fa-telegram-plane"></i>Авторизоваться</button>
            </div>

            <div class="section muted" style="margin-top:auto;font-size:0.92rem">Игра локальная · Поддержка Telegram</div>
        </aside>

        <main class="app-main">
            <div class="section" id="lobbySection">
                <h3 class="section-title"><i class="fas fa-list"></i>Доступные игры</h3>
                <div class="lobby-grid" id="lobbyList"> <!-- Лобби динамически --> </div>
            </div>

        <div class="section" id="lobbyRoom" style="display:none;">
                <h3 class="section-title"><i class="fas fa-users"></i>Комната ожидания</h3>
                <div id="lobbyPlayersList" style="display:flex;flex-direction:column;gap:10px"></div>
                <div id="lobbyRoomBtns" style="margin-top:12px;display:flex;gap:8px"></div>
            </div>

        <div class="section" id="gameBoard" style="display:none;">
                <h3 class="section-title"><i class="fas fa-gamepad"></i>Игровое поле</h3>
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
                                <div style="display:flex;flex-direction:column;gap:6px">
                                    <div class="muted" id="gameStatusIndicator">Ход игрока</div>
                                    <div id="gameStatusText" class="muted" style="font-weight:600">Ваш ход</div>
                                </div>
                    <div style="display:flex;align-items:center;gap:10px">
                        <div class="avatar" style="width:40px;height:40px;border-radius:10px;overflow:hidden"><img id="currentPlayerAvatar" src="" onerror="this.style.display='none'"/></div>
                        <div id="currentPlayerName" class="muted">Игрок</div>
                    </div>
                </div>

                <div class="game-board" id="boardGrid">
                    <div class="game-cell" data-index="0"></div>
                    <div class="game-cell" data-index="1"></div>
                    <div class="game-cell" data-index="2"></div>
                    <div class="game-cell" data-index="3"></div>
                    <div class="game-cell" data-index="4"></div>
                    <div class="game-cell" data-index="5"></div>
                    <div class="game-cell" data-index="6"></div>
                    <div class="game-cell" data-index="7"></div>
                    <div class="game-cell" data-index="8"></div>
                </div>

                <div class="game-controls" style="margin-top:14px">
                    <button class="game-btn" id="leaveGameBtn"><i class="fas fa-arrow-left"></i>Покинуть</button>
                    <button class="game-btn primary" id="newGameBtn"><i class="fas fa-redo-alt"></i>Новая игра</button>
                </div>
            </div>
            <!-- players display (used by JS) -->
            <div id="playersDisplay" style="display:none"></div>

        </main>

    <!-- Win modal (kept for JS) -->
    <div id="winModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <div id="winModalAnim" class="modal-icon">🎉</div>
            <h2 id="winModalText" class="modal-title">Победа!</h2>
            <p class="modal-description">Поздравляем с победой в игре!</p>
            <div id="winModalBtns" class="modal-buttons"></div>
        </div>
    </div>
    </div>
            <!-- Оверлей авторизации -->
            <div id="authOverlay" class="auth-overlay" style="display:none;">
                <div class="auth-container section" style="width:420px;max-width:92%;">
                        <h2 class="section-title"><i class="fab fa-telegram-plane"></i>Авторизация</h2>
                        <p class="muted">Подтвердите личность через Telegram‑бота, чтобы синхронизировать профиль.</p>
                        <div style="height:12px"></div>
                        <button id="authActionBtn" class="menu-btn primary" style="width:100%;">
                            <i class="fab fa-telegram-plane"></i>
                            Авторизоваться через бота
                        </button>
                        <div id="authStatus" class="muted" style="margin-top:12px">Подготовка к авторизации...</div>
                    </div>
            </div>


        <noscript>
            <div style="padding:32px;text-align:center;color:#ff6b6b;font-size:1.2rem;">Для работы Mini‑App требуется включить JavaScript.</div>
        </noscript>
        <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
        <script>

        // Глобальные переменные
        let socket;
        let currentLobby = null;
        let currentPlayer = null;
        let playerName = '';
        let playerAvatar = '';
        let webUserId = null;

        // Инициализация приложения
    document.addEventListener('DOMContentLoaded', function() {
            // Проверяем localStorage на наличие сохранённого профиля
            let savedProfile = null;
            try {
                savedProfile = JSON.parse(localStorage.getItem('tic_profile'));
            } catch (e) { savedProfile = null; }

            if (savedProfile && savedProfile.user_id) {
                // Если профиль сохранён — используем его
                webUserId = savedProfile.user_id;
                playerName = savedProfile.name || 'Игрок';
                playerAvatar = savedProfile.avatar || '';
            updateProfileUI();
            startApp();
            } else if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready(); // Сообщаем Telegram, что Mini-App готова
                tg.expand(); // Расширяем на весь экран если возможно


                // Ждем немного и пытаемся получить профиль
                setTimeout(() => {
                    const user = tg.initDataUnsafe?.user;
                    if (user && user.id) {
                        webUserId = user.id;
                        playerName = user.first_name || user.username || 'Игрок';
                        playerAvatar = '';
                        updateProfileUI();
                        // Сохраняем профиль в localStorage
                        localStorage.setItem('tic_profile', JSON.stringify({ user_id: webUserId, name: playerName, avatar: playerAvatar }));
                        startApp();
                    } else {
                        // Если не удалось, используем дефолт
                        playerName = 'Гость';
                        playerAvatar = '';
                        webUserId = null;
                        updateProfileUI();
                        startApp();
                    }
                }, 500);
            } else {
                // Не в Telegram, дефолт
                playerName = 'Гость';
                playerAvatar = '';
                webUserId = null;
                startApp();
            }
        });

    function startApp() {
            // Подключаемся к серверу
            socket = io();

            socket.on('connect', () => {
              // connection established
            });
            socket.on('connect_error', (err) => {
              // connection error
            });
            socket.on('disconnect', () => {
              // disconnected
            });

            // Если есть user_id, отправляем профиль
            if (webUserId && socket) {
                socket.emit('identify', { user_id: webUserId, name: playerName, avatar: playerAvatar });
            }

            // Если нет профиля — показываем обязательный оверлей авторизации
            if (!webUserId) {
                showAuthOverlay();
                // Fallback: если профиль не придёт за 10 секунд — показать ошибку
                setTimeout(() => {
                    if (document.getElementById('mainContainer').style.display === 'none') {
                            showToast('error','Не удалось получить профиль. Проверьте Telegram и попробуйте ещё раз.');
                            document.getElementById('authActionBtn').textContent = 'Повторить авторизацию';
                        }
                }, 10000);
            } else {
                hideAuthOverlay();
            }

            // Настраиваем слушатели
            setupSocketListeners();
            setupEventListeners();
            getLobbies();
        }

        function setupSocketListeners() {
            socket.on('connect', () => {
            });

            socket.on('disconnect', () => {
            });


            socket.on('lobby_created', (data) => {
                currentLobby = data.lobby;
                currentPlayer = data.lobby.players[0];
                showLobbyRoom();
            });

            socket.on('update_lobby', (lobby) => {
                currentLobby = lobby;
                // если в списке игроков есть запись с нашим sid — назначим currentPlayer
                try {
                    if (lobby.players && socket.id) {
                        const me = lobby.players.find(p => p.sid === socket.id);
                        if (me) {
                            currentPlayer = me;
                        }
                    }
                } catch (e) {}
                // Если статус waiting — показываем комнату ожидания, если playing — игровое поле
                if (lobby.status === 'waiting') {
                    showLobbyRoom();
                } else if (lobby.status === 'playing') {
                    showGameBoard();
                } else {
                    showLobbyList();
                }
            });
        // Показать экран ожидания лобби
    function showLobbyRoom() {
            // Плавный переход к комнате лобби
            document.getElementById('gameBoard').style.display = 'none';
            document.getElementById('lobbySection').style.display = 'none';
            const sidebar = document.querySelector('.app-sidebar'); if (sidebar) sidebar.style.display = 'none';

            const lobbyRoom = document.getElementById('lobbyRoom');
            lobbyRoom.style.display = 'block';
            lobbyRoom.classList.add('fade-enter-active');

            renderLobbyRoom();
        }

        function renderPlayers() {
            if (!currentLobby || !currentLobby.players) return;

            const playersContainer = document.getElementById('playersDisplay');
            playersContainer.innerHTML = '';

            currentLobby.players.forEach(player => {
                const playerEl = document.createElement('div');
                playerEl.className = `player-display ${player.symbol === currentLobby.current_player ? 'active' : ''}`;
                playerEl.innerHTML = `
                    <img src="${player.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(player.name)}&background=5865f2&color=ffffff&size=128`}" alt="${player.name}" class="player-display-avatar-img" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(player.name)}&background=5865f2&color=ffffff&size=128';">
                    <div class="player-display-info">
                        <p class="player-display-name">${player.name}</p>
                        <p class="player-display-symbol">Игрок ${player.symbol}</p>
                    </div>
                `;
                playersContainer.appendChild(playerEl);
            });

            // Добавляем разделитель между игроками
            if (currentLobby.players.length === 2) {
                const divider = document.createElement('div');
                divider.className = 'vs-divider';
                divider.innerHTML = 'VS';
                playersContainer.appendChild(divider);
            }
        }

    function renderLobbyRoom() {
            if (!currentLobby) return;

            // Список игроков
            const list = document.getElementById('lobbyPlayersList');
            list.innerHTML = '';

            currentLobby.players.forEach((p, idx) => {
                const div = document.createElement('div');
                div.className = 'lobby-player';
                div.innerHTML = `
                    <img src="${p.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}&background=5865f2&color=ffffff&size=96`}" alt="${p.name}" class="lobby-player-avatar-img" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}&background=5865f2&color=ffffff&size=96';">
                    <div class="lobby-player-info">
                        <h3>${p.name} ${idx === 0 ? '<span style="color: var(--discord-primary); font-size: 0.85em;">(создатель)</span>' : ''}</h3>
                        <span class="symbol">Игрок ${p.symbol}</span>
                    </div>
                `;
                list.appendChild(div);
            });

            // Пустые места для второго игрока
            for (let i = currentLobby.players.length; i < 2; i++) {
                const div = document.createElement('div');
                div.className = 'lobby-player';
                div.innerHTML = `
                    <div class="lobby-player-avatar" style="background: var(--text-muted);">?</div>
                    <div class="lobby-player-info">
                        <h3 style="color: var(--text-muted); font-style: italic;">Ожидание игрока</h3>
                        <span class="symbol" style="color: var(--text-muted);">Свободно</span>
                    </div>
                `;
                list.appendChild(div);
            }

      // Кнопки управления
      const btns = document.getElementById('lobbyRoomBtns');
      btns.innerHTML = '';

      let isOwner = false;
      if (currentLobby && currentPlayer && currentLobby.players && currentLobby.players.length > 0) {
        isOwner = currentLobby.players[0].user_id === currentPlayer.user_id;
      }

      // Делегируем клики — для динамически созданных кнопок это надёжнее
      btns.addEventListener('click', function(e) {
        const btn = e.target.closest('button');
        if (!btn) return;
        if (btn.dataset.action === 'start') {
          startGame();
        } else if (btn.dataset.action === 'dissolve') {
          dissolveLobby();
        } else if (btn.dataset.action === 'leave') {
          leaveLobby();
        }
      });

      if (isOwner) {
        if (currentLobby.players.length === 2) {
          const startBtn = document.createElement('button');
          startBtn.className = 'game-btn primary';
          startBtn.dataset.action = 'start';
          startBtn.innerHTML = '<i class="fas fa-play-circle"></i> Начать игру';
          btns.appendChild(startBtn);
        }
        const closeBtn = document.createElement('button');
        closeBtn.className = 'game-btn danger';
        closeBtn.dataset.action = 'dissolve';
        closeBtn.innerHTML = '<i class="fas fa-times"></i> Закрыть лобби';
        btns.appendChild(closeBtn);
      } else {
        const leaveBtn = document.createElement('button');
        leaveBtn.className = 'game-btn secondary';
        leaveBtn.dataset.action = 'leave';
        leaveBtn.innerHTML = '<i class="fas fa-arrow-left"></i> Покинуть лобби';
        btns.appendChild(leaveBtn);
      }
        }

        function startGame() {
            if (currentLobby) {
                socket.emit('start_game', { lobby_id: currentLobby.id });
            }
        }

    function dissolveLobby() {
      if (currentLobby && socket) {
        socket.emit('dissolve_lobby', { lobby_id: currentLobby.id });

        currentLobby = null;
        currentPlayer = null;

        showLobbyList();
      } else {
        // unable to dissolve lobby: missing state or connection
      }
    }

    // Обработчик ответа сервера на dissolve_lobby
    socket.on('lobby_dissolved', (data) => {
      // Сбрасываем состояние для всех игроков
      currentLobby = null;
      currentPlayer = null;
      showLobbyList();
    });

        function startGame() {
            if (currentLobby && socket) {
                socket.emit('start_game', { lobby_id: currentLobby.id });
            }
        }

            socket.on('lobbies_list', (lobbies) => {
                renderLobbyList(lobbies);
            });

            // Когда бек вернул профиль из Telegram (включая ссылку на фото)
            socket.on('telegram_profile', (profile) => {
                try {
                    if (profile && profile.name) playerName = profile.name;
                    if (profile && profile.avatar) playerAvatar = profile.avatar;
                    if (profile && profile.user_id) webUserId = profile.user_id;
                    // Update UI with new profile
                    updateProfileUI();
                    // Сохраняем профиль в localStorage
                    localStorage.setItem('tic_profile', JSON.stringify({ user_id: webUserId, name: playerName, avatar: playerAvatar }));
                    // если уже в лобби — обновим
                    if (currentLobby) {
                        socket.emit('get_lobbies');
                    }
                    // Убираем оверлей авторизации
                    hideAuthOverlay();
                } catch (e) { }
            });

      socket.on('error', (data) => {
        // server error
      });
        }

    function setupEventListeners() {
            // Основные кнопки меню
            document.getElementById('createLobbyBtn').addEventListener('click', createLobby);
            document.getElementById('refreshProfileBtn').addEventListener('click', refreshProfile);
            document.getElementById('authorizeBtn').addEventListener('click', authorizeWithBot);
            // Кнопка авторизации в оверле — на всякий случай привяжем обработчик
      try {
        const authBtnOverlay = document.getElementById('authActionBtn');
        if (authBtnOverlay) {
          authBtnOverlay.addEventListener('click', authorizeWithBot);
        }
      } catch (e) { /* ignore */ }

            // Кнопки игрового поля
            document.getElementById('leaveGameBtn').addEventListener('click', leaveLobby);
            document.getElementById('newGameBtn').addEventListener('click', resetGame);

            // Обработка кликов по игровым клеткам
            document.querySelectorAll('.game-cell').forEach((cell, index) => {
                cell.addEventListener('click', () => makeMove(index));
                cell.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('taken')) {
                        this.style.transform = 'scale(1.05)';
                    }
                });
                cell.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('taken')) {
                        this.style.transform = '';
                    }
                });
            });

            // Добавляем обработчик для Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('winModal');
                    if (modal.style.display === 'flex') {
                        hideWinModal();
                    }
                }
            });
        }

        async function authorizeWithBot() {
      // Проверяем socket
            if (!socket) {
                showToast('error','Socket не инициализирован. Подождите и попробуйте снова.');
        return;
      }
            if (!socket.id) {
                showToast('warn','Socket не имеет ID (ещё не подключён). Подождите и попробуйте снова.');
        return;
      }
      // Запрашиваем у бекенда уникальный код для авторизации
      try {
        const body = { sid: socket.id };
                const resp = await fetch('/auth_code', { method: 'POST', body: JSON.stringify(body), headers: { 'Content-Type': 'application/json' } });
                const data = await resp.json();
                if (data && data.code) {
                    const code = data.code;
                    // Сохраняем временно код (для отладки)
                    // Код авторизации получен

                    // Формируем deeplink на бота с payload auth:<code>
                    const botUsername = 'hesusinsidemegabot';
                    const link = `https://t.me/${botUsername}?start=auth:${encodeURIComponent(code)}`;

                    // Показываем код и инструкцию для ручной авторизации
                    document.getElementById('authStatus').innerHTML =
                        `<b>1.</b> <a href="${link}" target="_blank" style="color:#5865f2;">Откройте бота в Telegram</a><br>` +
                        `<b>2.</b> Если бот не авторизует автоматически, <b>нажмите на команду ниже</b> чтобы скопировать её, и отправьте боту:<br>` +
                        `<div id="copyAuthCode" style="margin:8px 0;padding:6px 10px;background:#40444b;border:1px solid #202225;border-radius:8px;font-size:1.08em;word-break:break-all;cursor:pointer;user-select:all;transition:background 0.2s;color:#dcddde;">/start auth:${code}</div>` +
                        `<span id="copyHint" style="display:none;color:#5865f2;font-size:0.97em;">Скопировано!</span>` +
                        `<span style="color:#b9bbbe;font-size:0.98em;display:block;margin-top:4px;">После этого вернитесь в Mini‑App — авторизация завершится автоматически.</span>`;
                    // Добавляем обработчик для копирования
                    setTimeout(() => {
                        const copyDiv = document.getElementById('copyAuthCode');
                        if (copyDiv) {
                            copyDiv.onclick = function() {
                                const text = copyDiv.textContent;
                                if (navigator.clipboard) {
                                    navigator.clipboard.writeText(text);
                                } else {
                                    // fallback для старых браузеров
                                    const textarea = document.createElement('textarea');
                                    textarea.value = text;
                                    document.body.appendChild(textarea);
                                    textarea.select();
                                    document.execCommand('copy');
                                    document.body.removeChild(textarea);
                                }
                                const hint = document.getElementById('copyHint');
                                if (hint) {
                                    hint.style.display = 'inline';
                                    setTimeout(()=>{hint.style.display='none';}, 1200);
                                }
                                copyDiv.style.background = '#5865f2';
                                setTimeout(()=>{copyDiv.style.background='#40444b';}, 600);
                            };
                        }
                    }, 100);
                } else {
                    showToast('error','Не удалось получить код авторизации. Попробуйте позже.');
                }
            } catch (e) {
        showToast('error','Ошибка запроса к серверу.');
            }
        }

        // Unified auth overlay controls (single implementation)
        function showAuthOverlay() {
            const ov = document.getElementById('authOverlay');
            const main = document.getElementById('mainContainer');
            if (main) {
                main.style.display = 'none';
                main.style.pointerEvents = 'none';
            }
            if (ov) {
                ov.style.display = 'flex';
                ov.style.opacity = '1';
            }
            // bind default action
            const authBtn = document.getElementById('authActionBtn');
            if (authBtn) authBtn.onclick = authorizeWithBot;
        }

        function hideAuthOverlay() {
            const ov = document.getElementById('authOverlay');
            const main = document.getElementById('mainContainer');
            if (ov) ov.style.display = 'none';
            if (main) {
                main.style.display = 'block';
                main.style.pointerEvents = '';
                main.style.filter = '';
            }
        }

    function createLobby() {
      if (socket) {
        const name = 'Лобби';
        socket.emit('create_lobby', { name: name, player_name: playerName, player_avatar: playerAvatar, user_id: webUserId });
      } else {
        // socket not connected
      }
    }

        function refreshProfile() {
            if (window.Telegram && window.Telegram.WebApp && socket) {
                const tg = window.Telegram.WebApp;
                const user = (tg.initDataUnsafe && tg.initDataUnsafe.user) || null;
                if (user && user.id) {
                    webUserId = user.id;
                    playerName = user.first_name || user.username || 'Гость';
                    // Telegram WebApp does not always expose avatar URL — keep empty if not present
                    playerAvatar = user.photo_url || '';
                    updateProfileUI();
                    socket.emit('identify', { user_id: user.id, name: playerName, avatar: playerAvatar });
                }
            }
        }

    function joinLobby(lobbyId) {
      if (socket) {
        socket.emit('join_lobby', { lobby_id: lobbyId, player_name: playerName, player_avatar: playerAvatar, user_id: webUserId });
        // показываем UI сразу — сервер пришлёт update_lobby чтобы синхронизировать
        showGameBoard();
      } else {
        // socket not connected
      }
    }

        function leaveLobby() {
            if (currentLobby && socket) {
                socket.emit('leave_lobby', { lobby_id: currentLobby.id });
                currentLobby = null;
                currentPlayer = null;
                showLobbyList();
            }
        }

        function makeMove(position) {
            if (currentLobby && currentPlayer && currentLobby.current_player === currentPlayer.symbol && socket) {
                socket.emit('make_move', { lobby_id: currentLobby.id, position: position });
            }
        }

        function resetGame() {
            // Сброс игры - можно добавить логику
            if (currentLobby) {
                currentLobby.board = ['', '', '', '', '', '', '', '', ''];
                currentLobby.status = 'playing';
                currentLobby.current_player = 'X';
                // Убираем анимацию победы со всех клеток
                document.querySelectorAll('.game-cell').forEach(cell => {
                    cell.classList.remove('win');
                });
                updateGameDisplay();
            }
        }

        function getLobbies() {
            if (socket) {
                socket.emit('get_lobbies');
            }
        }

        function renderLobbyList(lobbies) {
            const lobbyList = document.getElementById('lobbyList');
            lobbyList.innerHTML = '';

            if (lobbies.length === 0) {
                lobbyList.innerHTML = `
                    <div style="text-align: center; color: var(--text-muted); padding: 40px 20px;">
                        <i class="fas fa-gamepad" style="font-size: 3rem; margin-bottom: 16px; opacity: 0.5;"></i>
                        <p style="margin: 0; font-size: 1.1rem;">Нет активных игр</p>
                        <p style="margin: 8px 0 0 0; font-size: 0.9rem;">Создайте новую игру, чтобы начать!</p>
                    </div>
                `;
                return;
            }

            lobbies.forEach(lobby => {
                const lobbyCard = document.createElement('div');
                lobbyCard.className = 'lobby-card';
                lobbyCard.innerHTML = `
                    <div class="lobby-header">
                        <h3 class="lobby-name">${lobby.name}</h3>
                        <span class="lobby-status ${lobby.status}">${getStatusText(lobby.status)}</span>
                    </div>
                    <div class="lobby-players">
                        ${lobby.players.map(p => `
                            <div class="player-info">
                                <img src="${p.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}&background=5865f2&color=ffffff&size=64`}" alt="${p.name}" class="player-avatar-img" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}&background=5865f2&color=ffffff&size=64';">
                                <div class="player-details">
                                    <div class="player-name">${p.name}</div>
                                    <div class="player-symbol">Игрок ${p.symbol}</div>
                                </div>
                            </div>
                        `).join('')}
                        ${lobby.players.length < 2 ? '<div class="empty-slot">Свободно</div>' : ''}
                    </div>
                    <div class="lobby-actions">
                        <button class="action-btn join-btn" data-id="${lobby.id}">
                            <i class="fas fa-plus"></i> Присоединиться
                        </button>
                        <button class="action-btn info-btn" data-id="${lobby.id}">
                            <i class="fas fa-info-circle"></i> Инфо
                        </button>
                    </div>
                `;

                lobbyList.appendChild(lobbyCard);
            });

            // Обработчики событий
            document.querySelectorAll('.join-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const lobbyId = this.getAttribute('data-id');
                    joinLobby(lobbyId);
                });
            });

            document.querySelectorAll('.info-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const lobbyId = this.getAttribute('data-id');
                    const lobby = lobbies.find(l => l.id === lobbyId);
                    if (lobby) {
                        showLobbyInfo(lobby);
                    }
                });
            });
        }

        function showLobbyInfo(lobby) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-icon">ℹ️</div>
                    <h2 class="modal-title">Информация о лобби</h2>
                    <p class="modal-description">
                        <strong>Название:</strong> ${lobby.name}<br>
                        <strong>Игроки:</strong> ${lobby.players.map(p => p.name + ' (' + p.symbol + ')').join(', ')}<br>
                        <strong>Статус:</strong> ${getStatusText(lobby.status)}<br>
                        <strong>Создано:</strong> Только что
                    </p>
                    <div class="modal-buttons">
                        <button class="game-btn primary" onclick="this.closest('.modal-overlay').remove()">Понятно</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Закрытие по клику вне модалки
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function getStatusText(status) {
            switch(status) {
                case 'waiting': return 'Ожидание игрока';
                case 'playing': return 'Игра идет';
                case 'finished': return 'Игра завершена';
                default: return status;
            }
        }

        // Улучшенная функция обновления статуса игры
        function updateGameStatus() {
            if (!currentLobby) return;

            const statusText = document.getElementById('gameStatusText');
            const statusIndicator = document.getElementById('gameStatusIndicator');
            const currentPlayerAvatar = document.getElementById('currentPlayerAvatar');
            const currentPlayerName = document.getElementById('currentPlayerName');

            switch(currentLobby.status) {
                case 'playing':
                    if (currentPlayer && currentLobby.players) {
                        const currentPlayerObj = currentLobby.players.find(p => p.symbol === currentLobby.current_player);
                        if (currentPlayerObj) {
                            currentPlayerAvatar.src = currentPlayerObj.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentPlayerObj.name)}&background=5865f2&color=ffffff&size=64`;
                            currentPlayerName.textContent = currentPlayerObj.name;
                        }
                        const isMyTurn = currentLobby.current_player === currentPlayer.symbol;
                        statusText.textContent = isMyTurn ? 'Ваш ход' : 'Ход соперника';
                        statusIndicator.className = `game-status-indicator ${isMyTurn ? 'your-turn' : 'waiting'}`;
                    }
                    break;
                case 'waiting':
                    statusText.textContent = 'Ожидание игрока';
                    currentPlayerName.textContent = 'Ожидание второго игрока';
                    currentPlayerAvatar.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiM3MjY3N2QiLz4KPHBhdGggZD0iTTE2IDE2QzE4LjIxIDE2IDIwIDE0LjIxIDIwIDEyQzIwIDEwLjc5IDE4LjIxIDkgMTYgOUMxMy43OSA5IDEyIDEwLjc5IDEyIDEyQzEyIDE0LjIxIDEzLjc5IDE2IDE2Wk0xNiAyMEMxOS4zMTggMjAgMjIgMTguMzE4IDIyIDE2QzIyIDEzLjY4MiAxOS4zMTggMTEgMTYgMTFDMTIuNjgyIDExIDEwIDEzLjY4MiAxMCAxNkMxMCAxOC4zMTggMTIuNjgyIDIwIDE2IDIwWk0xNiAyNEMyMS41ODIgMjQgMjYgMTkuNTgyIDI2IDE0QzI2IDguNDE4IDIxLjU4MiA0IDE2IDRDMTAuNDE4IDQgNiA4LjQxOCA2IDE0QzYgMTkuNTgyIDEwLjQxOCAyNCAxNiAyNFoiIGZpbGw9IiNkY2RkZGUiLz4KPC9zdmc+';
                    statusIndicator.className = 'game-status-indicator waiting';
                    break;
                case 'finished':
                    statusText.textContent = 'Игра завершена';
                    if (currentLobby.winner === 'draw') {
                        currentPlayerName.textContent = 'Ничья!';
                        currentPlayerAvatar.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiNmZWU3NWMiLz4KPHBhdGggZD0iTTggMTJMMTEgMTVMMTYgMTBNMjEgMTJMMjQgMTVMMjEgMThMMTEgMTVMMjQgMTJMMjEgOUwxNiA2TDExIDlMMTEgMTJMMTEgMTVMMTEgMThMMTEgMjFMMTEgMjRMMTEgMjdsLTMgMyIvPgo8L3N2Zz4=';
                    } else {
                        const winner = currentLobby.players.find(p => p.symbol === currentLobby.winner);
                        if (winner) {
                            currentPlayerAvatar.src = winner.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(winner.name)}&background=5865f2&color=ffffff&size=64`;
                            currentPlayerName.textContent = `Победил ${winner.name}!`;
                        }
                    }
                    statusIndicator.className = 'game-status-indicator';
                    break;
            }
        }

        // Добавляем плавные переходы между экранами
        function switchToScreen(screenId) {
            // Убираем активные экраны
            document.querySelectorAll('.app-main > .section').forEach(div => {
                if (div.id !== screenId && div.style.display !== 'none') {
                    div.classList.remove('fade-enter-active');
                    div.classList.add('fade-exit');
                }
            });

            // Показываем целевой экран
            setTimeout(() => {
                const targetScreen = document.getElementById(screenId);
                targetScreen.style.display = 'block';
                targetScreen.classList.add('fade-enter-active');
            }, 150);
        }

        function showGameBoard() {
            // Плавный переход к игровому полю
            document.getElementById('lobbySection').style.display = 'none';
            const sidebar2 = document.querySelector('.app-sidebar'); if (sidebar2) sidebar2.style.display = 'none';
            document.getElementById('lobbyRoom').style.display = 'none';

            const gameBoard = document.getElementById('gameBoard');
            gameBoard.style.display = 'block';
            gameBoard.classList.add('fade-enter-active');

            updateGameDisplay();
        }

        function showLobbyList() {
            // Плавный переход к списку лобби
            document.getElementById('gameBoard').style.display = 'none';
            document.getElementById('lobbyRoom').style.display = 'none';

            const lobbySection = document.getElementById('lobbySection');
            const sidebar3 = document.querySelector('.app-sidebar'); if (sidebar3) sidebar3.style.display = 'flex';
            lobbySection.style.display = 'block';
            lobbySection.classList.add('fade-enter-active');

            getLobbies();
        }


        function updateGameDisplay() {
            if (!currentLobby) return;

            // Обновляем игровое поле
            currentLobby.board.forEach((cell, index) => {
                const cellElement = document.querySelector(`[data-index="${index}"]`);
                cellElement.textContent = cell;
                cellElement.className = 'game-cell';
                if (cell) {
                    cellElement.classList.add(cell.toLowerCase());
                    cellElement.classList.add('taken');
                }
            });

            // Рендерим игроков и статус
            renderPlayers();

            const statusIndicator = document.getElementById('gameStatusIndicator');
            const statusText = document.querySelector('.game-status-text');
            const currentPlayerAvatar = document.getElementById('currentPlayerAvatar');
            const currentPlayerName = document.getElementById('currentPlayerName');

            if (currentPlayer && currentLobby.players) {
                const currentPlayerObj = currentLobby.players.find(p => p.symbol === currentLobby.current_player);
                if (currentPlayerObj) {
                    currentPlayerAvatar.src = currentPlayerObj.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentPlayerObj.name)}&background=5865f2&color=ffffff&size=64`;
                    currentPlayerName.textContent = currentPlayerObj.name;
                }

                const isMyTurn = currentLobby.status === 'playing' && currentLobby.current_player === currentPlayer.symbol;
                statusText.textContent = isMyTurn ? 'Ваш ход' : 'Ход соперника';
                statusIndicator.className = `game-status-indicator ${isMyTurn ? 'your-turn' : 'waiting'}`;
            }

            // Обработка завершения игры
            if (currentLobby.status === 'finished') {
                setTimeout(() => {
                    highlightWinningCells();
                    showGameResult();
                }, 200);
            }
        }

        function showGameResult() {
            if (!currentLobby) return;

            let winnerName = '';
            let isDraw = false;
            let icon = '🎉';

            if (currentLobby.winner === 'draw') {
                winnerName = 'Ничья!';
                isDraw = true;
                icon = '🤝';
            } else {
                const winner = currentLobby.players.find(p => p.symbol === currentLobby.winner);
                winnerName = winner ? `Победил ${winner.name}!` : `Победил ${currentLobby.winner}!`;
                icon = '🎉';
            }

            showWinModal(winnerName, isDraw, icon);
        }

    // Улучшенная обработка кликов по клеткам
    // (реализация выше в файле используется; здесь оставляем корректное поведение без debug)
    function makeMove(position) {
      if (currentLobby && currentPlayer && currentLobby.current_player === currentPlayer.symbol && socket) {
        socket.emit('make_move', { lobby_id: currentLobby.id, position: position });
      } else {
        // cannot make move
      }
    }
        // Улучшенное модальное окно победы
        function showWinModal(winnerText, isDraw, icon = '🎉') {
            const modal = document.getElementById('winModal');
            const modalIcon = document.getElementById('winModalAnim');
            const modalTitle = document.getElementById('winModalText');
            const modalDescription = document.querySelector('#winModal .modal-description');
            const modalBtns = document.getElementById('winModalBtns');

            modal.style.display = 'flex';
            modalIcon.textContent = icon;
            modalTitle.textContent = winnerText;
            modalDescription.textContent = isDraw ? 'Отличная игра! Никто не победил.' : 'Поздравляем с победой!';

            modalBtns.innerHTML = '';

            let isOwner = false;
            if (currentLobby && currentPlayer && currentLobby.players && currentLobby.players.length > 0) {
                isOwner = currentLobby.players[0].user_id === currentPlayer.user_id;
            }

            if (isOwner) {
                modalBtns.innerHTML = `
                    <button class="game-btn danger" onclick="hideWinModal(); leaveLobby();">
                        <i class="fas fa-times-circle"></i>
                        Завершить
                    </button>
                    <button class="game-btn primary" onclick="hideWinModal(); resetGame();">
                        <i class="fas fa-redo-alt"></i>
                        Играть снова
                    </button>
                `;
            } else {
                modalBtns.innerHTML = `
                    <button class="game-btn primary" onclick="hideWinModal(); leaveLobby();">
                        <i class="fas fa-check-circle"></i>
                        Понятно
                    </button>
                `;
            }
        }

        function hideWinModal() {
            const modal = document.getElementById('winModal');
            modal.style.display = 'none';
        }

        // Улучшенная функция авторизации
        function showAuthOverlay() {
            const overlay = document.getElementById('authOverlay');
            const mainContent = document.querySelector('.app-container');

            mainContent.style.filter = 'blur(4px)';
            mainContent.style.pointerEvents = 'none';
            overlay.style.display = 'flex';

            // Добавляем анимацию появления
            setTimeout(() => {
                overlay.style.opacity = '1';
            }, 10);
        }

        function hideAuthOverlay() {
            const overlay = document.getElementById('authOverlay');
            const mainContent = document.querySelector('.app-container');

            mainContent.style.filter = '';
            mainContent.style.pointerEvents = '';
            overlay.style.display = 'none';
        }

        // Улучшенная функция выделения победных клеток
        function highlightWinningCells() {
            if (!currentLobby || currentLobby.status !== 'finished') return;

            const board = currentLobby.board;
            const currentSymbol = currentLobby.winner;

            if (!currentSymbol || currentSymbol === 'draw') return;

            // Определяем победные комбинации
            const winningConditions = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
                [0, 4, 8], [2, 4, 6] // Diagonals
            ];

            // Находим и выделяем победную комбинацию
            winningConditions.forEach((condition, comboIndex) => {
                const [a, b, c] = condition;
                if (board[a] === currentSymbol && board[b] === currentSymbol && board[c] === currentSymbol) {
                    // Выделяем победные клетки с небольшой задержкой для эффекта
                    setTimeout(() => {
                        document.querySelector(`[data-index="${a}"]`).classList.add('win');
                    }, comboIndex * 100);

                    setTimeout(() => {
                        document.querySelector(`[data-index="${b}"]`).classList.add('win');
                    }, comboIndex * 100 + 50);

                    setTimeout(() => {
                        document.querySelector(`[data-index="${c}"]`).classList.add('win');
                    }, comboIndex * 100 + 100);
                }
            });
        }

        // Улучшенная функция сброса игры
        function resetGame() {
            if (currentLobby) {
                // Убираем выделение победных клеток с анимацией
                const winningCells = document.querySelectorAll('.game-cell.win');
                winningCells.forEach((cell, index) => {
                    setTimeout(() => {
                        cell.classList.remove('win');
                    }, index * 50);
                });

                // Сброс игрового состояния
                setTimeout(() => {
                    currentLobby.board = ['', '', '', '', '', '', '', '', ''];
                    currentLobby.status = 'playing';
                    currentLobby.current_player = 'X';
                    updateGameDisplay();
                }, 300);
            }
        }

            // Безопасная вставка текста в HTML
            function escapeHTML(s) {
                return String(s).replace(/[&<>"']/g, function (c) {
                    return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c];
                });
            }

            // Обновляет UI профиля в сайдбаре (аватар + имя + подсказка)
            function updateProfileUI() {
                try {
                    const nameEl = document.getElementById('profileName');
                    const subEl = document.getElementById('profileSub');
                    const avatarImg = document.getElementById('profileAvatarImg');
                    if (nameEl) nameEl.textContent = playerName || 'Гость';
                    if (subEl) subEl.textContent = webUserId ? 'Авторизован' : 'Не авторизован';
                    if (avatarImg) {
                        if (playerAvatar) {
                            avatarImg.src = playerAvatar;
                            avatarImg.style.display = 'block';
                        } else {
                            // fallback: генерируем UI-avatars URL
                            avatarImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(playerName || 'Гость')}&background=5865f2&color=ffffff&size=128`;
                            avatarImg.style.display = 'block';
                        }
                    }
                } catch (e) { /* ignore UI update errors */ }
            }

            // Обновлённый рендер статуса/игроков
            function renderStatusAndPlayers(lobby) {
                const statusEl = document.getElementById('statusMessage');
                if (!lobby || !lobby.players) { statusEl.innerHTML = ''; return; }

                const playersHtml = lobby.players.map(p => {
                    const avatar = p.avatar ? escapeHTML(p.avatar) : `https://ui-avatars.com/api/?name=${encodeURIComponent(escapeHTML(p.name))}`;
                    // Если ник длиннее 10 символов — добавляем класс marquee
                    const isLong = p.name && p.name.length > 10;
                    return `
                        <div class="player-small">
                            <img src="${avatar}" alt="avatar">
                            <div style="display:flex;flex-direction:column;">
                                <span class="name${isLong ? ' marquee' : ''}">${escapeHTML(p.name)}</span>
                                <span class="symbol">(${escapeHTML(p.symbol)})</span>
                            </div>
                        </div>
                    `;
                }).join('<span class="vs-sep">vs</span>');

                let statusText = '';
                if (lobby.status === 'playing') statusText = `Игра идет | Ход ${escapeHTML(lobby.current_player)}`;
                else if (lobby.status === 'waiting') statusText = 'Ожидание игрока';
                else if (lobby.status === 'finished') statusText = lobby.winner === 'draw' ? 'Ничья' : `Победил ${escapeHTML(lobby.winner)}`;

                statusEl.innerHTML = `<div class="players-row">${playersHtml}</div><div class="status-line">${statusText}</div>`;
            }

            // Toast helper
            function showToast(type, message, timeout = 4200) {
                try {
                    const wrap = document.getElementById('toastWrap');
                    if (!wrap) return;
                    const t = document.createElement('div');
                    t.className = `toast ${type || 'info'}`;
                    t.textContent = message;
                    wrap.appendChild(t);
                    // appear
                    requestAnimationFrame(()=>{ t.classList.remove('hide'); });
                    if (timeout > 0) setTimeout(()=>{ hideToast(t); }, timeout);
                } catch (e) { console.warn('toast', e); }
            }

            function hideToast(el) {
                try {
                    el.classList.add('hide');
                    setTimeout(()=>{ el.remove(); }, 260);
                } catch(e){}
            }
    </script>
</body>
</html>