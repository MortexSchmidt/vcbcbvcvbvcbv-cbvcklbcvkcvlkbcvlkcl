<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Dark, human-made flat UI ‚Äî no gradients, readable, comfortable */
        :root{
            --bg: #0b0f14;          /* page background - very dark */
            --card: #0f1720;        /* cards and panels */
            --muted: #98a0b3;       /* secondary text (lighter for dark bg) */
            --text: #e6eef8;        /* primary text */
            --accent: #6c8cff;      /* accent color */
            --success: #22c55e;
            --danger: #ff6b6b;
            --glass: rgba(255,255,255,0.03);
            --shadow-1: 0 8px 28px rgba(2,6,23,0.6);
            --radius: 12px;
            --radius-sm: 8px;
            --gap: 14px;
            --transition: 180ms cubic-bezier(.2,.9,.2,1);
        }

        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            margin:0;
            font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            background:var(--bg);
            color:var(--text);
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            display:flex;
            align-items:center;
            justify-content:center;
            padding:22px;
        }

        .app-container{
            width:100%;
            max-width:920px;
            border-radius:16px;
            overflow:hidden;
            box-shadow:var(--shadow-1);
            background:var(--card);
            display:grid;
            grid-template-columns: 320px 1fr;
            gap:22px;
        }

        /* Sidebar */
        .app-sidebar{
            padding:18px;
            background:transparent;
            border-right:1px solid rgba(255,255,255,0.03);
            display:flex;
            flex-direction:column;
            gap:12px;
        }

    .app-header{display:flex;align-items:center;gap:12px}
    .app-title{
      margin:0;font-weight:700;font-size:1.25rem;display:flex;align-items:center;gap:12px;color:var(--text)
    }
    .app-title i{color:var(--accent);font-size:1.4rem}

    .profile-row{display:flex;align-items:center;gap:12px}
    .avatar{
            width:56px;height:56px;max-width:56px;max-height:56px;border-radius:12px;flex:0 0 56px;overflow:hidden;background:var(--glass);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--card);
    }
    .avatar img{width:100%;height:100%;object-fit:cover}
        /* Normalize other avatar images across UI */
        .player-display-avatar-img, .lobby-player-avatar-img, .player-avatar-img, .player-display img {
            width:48px;height:48px;border-radius:8px;object-fit:cover;display:block;flex-shrink:0;
        }

    .profile-info{display:flex;flex-direction:column}
    .profile-name{font-weight:600}
    .profile-sub{font-size:0.9rem;color:var(--muted)}

    .menu-buttons{display:flex;flex-direction:column;gap:10px;margin-top:6px}
    /* Menu buttons: allow wrapping, prevent icon wrap, consistent min height */
    .menu-btn{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);cursor:pointer;transition:all var(--transition);font-weight:600;white-space:normal;word-break:break-word;text-align:left;min-height:48px;line-height:1.15;overflow-wrap:anywhere}
    .menu-btn i{width:28px;text-align:center;color:var(--accent);flex-shrink:0;flex-basis:28px}
    .menu-btn.primary{background:var(--accent);color:#07102a;border:0}
    .menu-btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(2,6,23,0.55)}

    /* Main area */
    .app-main{padding:22px;display:flex;flex-direction:column;gap:18px;background:transparent}
    /* Sections keep the card background to ensure consistent dark surfaces */
    .section{background:var(--card);border-radius:12px;padding:16px;border:1px solid var(--glass)}
    .section-title{display:flex;align-items:center;gap:10px;font-weight:700;color:var(--text);margin:0 0 8px 0}
    .section-title i{color:var(--accent)}

    .lobby-grid{display:flex;flex-direction:column;gap:12px}
    .lobby-card{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent}
    .lobby-meta{display:flex;align-items:center;gap:12px}
    .lobby-name{font-weight:600}
    .lobby-players{display:flex;gap:8px;align-items:center}
    .player-small{width:36px;height:36px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent)}

    .lobby-actions{display:flex;gap:8px}
    .action-btn{padding:8px 12px;border-radius:10px;border:1px solid var(--glass);background:transparent;cursor:pointer;font-weight:600;min-height:40px;line-height:1.05}
    .action-btn.primary{background:var(--accent);color:#07102a;border:0}
    .action-btn.ghost{background:transparent;color:var(--muted)}

    /* Board */
    .game-board{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:10px}
    .game-cell{aspect-ratio:1;border-radius:12px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;font-size:2.1rem;font-weight:800;color:var(--text);cursor:pointer;border:1px solid rgba(255,255,255,0.03);transition:transform var(--transition),box-shadow var(--transition);padding:4px}
    .game-cell:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,0.5)}
    .game-cell.taken{opacity:0.9;cursor:default}

    .game-controls{display:flex;gap:10px;justify-content:center}
    .game-btn{padding:10px 14px;border-radius:10px;border:1px solid var(--glass);background:transparent;cursor:pointer;font-weight:700;min-height:44px;line-height:1.05}
    .game-btn.primary{background:var(--accent);color:#07102a;border:0}
    .game-btn.danger{background:transparent;color:var(--danger);border:1px solid rgba(220,38,38,0.12)}

    /* Modal / overlay tweaks */
    .modal-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:60}
    .modal-content{width:420px;background:#0c1318;border-radius:12px;padding:20px;border:1px solid rgba(255,255,255,0.03);box-shadow:var(--shadow-1)}

    /* Auth overlay uses same modal style but centered */
    /* Auth overlay uses modal-like fullscreen styling to avoid white flashes */
    .auth-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:70}

    /* Responsive */
        @media (max-width:880px){
            .app-container{grid-template-columns:1fr;max-width:920px}
            .app-sidebar{order:2}
            .app-main{order:1}
            body{padding:18px}
        }

        /* Smaller devices: reduce button font-size to avoid clipping */
        @media (max-width:480px){
            .menu-btn{font-size:0.95rem;padding:10px;min-height:46px}
            .game-cell{font-size:1.45rem}
        }

    /* Small helpers */
    .muted{color:var(--muted);font-size:0.95rem}
    .center{display:flex;align-items:center;justify-content:center}
    /* Lobby layout helpers: place control buttons at bottom of lobby room */
    #lobbyRoom{display:flex;flex-direction:column;gap:12px;min-height:220px}
    #lobbyPlayersList{flex:1;overflow:auto}
    #lobbyRoomBtns{margin-top:auto;display:flex;gap:8px;flex-wrap:wrap}
    </style>
    <style>
    /* Toasts */
    .toast-wrap{position:fixed;right:18px;top:18px;display:flex;flex-direction:column;gap:8px;z-index:9999}
    .toast{min-width:220px;padding:10px 14px;border-radius:10px;color:#fff;font-weight:600;box-shadow:0 8px 22px rgba(8,12,20,0.12);transform-origin:right top;transition:transform 200ms ease,opacity 200ms ease}
    .toast.info{background:var(--accent)}
    .toast.success{background:var(--success)}
    .toast.warn{background:#ff8c00}
    .toast.error{background:var(--danger)}
    .toast{color:#07102a}
    .toast.hide{opacity:0;transform:translateX(12px) scale(.98)}
    </style>
</head>
<body>
    <div id="mainContainer" class="app-container">
        <aside class="app-sidebar">
            <div class="app-header">
                <i class="fas fa-chess-knight"></i>
                <h1 class="app-title">–ö—Ä–µ—Å—Ç–∏–∫–∏‚Äë–ù–æ–ª–∏–∫–∏</h1>
            </div>

            <div class="profile-row">
                <div class="avatar" id="profileAvatar">
                    <img id="profileAvatarImg" src="" alt="avatar" onerror="this.style.display='none'">
                </div>
                <div class="profile-info">
                    <div class="profile-name" id="profileName">–ì–æ—Å—Ç—å</div>
                    <div class="profile-sub muted" id="profileSub">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</div>
                </div>
            </div>
                <div class="toast-wrap" id="toastWrap" aria-live="polite"></div>

            <div class="menu-buttons">
                <button class="menu-btn primary" id="createLobbyBtn"><i class="fas fa-plus-circle"></i>–°–æ–∑–¥–∞—Ç—å –ª–æ–±–±–∏</button>
                <button class="menu-btn" id="refreshProfileBtn"><i class="fas fa-sync-alt"></i>–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                <button class="menu-btn" id="authorizeBtn"><i class="fab fa-telegram-plane"></i>–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</button>
            </div>

            <div class="section muted" style="margin-top:auto;font-size:0.92rem">–ò–≥—Ä–∞ –ª–æ–∫–∞–ª—å–Ω–∞—è ¬∑ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Telegram</div>
        </aside>

        <main class="app-main">
            <div class="section" id="lobbySection">
                <h3 class="section-title"><i class="fas fa-list"></i>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–≥—Ä—ã</h3>
                <div class="lobby-grid" id="lobbyList"> <!-- –õ–æ–±–±–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ --> </div>
            </div>

        <div class="section" id="lobbyRoom" style="display:none;">
                <h3 class="section-title"><i class="fas fa-users"></i>–ö–æ–º–Ω–∞—Ç–∞ –æ–∂–∏–¥–∞–Ω–∏—è</h3>
                <div id="lobbyPlayersList" style="display:flex;flex-direction:column;gap:10px"></div>
                <div id="lobbyRoomBtns" style="margin-top:12px;display:flex;gap:8px"></div>
            </div>

        <div class="section" id="gameBoard" style="display:none;">
                <h3 class="section-title"><i class="fas fa-gamepad"></i>–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ</h3>
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
                                <div style="display:flex;flex-direction:column;gap:6px">
                                    <div class="muted" id="gameStatusIndicator">–•–æ–¥ –∏–≥—Ä–æ–∫–∞</div>
                                    <div id="gameStatusText" class="muted" style="font-weight:600">–í–∞—à —Ö–æ–¥</div>
                                </div>
                    <div style="display:flex;align-items:center;gap:10px">
                        <div class="avatar" style="width:40px;height:40px;border-radius:10px;overflow:hidden"><img id="currentPlayerAvatar" src="" onerror="this.style.display='none'"/></div>
                        <div id="currentPlayerName" class="muted">–ò–≥—Ä–æ–∫</div>
                    </div>
                </div>

                <div class="game-board" id="boardGrid">
                    <div class="game-cell" data-index="0"></div>
                    <div class="game-cell" data-index="1"></div>
                    <div class="game-cell" data-index="2"></div>
                    <div class="game-cell" data-index="3"></div>
                    <div class="game-cell" data-index="4"></div>
                    <div class="game-cell" data-index="5"></div>
                    <div class="game-cell" data-index="6"></div>
                    <div class="game-cell" data-index="7"></div>
                    <div class="game-cell" data-index="8"></div>
                </div>

                <div class="game-controls" style="margin-top:14px">
                    <button class="game-btn" id="leaveGameBtn"><i class="fas fa-arrow-left"></i>–ü–æ–∫–∏–Ω—É—Ç—å</button>
                    <button class="game-btn primary" id="newGameBtn"><i class="fas fa-redo-alt"></i>–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
                </div>
            </div>
            <!-- players display (used by JS) -->
            <div id="playersDisplay" style="display:none"></div>

        </main>

    <!-- Win modal (kept for JS) -->
    <div id="winModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <div id="winModalAnim" class="modal-icon">üéâ</div>
            <h2 id="winModalText" class="modal-title">–ü–æ–±–µ–¥–∞!</h2>
            <p class="modal-description">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø–æ–±–µ–¥–æ–π –≤ –∏–≥—Ä–µ!</p>
            <div id="winModalBtns" class="modal-buttons"></div>
        </div>
    </div>
    </div>
            <!-- –û–≤–µ—Ä–ª–µ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
            <div id="authOverlay" class="auth-overlay" style="display:none;">
                <div class="auth-container section" style="width:420px;max-width:92%;">
                        <h2 class="section-title"><i class="fab fa-telegram-plane"></i>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
                        <p class="muted">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ª–∏—á–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ Telegram‚Äë–±–æ—Ç–∞, —á—Ç–æ–±—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å.</p>
                        <div style="height:12px"></div>
                        <button id="authActionBtn" class="menu-btn primary" style="width:100%;">
                            <i class="fab fa-telegram-plane"></i>
                            –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞
                        </button>
                        <div id="authStatus" class="muted" style="margin-top:12px">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...</div>
                    </div>
            </div>


        <noscript>
            <div style="padding:32px;text-align:center;color:#ff6b6b;font-size:1.2rem;">–î–ª—è —Ä–∞–±–æ—Ç—ã Mini‚ÄëApp —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–∫–ª—é—á–∏—Ç—å JavaScript.</div>
        </noscript>
        <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
        <script>

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let socket;
        let currentLobby = null;
        let currentPlayer = null;
        let playerName = '';
        let playerAvatar = '';
        let webUserId = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
            let savedProfile = null;
            try {
                savedProfile = JSON.parse(localStorage.getItem('tic_profile'));
            } catch (e) { savedProfile = null; }

            if (savedProfile && savedProfile.user_id) {
                // –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                webUserId = savedProfile.user_id;
                playerName = savedProfile.name || '–ò–≥—Ä–æ–∫';
                playerAvatar = savedProfile.avatar || '';
            updateProfileUI();
            startApp();
            } else if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready(); // –°–æ–æ–±—â–∞–µ–º Telegram, —á—Ç–æ Mini-App –≥–æ—Ç–æ–≤–∞
                tg.expand(); // –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ


                // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –∏ –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                setTimeout(() => {
                    const user = tg.initDataUnsafe?.user;
                    if (user && user.id) {
                        webUserId = user.id;
                        playerName = user.first_name || user.username || '–ò–≥—Ä–æ–∫';
                        playerAvatar = '';
                        updateProfileUI();
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –≤ localStorage
                        localStorage.setItem('tic_profile', JSON.stringify({ user_id: webUserId, name: playerName, avatar: playerAvatar }));
                        startApp();
                    } else {
                        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç
                        playerName = '–ì–æ—Å—Ç—å';
                        playerAvatar = '';
                        webUserId = null;
                        updateProfileUI();
                        startApp();
                    }
                }, 500);
            } else {
                // –ù–µ –≤ Telegram, –¥–µ—Ñ–æ–ª—Ç
                playerName = '–ì–æ—Å—Ç—å';
                playerAvatar = '';
                webUserId = null;
                startApp();
            }
        });

    function startApp() {
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
            socket = io();

            socket.on('connect', () => {
              // connection established
            });
            socket.on('connect_error', (err) => {
              // connection error
            });
            socket.on('disconnect', () => {
              // disconnected
            });

            // –ï—Å–ª–∏ –µ—Å—Ç—å user_id, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
            if (webUserId && socket) {
                socket.emit('identify', { user_id: webUserId, name: playerName, avatar: playerAvatar });
            }

            // –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–æ—Ñ–∏–ª—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            if (!webUserId) {
                showAuthOverlay();
                // Fallback: –µ—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –ø—Ä–∏–¥—ë—Ç –∑–∞ 10 —Å–µ–∫—É–Ω–¥ ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
                setTimeout(() => {
                    if (document.getElementById('mainContainer').style.display === 'none') {
                            showToast('error','–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
                            document.getElementById('authActionBtn').textContent = '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é';
                        }
                }, 10000);
            } else {
                hideAuthOverlay();
            }

            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏
            setupSocketListeners();
            setupEventListeners();
            getLobbies();
        }

        function setupSocketListeners() {
            socket.on('connect', () => {
            });

            socket.on('disconnect', () => {
            });


            socket.on('lobby_created', (data) => {
                currentLobby = data.lobby;
                currentPlayer = data.lobby.players[0];
                showLobbyRoom();
            });

            socket.on('update_lobby', (lobby) => {
                currentLobby = lobby;
                // –µ—Å–ª–∏ –≤ —Å–ø–∏—Å–∫–µ –∏–≥—Ä–æ–∫–æ–≤ –µ—Å—Ç—å –∑–∞–ø–∏—Å—å —Å –Ω–∞—à–∏–º sid ‚Äî –Ω–∞–∑–Ω–∞—á–∏–º currentPlayer
                try {
                    if (lobby.players && socket.id) {
                        const me = lobby.players.find(p => p.sid === socket.id);
                        if (me) {
                            currentPlayer = me;
                        }
                    }
                } catch (e) {}
                // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å waiting ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–Ω–∞—Ç—É –æ–∂–∏–¥–∞–Ω–∏—è, –µ—Å–ª–∏ playing ‚Äî –∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ
                if (lobby.status === 'waiting') {
                    showLobbyRoom();
                } else if (lobby.status === 'playing') {
                    showGameBoard();
                } else {
                    showLobbyList();
                }
            });
        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –æ–∂–∏–¥–∞–Ω–∏—è –ª–æ–±–±–∏
    function showLobbyRoom() {
            // –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ –∫–æ–º–Ω–∞—Ç–µ –ª–æ–±–±–∏
            document.getElementById('gameBoard').style.display = 'none';
            document.getElementById('lobbySection').style.display = 'none';
            const sidebar = document.querySelector('.app-sidebar'); if (sidebar) sidebar.style.display = 'none';

            const lobbyRoom = document.getElementById('lobbyRoom');
            lobbyRoom.style.display = 'block';
            lobbyRoom.classList.add('fade-enter-active');

            renderLobbyRoom();
        }

        function renderPlayers() {
            if (!currentLobby || !currentLobby.players) return;

            const playersContainer = document.getElementById('playersDisplay');
            playersContainer.innerHTML = '';

            currentLobby.players.forEach(player => {
                const playerEl = document.createElement('div');
                playerEl.className = `player-display ${player.symbol === currentLobby.current_player ? 'active' : ''}`;
                playerEl.innerHTML = `
                    <img src="${player.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(player.name)}&background=5865f2&color=ffffff&size=128`}" alt="${player.name}" class="player-display-avatar-img" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(player.name)}&background=5865f2&color=ffffff&size=128';">
                    <div class="player-display-info">
                        <p class="player-display-name">${player.name}</p>
                        <p class="player-display-symbol">–ò–≥—Ä–æ–∫ ${player.symbol}</p>
                    </div>
                `;
                playersContainer.appendChild(playerEl);
            });

            // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É –∏–≥—Ä–æ–∫–∞–º–∏
            if (currentLobby.players.length === 2) {
                const divider = document.createElement('div');
                divider.className = 'vs-divider';
                divider.innerHTML = 'VS';
                playersContainer.appendChild(divider);
            }
        }

    function renderLobbyRoom() {
            if (!currentLobby) return;

            // –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
            const list = document.getElementById('lobbyPlayersList');
            list.innerHTML = '';

            currentLobby.players.forEach((p, idx) => {
                const div = document.createElement('div');
                div.className = 'lobby-player';
                div.innerHTML = `
                    <img src="${p.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}&background=5865f2&color=ffffff&size=96`}" alt="${p.name}" class="lobby-player-avatar-img" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}&background=5865f2&color=ffffff&size=96';">
                    <div class="lobby-player-info">
                        <h3>${p.name} ${idx === 0 ? '<span style="color: var(--discord-primary); font-size: 0.85em;">(—Å–æ–∑–¥–∞—Ç–µ–ª—å)</span>' : ''}</h3>
                        <span class="symbol">–ò–≥—Ä–æ–∫ ${p.symbol}</span>
                    </div>
                `;
                list.appendChild(div);
            });

            // –ü—É—Å—Ç—ã–µ –º–µ—Å—Ç–∞ –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            for (let i = currentLobby.players.length; i < 2; i++) {
                const div = document.createElement('div');
                div.className = 'lobby-player';
                div.innerHTML = `
                    <div class="lobby-player-avatar" style="background: var(--text-muted);">?</div>
                    <div class="lobby-player-info">
                        <h3 style="color: var(--text-muted); font-style: italic;">–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞</h3>
                        <span class="symbol" style="color: var(--text-muted);">–°–≤–æ–±–æ–¥–Ω–æ</span>
                    </div>
                `;
                list.appendChild(div);
            }

      // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      const btns = document.getElementById('lobbyRoomBtns');
      btns.innerHTML = '';

      let isOwner = false;
      if (currentLobby && currentPlayer && currentLobby.players && currentLobby.players.length > 0) {
        isOwner = currentLobby.players[0].user_id === currentPlayer.user_id;
      }

      // –î–µ–ª–µ–≥–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ ‚Äî –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ —ç—Ç–æ –Ω–∞–¥—ë–∂–Ω–µ–µ
      btns.addEventListener('click', function(e) {
        const btn = e.target.closest('button');
        if (!btn) return;
        if (btn.dataset.action === 'start') {
          startGame();
        } else if (btn.dataset.action === 'dissolve') {
          dissolveLobby();
        } else if (btn.dataset.action === 'leave') {
          leaveLobby();
        }
      });

      if (isOwner) {
        if (currentLobby.players.length === 2) {
          const startBtn = document.createElement('button');
          startBtn.className = 'game-btn primary';
          startBtn.dataset.action = 'start';
          startBtn.innerHTML = '<i class="fas fa-play-circle"></i> –ù–∞—á–∞—Ç—å –∏–≥—Ä—É';
          btns.appendChild(startBtn);
        }
        const closeBtn = document.createElement('button');
        closeBtn.className = 'game-btn danger';
        closeBtn.dataset.action = 'dissolve';
        closeBtn.innerHTML = '<i class="fas fa-times"></i> –ó–∞–∫—Ä—ã—Ç—å –ª–æ–±–±–∏';
        btns.appendChild(closeBtn);
      } else {
        const leaveBtn = document.createElement('button');
        leaveBtn.className = 'game-btn secondary';
        leaveBtn.dataset.action = 'leave';
        leaveBtn.innerHTML = '<i class="fas fa-arrow-left"></i> –ü–æ–∫–∏–Ω—É—Ç—å –ª–æ–±–±–∏';
        btns.appendChild(leaveBtn);
      }
        }

        function startGame() {
            if (currentLobby) {
                socket.emit('start_game', { lobby_id: currentLobby.id });
            }
        }

    function dissolveLobby() {
      if (currentLobby && socket) {
        socket.emit('dissolve_lobby', { lobby_id: currentLobby.id });

        currentLobby = null;
        currentPlayer = null;

        showLobbyList();
      } else {
        // unable to dissolve lobby: missing state or connection
      }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ dissolve_lobby
    socket.on('lobby_dissolved', (data) => {
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
      currentLobby = null;
      currentPlayer = null;
      showLobbyList();
    });

        function startGame() {
            if (currentLobby && socket) {
                socket.emit('start_game', { lobby_id: currentLobby.id });
            }
        }

            socket.on('lobbies_list', (lobbies) => {
                renderLobbyList(lobbies);
            });

            // –ö–æ–≥–¥–∞ –±–µ–∫ –≤–µ—Ä–Ω—É–ª –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ Telegram (–≤–∫–ª—é—á–∞—è —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–æ—Ç–æ)
            socket.on('telegram_profile', (profile) => {
                try {
                    if (profile && profile.name) playerName = profile.name;
                    if (profile && profile.avatar) playerAvatar = profile.avatar;
                    if (profile && profile.user_id) webUserId = profile.user_id;
                    // Update UI with new profile
                    updateProfileUI();
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –≤ localStorage
                    localStorage.setItem('tic_profile', JSON.stringify({ user_id: webUserId, name: playerName, avatar: playerAvatar }));
                    // –µ—Å–ª–∏ —É–∂–µ –≤ –ª–æ–±–±–∏ ‚Äî –æ–±–Ω–æ–≤–∏–º
                    if (currentLobby) {
                        socket.emit('get_lobbies');
                    }
                    // –£–±–∏—Ä–∞–µ–º –æ–≤–µ—Ä–ª–µ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    hideAuthOverlay();
                } catch (e) { }
            });

      socket.on('error', (data) => {
        // server error
      });
        }

    function setupEventListeners() {
            // –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
            document.getElementById('createLobbyBtn').addEventListener('click', createLobby);
            document.getElementById('refreshProfileBtn').addEventListener('click', refreshProfile);
            document.getElementById('authorizeBtn').addEventListener('click', authorizeWithBot);
            // –ö–Ω–æ–ø–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ –æ–≤–µ—Ä–ª–µ ‚Äî –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –ø—Ä–∏–≤—è–∂–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
      try {
        const authBtnOverlay = document.getElementById('authActionBtn');
        if (authBtnOverlay) {
          authBtnOverlay.addEventListener('click', authorizeWithBot);
        }
      } catch (e) { /* ignore */ }

            // –ö–Ω–æ–ø–∫–∏ –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è
            document.getElementById('leaveGameBtn').addEventListener('click', leaveLobby);
            document.getElementById('newGameBtn').addEventListener('click', resetGame);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –∏–≥—Ä–æ–≤—ã–º –∫–ª–µ—Ç–∫–∞–º
            document.querySelectorAll('.game-cell').forEach((cell, index) => {
                cell.addEventListener('click', () => makeMove(index));
                cell.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('taken')) {
                        this.style.transform = 'scale(1.05)';
                    }
                });
                cell.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('taken')) {
                        this.style.transform = '';
                    }
                });
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('winModal');
                    if (modal.style.display === 'flex') {
                        hideWinModal();
                    }
                }
            });
        }

        async function authorizeWithBot() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º socket
            if (!socket) {
                showToast('error','Socket –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
        return;
      }
            if (!socket.id) {
                showToast('warn','Socket –Ω–µ –∏–º–µ–µ—Ç ID (–µ—â—ë –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω). –ü–æ–¥–æ–∂–¥–∏—Ç–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
        return;
      }
      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É –±–µ–∫–µ–Ω–¥–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      try {
        const body = { sid: socket.id };
                const resp = await fetch('/auth_code', { method: 'POST', body: JSON.stringify(body), headers: { 'Content-Type': 'application/json' } });
                const data = await resp.json();
                if (data && data.code) {
                    const code = data.code;
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ –∫–æ–¥ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
                    // –ö–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—É—á–µ–Ω

                    // –§–æ—Ä–º–∏—Ä—É–µ–º deeplink –Ω–∞ –±–æ—Ç–∞ —Å payload auth:<code>
                    const botUsername = 'hesusinsidemegabot';
                    const link = `https://t.me/${botUsername}?start=auth:${encodeURIComponent(code)}`;

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–¥ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è —Ä—É—á–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    document.getElementById('authStatus').innerHTML =
                        `<b>1.</b> <a href="${link}" target="_blank" style="color:#5865f2;">–û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram</a><br>` +
                        `<b>2.</b> –ï—Å–ª–∏ –±–æ—Ç –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, <b>–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–º–∞–Ω–¥—É –Ω–∏–∂–µ</b> —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –µ—ë, –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É:<br>` +
                        `<div id="copyAuthCode" style="margin:8px 0;padding:6px 10px;background:#40444b;border:1px solid #202225;border-radius:8px;font-size:1.08em;word-break:break-all;cursor:pointer;user-select:all;transition:background 0.2s;color:#dcddde;">/start auth:${code}</div>` +
                        `<span id="copyHint" style="display:none;color:#5865f2;font-size:0.97em;">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!</span>` +
                        `<span style="color:#b9bbbe;font-size:0.98em;display:block;margin-top:4px;">–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ Mini‚ÄëApp ‚Äî –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</span>`;
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
                    setTimeout(() => {
                        const copyDiv = document.getElementById('copyAuthCode');
                        if (copyDiv) {
                            copyDiv.onclick = function() {
                                const text = copyDiv.textContent;
                                if (navigator.clipboard) {
                                    navigator.clipboard.writeText(text);
                                } else {
                                    // fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                                    const textarea = document.createElement('textarea');
                                    textarea.value = text;
                                    document.body.appendChild(textarea);
                                    textarea.select();
                                    document.execCommand('copy');
                                    document.body.removeChild(textarea);
                                }
                                const hint = document.getElementById('copyHint');
                                if (hint) {
                                    hint.style.display = 'inline';
                                    setTimeout(()=>{hint.style.display='none';}, 1200);
                                }
                                copyDiv.style.background = '#5865f2';
                                setTimeout(()=>{copyDiv.style.background='#40444b';}, 600);
                            };
                        }
                    }, 100);
                } else {
                    showToast('error','–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                }
            } catch (e) {
        showToast('error','–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É.');
            }
        }

        // Unified auth overlay controls (single implementation)
        function showAuthOverlay() {
            const ov = document.getElementById('authOverlay');
            const main = document.getElementById('mainContainer');
            if (main) {
                main.style.display = 'none';
                main.style.pointerEvents = 'none';
            }
            if (ov) {
                ov.style.display = 'flex';
                ov.style.opacity = '1';
            }
            // bind default action
            const authBtn = document.getElementById('authActionBtn');
            if (authBtn) authBtn.onclick = authorizeWithBot;
        }

        function hideAuthOverlay() {
            const ov = document.getElementById('authOverlay');
            const main = document.getElementById('mainContainer');
            if (ov) ov.style.display = 'none';
            if (main) {
                main.style.display = 'block';
                main.style.pointerEvents = '';
                main.style.filter = '';
            }
        }

    function createLobby() {
      if (socket) {
        const name = '–õ–æ–±–±–∏';
        socket.emit('create_lobby', { name: name, player_name: playerName, player_avatar: playerAvatar, user_id: webUserId });
      } else {
        // socket not connected
      }
    }

        function refreshProfile() {
            if (window.Telegram && window.Telegram.WebApp && socket) {
                const tg = window.Telegram.WebApp;
                const user = (tg.initDataUnsafe && tg.initDataUnsafe.user) || null;
                if (user && user.id) {
                    webUserId = user.id;
                    playerName = user.first_name || user.username || '–ì–æ—Å—Ç—å';
                    // Telegram WebApp does not always expose avatar URL ‚Äî keep empty if not present
                    playerAvatar = user.photo_url || '';
                    updateProfileUI();
                    socket.emit('identify', { user_id: user.id, name: playerName, avatar: playerAvatar });
                }
            }
        }

    function joinLobby(lobbyId) {
      if (socket) {
        socket.emit('join_lobby', { lobby_id: lobbyId, player_name: playerName, player_avatar: playerAvatar, user_id: webUserId });
        // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º UI —Å—Ä–∞–∑—É ‚Äî —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏—à–ª—ë—Ç update_lobby —á—Ç–æ–±—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
        showGameBoard();
      } else {
        // socket not connected
      }
    }

        function leaveLobby() {
            if (currentLobby && socket) {
                socket.emit('leave_lobby', { lobby_id: currentLobby.id });
                currentLobby = null;
                currentPlayer = null;
                showLobbyList();
            }
        }

        function makeMove(position) {
            if (currentLobby && currentPlayer && currentLobby.current_player === currentPlayer.symbol && socket) {
                socket.emit('make_move', { lobby_id: currentLobby.id, position: position });
            }
        }

        function resetGame() {
            // –°–±—Ä–æ—Å –∏–≥—Ä—ã - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É
            if (currentLobby) {
                currentLobby.board = ['', '', '', '', '', '', '', '', ''];
                currentLobby.status = 'playing';
                currentLobby.current_player = 'X';
                // –£–±–∏—Ä–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ–±–µ–¥—ã —Å–æ –≤—Å–µ—Ö –∫–ª–µ—Ç–æ–∫
                document.querySelectorAll('.game-cell').forEach(cell => {
                    cell.classList.remove('win');
                });
                updateGameDisplay();
            }
        }

        function getLobbies() {
            if (socket) {
                socket.emit('get_lobbies');
            }
        }

        function renderLobbyList(lobbies) {
            const lobbyList = document.getElementById('lobbyList');
            lobbyList.innerHTML = '';

            if (lobbies.length === 0) {
                lobbyList.innerHTML = `
                    <div style="text-align: center; color: var(--text-muted); padding: 40px 20px;">
                        <i class="fas fa-gamepad" style="font-size: 3rem; margin-bottom: 16px; opacity: 0.5;"></i>
                        <p style="margin: 0; font-size: 1.1rem;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä</p>
                        <p style="margin: 8px 0 0 0; font-size: 0.9rem;">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∏–≥—Ä—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!</p>
                    </div>
                `;
                return;
            }

            lobbies.forEach(lobby => {
                const lobbyCard = document.createElement('div');
                lobbyCard.className = 'lobby-card';
                lobbyCard.innerHTML = `
                    <div class="lobby-header">
                        <h3 class="lobby-name">${lobby.name}</h3>
                        <span class="lobby-status ${lobby.status}">${getStatusText(lobby.status)}</span>
                    </div>
                    <div class="lobby-players">
                        ${lobby.players.map(p => `
                            <div class="player-info">
                                <img src="${p.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}&background=5865f2&color=ffffff&size=64`}" alt="${p.name}" class="player-avatar-img" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}&background=5865f2&color=ffffff&size=64';">
                                <div class="player-details">
                                    <div class="player-name">${p.name}</div>
                                    <div class="player-symbol">–ò–≥—Ä–æ–∫ ${p.symbol}</div>
                                </div>
                            </div>
                        `).join('')}
                        ${lobby.players.length < 2 ? '<div class="empty-slot">–°–≤–æ–±–æ–¥–Ω–æ</div>' : ''}
                    </div>
                    <div class="lobby-actions">
                        <button class="action-btn join-btn" data-id="${lobby.id}">
                            <i class="fas fa-plus"></i> –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                        </button>
                        <button class="action-btn info-btn" data-id="${lobby.id}">
                            <i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ
                        </button>
                    </div>
                `;

                lobbyList.appendChild(lobbyCard);
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.querySelectorAll('.join-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const lobbyId = this.getAttribute('data-id');
                    joinLobby(lobbyId);
                });
            });

            document.querySelectorAll('.info-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const lobbyId = this.getAttribute('data-id');
                    const lobby = lobbies.find(l => l.id === lobbyId);
                    if (lobby) {
                        showLobbyInfo(lobby);
                    }
                });
            });
        }

        function showLobbyInfo(lobby) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-icon">‚ÑπÔ∏è</div>
                    <h2 class="modal-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–æ–±–±–∏</h2>
                    <p class="modal-description">
                        <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${lobby.name}<br>
                        <strong>–ò–≥—Ä–æ–∫–∏:</strong> ${lobby.players.map(p => p.name + ' (' + p.symbol + ')').join(', ')}<br>
                        <strong>–°—Ç–∞—Ç—É—Å:</strong> ${getStatusText(lobby.status)}<br>
                        <strong>–°–æ–∑–¥–∞–Ω–æ:</strong> –¢–æ–ª—å–∫–æ —á—Ç–æ
                    </p>
                    <div class="modal-buttons">
                        <button class="game-btn primary" onclick="this.closest('.modal-overlay').remove()">–ü–æ–Ω—è—Ç–Ω–æ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª–∫–∏
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function getStatusText(status) {
            switch(status) {
                case 'waiting': return '–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞';
                case 'playing': return '–ò–≥—Ä–∞ –∏–¥–µ—Ç';
                case 'finished': return '–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
                default: return status;
            }
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∏–≥—Ä—ã
        function updateGameStatus() {
            if (!currentLobby) return;

            const statusText = document.getElementById('gameStatusText');
            const statusIndicator = document.getElementById('gameStatusIndicator');
            const currentPlayerAvatar = document.getElementById('currentPlayerAvatar');
            const currentPlayerName = document.getElementById('currentPlayerName');

            switch(currentLobby.status) {
                case 'playing':
                    if (currentPlayer && currentLobby.players) {
                        const currentPlayerObj = currentLobby.players.find(p => p.symbol === currentLobby.current_player);
                        if (currentPlayerObj) {
                            currentPlayerAvatar.src = currentPlayerObj.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentPlayerObj.name)}&background=5865f2&color=ffffff&size=64`;
                            currentPlayerName.textContent = currentPlayerObj.name;
                        }
                        const isMyTurn = currentLobby.current_player === currentPlayer.symbol;
                        statusText.textContent = isMyTurn ? '–í–∞—à —Ö–æ–¥' : '–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞';
                        statusIndicator.className = `game-status-indicator ${isMyTurn ? 'your-turn' : 'waiting'}`;
                    }
                    break;
                case 'waiting':
                    statusText.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞';
                    currentPlayerName.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞';
                    currentPlayerAvatar.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiM3MjY3N2QiLz4KPHBhdGggZD0iTTE2IDE2QzE4LjIxIDE2IDIwIDE0LjIxIDIwIDEyQzIwIDEwLjc5IDE4LjIxIDkgMTYgOUMxMy43OSA5IDEyIDEwLjc5IDEyIDEyQzEyIDE0LjIxIDEzLjc5IDE2IDE2Wk0xNiAyMEMxOS4zMTggMjAgMjIgMTguMzE4IDIyIDE2QzIyIDEzLjY4MiAxOS4zMTggMTEgMTYgMTFDMTIuNjgyIDExIDEwIDEzLjY4MiAxMCAxNkMxMCAxOC4zMTggMTIuNjgyIDIwIDE2IDIwWk0xNiAyNEMyMS41ODIgMjQgMjYgMTkuNTgyIDI2IDE0QzI2IDguNDE4IDIxLjU4MiA0IDE2IDRDMTAuNDE4IDQgNiA4LjQxOCA2IDE0QzYgMTkuNTgyIDEwLjQxOCAyNCAxNiAyNFoiIGZpbGw9IiNkY2RkZGUiLz4KPC9zdmc+';
                    statusIndicator.className = 'game-status-indicator waiting';
                    break;
                case 'finished':
                    statusText.textContent = '–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
                    if (currentLobby.winner === 'draw') {
                        currentPlayerName.textContent = '–ù–∏—á—å—è!';
                        currentPlayerAvatar.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiNmZWU3NWMiLz4KPHBhdGggZD0iTTggMTJMMTEgMTVMMTYgMTBNMjEgMTJMMjQgMTVMMjEgMThMMTEgMTVMMjQgMTJMMjEgOUwxNiA2TDExIDlMMTEgMTJMMTEgMTVMMTEgMThMMTEgMjFMMTEgMjRMMTEgMjdsLTMgMyIvPgo8L3N2Zz4=';
                    } else {
                        const winner = currentLobby.players.find(p => p.symbol === currentLobby.winner);
                        if (winner) {
                            currentPlayerAvatar.src = winner.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(winner.name)}&background=5865f2&color=ffffff&size=64`;
                            currentPlayerName.textContent = `–ü–æ–±–µ–¥–∏–ª ${winner.name}!`;
                        }
                    }
                    statusIndicator.className = 'game-status-indicator';
                    break;
            }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —ç–∫—Ä–∞–Ω–∞–º–∏
        function switchToScreen(screenId) {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã
            document.querySelectorAll('.app-main > .section').forEach(div => {
                if (div.id !== screenId && div.style.display !== 'none') {
                    div.classList.remove('fade-enter-active');
                    div.classList.add('fade-exit');
                }
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–ª–µ–≤–æ–π —ç–∫—Ä–∞–Ω
            setTimeout(() => {
                const targetScreen = document.getElementById(screenId);
                targetScreen.style.display = 'block';
                targetScreen.classList.add('fade-enter-active');
            }, 150);
        }

        function showGameBoard() {
            // –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ –∏–≥—Ä–æ–≤–æ–º—É –ø–æ–ª—é
            document.getElementById('lobbySection').style.display = 'none';
            const sidebar2 = document.querySelector('.app-sidebar'); if (sidebar2) sidebar2.style.display = 'none';
            document.getElementById('lobbyRoom').style.display = 'none';

            const gameBoard = document.getElementById('gameBoard');
            gameBoard.style.display = 'block';
            gameBoard.classList.add('fade-enter-active');

            updateGameDisplay();
        }

        function showLobbyList() {
            // –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ø–∏—Å–∫—É –ª–æ–±–±–∏
            document.getElementById('gameBoard').style.display = 'none';
            document.getElementById('lobbyRoom').style.display = 'none';

            const lobbySection = document.getElementById('lobbySection');
            const sidebar3 = document.querySelector('.app-sidebar'); if (sidebar3) sidebar3.style.display = 'flex';
            lobbySection.style.display = 'block';
            lobbySection.classList.add('fade-enter-active');

            getLobbies();
        }


        function updateGameDisplay() {
            if (!currentLobby) return;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ
            currentLobby.board.forEach((cell, index) => {
                const cellElement = document.querySelector(`[data-index="${index}"]`);
                cellElement.textContent = cell;
                cellElement.className = 'game-cell';
                if (cell) {
                    cellElement.classList.add(cell.toLowerCase());
                    cellElement.classList.add('taken');
                }
            });

            // –†–µ–Ω–¥–µ—Ä–∏–º –∏–≥—Ä–æ–∫–æ–≤ –∏ —Å—Ç–∞—Ç—É—Å
            renderPlayers();

            const statusIndicator = document.getElementById('gameStatusIndicator');
            const statusText = document.querySelector('.game-status-text');
            const currentPlayerAvatar = document.getElementById('currentPlayerAvatar');
            const currentPlayerName = document.getElementById('currentPlayerName');

            if (currentPlayer && currentLobby.players) {
                const currentPlayerObj = currentLobby.players.find(p => p.symbol === currentLobby.current_player);
                if (currentPlayerObj) {
                    currentPlayerAvatar.src = currentPlayerObj.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentPlayerObj.name)}&background=5865f2&color=ffffff&size=64`;
                    currentPlayerName.textContent = currentPlayerObj.name;
                }

                const isMyTurn = currentLobby.status === 'playing' && currentLobby.current_player === currentPlayer.symbol;
                statusText.textContent = isMyTurn ? '–í–∞—à —Ö–æ–¥' : '–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞';
                statusIndicator.className = `game-status-indicator ${isMyTurn ? 'your-turn' : 'waiting'}`;
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã
            if (currentLobby.status === 'finished') {
                setTimeout(() => {
                    highlightWinningCells();
                    showGameResult();
                }, 200);
            }
        }

        function showGameResult() {
            if (!currentLobby) return;

            let winnerName = '';
            let isDraw = false;
            let icon = 'üéâ';

            if (currentLobby.winner === 'draw') {
                winnerName = '–ù–∏—á—å—è!';
                isDraw = true;
                icon = 'ü§ù';
            } else {
                const winner = currentLobby.players.find(p => p.symbol === currentLobby.winner);
                winnerName = winner ? `–ü–æ–±–µ–¥–∏–ª ${winner.name}!` : `–ü–æ–±–µ–¥–∏–ª ${currentLobby.winner}!`;
                icon = 'üéâ';
            }

            showWinModal(winnerName, isDraw, icon);
        }

    // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–ª–µ—Ç–∫–∞–º
    // (—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã—à–µ –≤ —Ñ–∞–π–ª–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è; –∑–¥–µ—Å—å –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –±–µ–∑ debug)
    function makeMove(position) {
      if (currentLobby && currentPlayer && currentLobby.current_player === currentPlayer.symbol && socket) {
        socket.emit('make_move', { lobby_id: currentLobby.id, position: position });
      } else {
        // cannot make move
      }
    }
        // –£–ª—É—á—à–µ–Ω–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–±–µ–¥—ã
        function showWinModal(winnerText, isDraw, icon = 'üéâ') {
            const modal = document.getElementById('winModal');
            const modalIcon = document.getElementById('winModalAnim');
            const modalTitle = document.getElementById('winModalText');
            const modalDescription = document.querySelector('#winModal .modal-description');
            const modalBtns = document.getElementById('winModalBtns');

            modal.style.display = 'flex';
            modalIcon.textContent = icon;
            modalTitle.textContent = winnerText;
            modalDescription.textContent = isDraw ? '–û—Ç–ª–∏—á–Ω–∞—è –∏–≥—Ä–∞! –ù–∏–∫—Ç–æ –Ω–µ –ø–æ–±–µ–¥–∏–ª.' : '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø–æ–±–µ–¥–æ–π!';

            modalBtns.innerHTML = '';

            let isOwner = false;
            if (currentLobby && currentPlayer && currentLobby.players && currentLobby.players.length > 0) {
                isOwner = currentLobby.players[0].user_id === currentPlayer.user_id;
            }

            if (isOwner) {
                modalBtns.innerHTML = `
                    <button class="game-btn danger" onclick="hideWinModal(); leaveLobby();">
                        <i class="fas fa-times-circle"></i>
                        –ó–∞–≤–µ—Ä—à–∏—Ç—å
                    </button>
                    <button class="game-btn primary" onclick="hideWinModal(); resetGame();">
                        <i class="fas fa-redo-alt"></i>
                        –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                `;
            } else {
                modalBtns.innerHTML = `
                    <button class="game-btn primary" onclick="hideWinModal(); leaveLobby();">
                        <i class="fas fa-check-circle"></i>
                        –ü–æ–Ω—è—Ç–Ω–æ
                    </button>
                `;
            }
        }

        function hideWinModal() {
            const modal = document.getElementById('winModal');
            modal.style.display = 'none';
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function showAuthOverlay() {
            const overlay = document.getElementById('authOverlay');
            const mainContent = document.querySelector('.app-container');

            mainContent.style.filter = 'blur(4px)';
            mainContent.style.pointerEvents = 'none';
            overlay.style.display = 'flex';

            // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è
            setTimeout(() => {
                overlay.style.opacity = '1';
            }, 10);
        }

        function hideAuthOverlay() {
            const overlay = document.getElementById('authOverlay');
            const mainContent = document.querySelector('.app-container');

            mainContent.style.filter = '';
            mainContent.style.pointerEvents = '';
            overlay.style.display = 'none';
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–Ω—ã—Ö –∫–ª–µ—Ç–æ–∫
        function highlightWinningCells() {
            if (!currentLobby || currentLobby.status !== 'finished') return;

            const board = currentLobby.board;
            const currentSymbol = currentLobby.winner;

            if (!currentSymbol || currentSymbol === 'draw') return;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–±–µ–¥–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
            const winningConditions = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
                [0, 4, 8], [2, 4, 6] // Diagonals
            ];

            // –ù–∞—Ö–æ–¥–∏–º –∏ –≤—ã–¥–µ–ª—è–µ–º –ø–æ–±–µ–¥–Ω—É—é –∫–æ–º–±–∏–Ω–∞—Ü–∏—é
            winningConditions.forEach((condition, comboIndex) => {
                const [a, b, c] = condition;
                if (board[a] === currentSymbol && board[b] === currentSymbol && board[c] === currentSymbol) {
                    // –í—ã–¥–µ–ª—è–µ–º –ø–æ–±–µ–¥–Ω—ã–µ –∫–ª–µ—Ç–∫–∏ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞
                    setTimeout(() => {
                        document.querySelector(`[data-index="${a}"]`).classList.add('win');
                    }, comboIndex * 100);

                    setTimeout(() => {
                        document.querySelector(`[data-index="${b}"]`).classList.add('win');
                    }, comboIndex * 100 + 50);

                    setTimeout(() => {
                        document.querySelector(`[data-index="${c}"]`).classList.add('win');
                    }, comboIndex * 100 + 100);
                }
            });
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ –∏–≥—Ä—ã
        function resetGame() {
            if (currentLobby) {
                // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–Ω—ã—Ö –∫–ª–µ—Ç–æ–∫ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                const winningCells = document.querySelectorAll('.game-cell.win');
                winningCells.forEach((cell, index) => {
                    setTimeout(() => {
                        cell.classList.remove('win');
                    }, index * 50);
                });

                // –°–±—Ä–æ—Å –∏–≥—Ä–æ–≤–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                setTimeout(() => {
                    currentLobby.board = ['', '', '', '', '', '', '', '', ''];
                    currentLobby.status = 'playing';
                    currentLobby.current_player = 'X';
                    updateGameDisplay();
                }, 300);
            }
        }

            // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –≤ HTML
            function escapeHTML(s) {
                return String(s).replace(/[&<>"']/g, function (c) {
                    return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c];
                });
            }

            // –û–±–Ω–æ–≤–ª—è–µ—Ç UI –ø—Ä–æ—Ñ–∏–ª—è –≤ —Å–∞–π–¥–±–∞—Ä–µ (–∞–≤–∞—Ç–∞—Ä + –∏–º—è + –ø–æ–¥—Å–∫–∞–∑–∫–∞)
            function updateProfileUI() {
                try {
                    const nameEl = document.getElementById('profileName');
                    const subEl = document.getElementById('profileSub');
                    const avatarImg = document.getElementById('profileAvatarImg');
                    if (nameEl) nameEl.textContent = playerName || '–ì–æ—Å—Ç—å';
                    if (subEl) subEl.textContent = webUserId ? '–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' : '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
                    if (avatarImg) {
                        if (playerAvatar) {
                            avatarImg.src = playerAvatar;
                            avatarImg.style.display = 'block';
                        } else {
                            // fallback: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º UI-avatars URL
                            avatarImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(playerName || '–ì–æ—Å—Ç—å')}&background=5865f2&color=ffffff&size=128`;
                            avatarImg.style.display = 'block';
                        }
                    }
                } catch (e) { /* ignore UI update errors */ }
            }

            // –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä —Å—Ç–∞—Ç—É—Å–∞/–∏–≥—Ä–æ–∫–æ–≤
            function renderStatusAndPlayers(lobby) {
                const statusEl = document.getElementById('statusMessage');
                if (!lobby || !lobby.players) { statusEl.innerHTML = ''; return; }

                const playersHtml = lobby.players.map(p => {
                    const avatar = p.avatar ? escapeHTML(p.avatar) : `https://ui-avatars.com/api/?name=${encodeURIComponent(escapeHTML(p.name))}`;
                    // –ï—Å–ª–∏ –Ω–∏–∫ –¥–ª–∏–Ω–Ω–µ–µ 10 —Å–∏–º–≤–æ–ª–æ–≤ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å marquee
                    const isLong = p.name && p.name.length > 10;
                    return `
                        <div class="player-small">
                            <img src="${avatar}" alt="avatar">
                            <div style="display:flex;flex-direction:column;">
                                <span class="name${isLong ? ' marquee' : ''}">${escapeHTML(p.name)}</span>
                                <span class="symbol">(${escapeHTML(p.symbol)})</span>
                            </div>
                        </div>
                    `;
                }).join('<span class="vs-sep">vs</span>');

                let statusText = '';
                if (lobby.status === 'playing') statusText = `–ò–≥—Ä–∞ –∏–¥–µ—Ç | –•–æ–¥ ${escapeHTML(lobby.current_player)}`;
                else if (lobby.status === 'waiting') statusText = '–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞';
                else if (lobby.status === 'finished') statusText = lobby.winner === 'draw' ? '–ù–∏—á—å—è' : `–ü–æ–±–µ–¥–∏–ª ${escapeHTML(lobby.winner)}`;

                statusEl.innerHTML = `<div class="players-row">${playersHtml}</div><div class="status-line">${statusText}</div>`;
            }

            // Toast helper
            function showToast(type, message, timeout = 4200) {
                try {
                    const wrap = document.getElementById('toastWrap');
                    if (!wrap) return;
                    const t = document.createElement('div');
                    t.className = `toast ${type || 'info'}`;
                    t.textContent = message;
                    wrap.appendChild(t);
                    // appear
                    requestAnimationFrame(()=>{ t.classList.remove('hide'); });
                    if (timeout > 0) setTimeout(()=>{ hideToast(t); }, timeout);
                } catch (e) { console.warn('toast', e); }
            }

            function hideToast(el) {
                try {
                    el.classList.add('hide');
                    setTimeout(()=>{ el.remove(); }, 260);
                } catch(e){}
            }
    </script>
</body>
</html>