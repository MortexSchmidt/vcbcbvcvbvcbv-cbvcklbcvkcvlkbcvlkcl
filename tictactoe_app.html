<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
    /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π Discord —Ä–µ–º–∞—Å—Ç–µ—Ä */
    :root {
      --discord-primary: #5865f2;
      --discord-success: #23a559;
      --discord-warning: #fee75c;
      --discord-danger: #f23f43;
      --discord-brand: #5865f2;
      --discord-blurple: #5865f2;

      /* –¢–µ–º–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞ */
      --bg-primary: #313338;
      --bg-secondary: #2b2d31;
      --bg-tertiary: #1e1f22;
      --bg-accent: #404eed;

      /* –¢–µ–∫—Å—Ç */
      --text-primary: #dbdee1;
      --text-secondary: #b5bac1;
      --text-muted: #80848e;
      --text-link: #00aff4;

      /* –ì—Ä–∞–Ω–∏—Ü—ã –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ */
      --border-primary: #3f4248;
      --border-secondary: #202225;

      /* –¢–µ–Ω–∏ */
      --shadow-high: 0 8px 16px rgba(0, 0, 0, 0.24);
      --shadow-medium: 0 4px 8px rgba(0, 0, 0, 0.16);
      --shadow-low: 0 2px 4px rgba(0, 0, 0, 0.08);

      /* –†–∞–¥–∏—É—Å—ã */
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;

      /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
      --transition-fast: 0.15s ease-out;
      --transition-medium: 0.25s ease-out;
      --transition-slow: 0.35s ease-out;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', 'Whitney', 'Helvetica Neue', Arial, sans-serif;
      font-size: 16px;
      line-height: 1.4;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    .app-container {
      width: 100%;
      max-width: 520px;
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-high);
      overflow: hidden;
      position: relative;
    }

    /* –®–∞–ø–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
    .app-header {
      background: var(--bg-primary);
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-primary);
      position: relative;
    }

    .app-header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--discord-primary), var(--discord-success));
    }

    .app-title {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: center;
    }

    .app-title::before {
      content: '\f1e7';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      font-size: 1.2rem;
      color: var(--discord-primary);
    }

    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
    .app-content {
      padding: 24px;
    }

    /* –°–µ–∫—Ü–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é */
    .main-menu {
      text-align: center;
      margin-bottom: 24px;
    }

    .menu-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 20px 0;
    }

    .menu-description {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin: 0 0 24px 0;
      line-height: 1.5;
    }

    /* –ö–Ω–æ–ø–∫–∏ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é */
    .menu-buttons {
      display: grid;
      gap: 12px;
      margin-bottom: 24px;
    }

    .menu-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 16px 20px;
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-lg);
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: 500;
      text-decoration: none;
      transition: all var(--transition-medium);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .menu-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s;
    }

    .menu-btn:hover::before {
      left: 100%;
    }

    .menu-btn:hover {
      background: var(--bg-accent);
      border-color: var(--discord-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .menu-btn:active {
      transform: translateY(0);
    }

    .menu-btn.primary {
      background: var(--discord-primary);
      color: white;
      border-color: var(--discord-primary);
    }

    .menu-btn.primary:hover {
      background: #4752c4;
      border-color: #4752c4;
    }

    .menu-btn i {
      font-size: 1.1rem;
    }

    /* –°–ø–∏—Å–æ–∫ –ª–æ–±–±–∏ */
    .lobby-section {
      margin-bottom: 24px;
    }

    .lobby-section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 16px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .lobby-section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-primary);
    }

    .lobby-grid {
      display: grid;
      gap: 12px;
      margin-bottom: 16px;
    }

    .lobby-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-lg);
      padding: 16px;
      transition: all var(--transition-medium);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .lobby-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--discord-primary), var(--discord-success));
      opacity: 0;
      transition: opacity var(--transition-medium);
    }

    .lobby-card:hover {
      border-color: var(--discord-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .lobby-card:hover::before {
      opacity: 1;
    }

    .lobby-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .lobby-name {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .lobby-status {
      padding: 4px 8px;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .lobby-status.playing {
      background: rgba(88, 101, 242, 0.2);
      color: var(--discord-primary);
    }

    .lobby-status.waiting {
      background: rgba(254, 231, 92, 0.2);
      color: var(--discord-warning);
    }

    .lobby-players {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .player-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .player-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--discord-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.9rem;
      color: white;
      object-fit: cover;
    }

    .player-avatar-img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--border-primary);
    }

    .player-details {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .player-name {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .player-symbol {
      font-size: 0.8rem;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .empty-slot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--border-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .lobby-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .action-btn {
      flex: 1;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .action-btn:hover {
      background: var(--discord-primary);
      border-color: var(--discord-primary);
      color: white;
    }

    /* –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ */
    .game-section {
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      padding: 24px;
      text-align: center;
      position: relative;
    }

    .game-status {
      margin-bottom: 20px;
    }

    .game-status-text {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 8px 0;
    }

    .game-status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      font-size: 0.9rem;
      font-weight: 500;
    }

    .game-status-indicator.your-turn {
      background: rgba(88, 101, 242, 0.2);
      color: var(--discord-primary);
    }

    .game-status-indicator.waiting {
      background: rgba(128, 132, 142, 0.2);
      color: var(--text-secondary);
    }

    .players-display {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .player-display {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border: 2px solid transparent;
      transition: all var(--transition-medium);
    }

    .player-display.active {
      border-color: var(--discord-primary);
      background: rgba(88, 101, 242, 0.1);
    }

    .player-display-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--discord-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.1rem;
      color: white;
      object-fit: cover;
    }

    .player-display-avatar-img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--border-primary);
    }

    .player-display-info {
      text-align: left;
    }

    .player-display-name {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .player-display-symbol {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin: 0;
    }

    .vs-divider {
      color: var(--discord-warning);
      font-size: 1.2rem;
      font-weight: 700;
    }

    /* –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ */
    .game-board-container {
      margin: 24px 0;
    }

    .board-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
    }

    .game-cell {
      aspect-ratio: 1;
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: calc(2rem + 1vw);
      font-weight: 700;
      cursor: pointer;
      transition: all var(--transition-medium);
      border: 3px solid transparent;
      position: relative;
      overflow: hidden;
    }

    .game-cell::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center, transparent 70%, rgba(255, 255, 255, 0.05));
      opacity: 0;
      transition: opacity var(--transition-medium);
    }

    .game-cell:hover:not(.taken)::before {
      opacity: 1;
    }

    .game-cell:hover:not(.taken) {
      background: var(--bg-accent);
      border-color: var(--discord-primary);
      transform: scale(1.05);
      box-shadow: var(--shadow-medium);
    }

    .game-cell.taken {
      cursor: default;
      opacity: 0.8;
    }

    .game-cell.x {
      color: var(--discord-success);
      background: rgba(35, 165, 89, 0.15);
    }

    .game-cell.o {
      color: var(--discord-warning);
      background: rgba(254, 231, 92, 0.15);
    }

    .game-cell.win {
      animation: winAnimation 0.8s ease-in-out;
      border-color: var(--discord-success);
      box-shadow: 0 0 20px rgba(35, 165, 89, 0.5);
    }

    @keyframes winAnimation {
      0%, 100% { transform: scale(1); }
      25% { transform: scale(1.1); }
      50% { transform: scale(1.05); }
      75% { transform: scale(1.08); }
    }

    /* –ö–Ω–æ–ø–∫–∏ –∏–≥—Ä—ã */
    .game-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 24px;
    }

    .game-btn {
      padding: 12px 24px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-lg);
      color: var(--text-primary);
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-medium);
      position: relative;
      overflow: hidden;
    }

    .game-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, var(--discord-primary), var(--discord-success));
      opacity: 0;
      transition: opacity var(--transition-medium);
    }

    .game-btn > * {
      position: relative;
      z-index: 1;
    }

    .game-btn:hover::before {
      opacity: 0.1;
    }

    .game-btn:hover {
      background: var(--bg-accent);
      border-color: var(--discord-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .game-btn.primary {
      background: var(--discord-primary);
      color: white;
      border-color: var(--discord-primary);
    }

    .game-btn.primary:hover {
      background: #4752c4;
    }

    .game-btn.danger {
      background: var(--discord-danger);
      color: white;
      border-color: var(--discord-danger);
    }

    .game-btn.danger:hover {
      background: #c2332f;
    }

    /* –ö–æ–º–Ω–∞—Ç–∞ –ª–æ–±–±–∏ */
    .lobby-room {
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      padding: 24px;
      text-align: center;
    }

    .lobby-room-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 20px 0;
    }

    .lobby-players-display {
      margin-bottom: 24px;
    }

    .lobby-player {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 16px;
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      margin-bottom: 12px;
    }

    .lobby-player-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--discord-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.3rem;
      color: white;
      object-fit: cover;
    }

    .lobby-player-avatar-img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--border-primary);
    }

    .lobby-player-info h3 {
      margin: 0;
      font-size: 1.1rem;
      color: var(--text-primary);
    }

    .lobby-player-info .symbol {
      color: var(--discord-primary);
      font-weight: 600;
    }

    .lobby-room-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      backdrop-filter: blur(4px);
    }

    .modal-content {
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      padding: 32px;
      max-width: 420px;
      width: 90%;
      text-align: center;
      border: 1px solid var(--border-primary);
      box-shadow: var(--shadow-high);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-icon {
      font-size: 3rem;
      margin-bottom: 16px;
    }

    .modal-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 12px 0;
    }

    .modal-description {
      font-size: 1rem;
      color: var(--text-secondary);
      margin: 0 0 24px 0;
      line-height: 1.5;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    /* –û–≤–µ—Ä–ª–µ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
    .auth-overlay {
      position: fixed;
      inset: 0;
      background: rgba(30, 31, 34, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(8px);
    }

    .auth-container {
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      padding: 32px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      border: 2px solid var(--discord-primary);
      box-shadow: 0 0 40px rgba(88, 101, 242, 0.2);
      animation: authPulse 2s ease-in-out infinite;
    }

    @keyframes authPulse {
      0%, 100% { box-shadow: 0 0 40px rgba(88, 101, 242, 0.2); }
      50% { box-shadow: 0 0 60px rgba(88, 101, 242, 0.3); }
    }

    .auth-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 12px 0;
    }

    .auth-description {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin: 0 0 20px 0;
      line-height: 1.5;
    }

    .auth-button {
      width: 100%;
      padding: 14px 20px;
      background: var(--discord-primary);
      border: none;
      border-radius: var(--radius-lg);
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-medium);
      margin-bottom: 16px;
    }

    .auth-button:hover {
      background: #4752c4;
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .auth-status {
      font-size: 0.9rem;
      color: var(--text-muted);
      padding: 12px;
      background: var(--bg-primary);
      border-radius: var(--radius-md);
    }

    .auth-code {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      word-break: break-all;
      cursor: pointer;
      transition: all var(--transition-fast);
      margin: 8px 0;
    }

    .auth-code:hover {
      background: var(--bg-accent);
      border-color: var(--discord-primary);
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 640px) {
      body {
        padding: 8px;
      }

      .app-container {
        max-width: 100%;
        border-radius: var(--radius-lg);
      }

      .app-content {
        padding: 16px;
      }

      .menu-buttons {
        gap: 8px;
      }

      .menu-btn {
        padding: 12px 16px;
        font-size: 0.9rem;
      }

      .board-grid {
        gap: 8px;
      }

      .game-cell {
        font-size: calc(1.8rem + 1vw);
      }

      .players-display {
        gap: 12px;
      }

      .player-display {
        padding: 8px 12px;
      }

      .player-display-avatar {
        width: 32px;
        height: 32px;
        font-size: 1rem;
      }

      .modal-content {
        padding: 24px;
        margin: 16px;
      }

      .auth-container {
        padding: 24px;
        margin: 16px;
      }
    }

    /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ */
    .loading-pulse {
      animation: loadingPulse 1.5s ease-in-out infinite;
    }

    @keyframes loadingPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ */
    .fade-enter {
      opacity: 0;
      transform: translateY(10px);
    }

    .fade-enter-active {
      opacity: 1;
      transform: translateY(0);
      transition: opacity 0.3s, transform 0.3s;
    }

    .fade-exit {
      opacity: 1;
      transform: translateY(0);
    }

    .fade-exit-active {
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.3s, transform 0.3s;
    }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <h1 class="app-title">–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</h1>
        </div>

        <div class="app-content">
            <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
            <div class="main-menu">
                <h2 class="menu-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
                <p class="menu-description">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–µ –ª–æ–±–±–∏ –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∏–≥—Ä–µ</p>

                <div class="menu-buttons">
                    <button class="menu-btn primary" id="createLobbyBtn">
                        <i class="fas fa-plus-circle"></i>
                        –°–æ–∑–¥–∞—Ç—å –ª–æ–±–±–∏
                    </button>
                    <button class="menu-btn" id="refreshProfileBtn">
                        <i class="fas fa-sync-alt"></i>
                        –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                    </button>
                    <button class="menu-btn" id="authorizeBtn">
                        <i class="fas fa-user-check"></i>
                        –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ –±–æ—Ç–µ
                    </button>
                </div>
            </div>

            <!-- –ö–æ–º–Ω–∞—Ç–∞ –ª–æ–±–±–∏ -->
            <div id="lobbyRoom" class="lobby-room fade-enter" style="display:none;">
                <h2 class="lobby-room-title">–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤</h2>
                <div id="lobbyPlayersList" class="lobby-players-display"></div>
                <div id="lobbyRoomBtns" class="lobby-room-buttons"></div>
            </div>
            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–±–µ–¥—ã -->
            <div id="winModal" class="modal-overlay" style="display:none;">
                <div class="modal-content">
                    <div id="winModalAnim" class="modal-icon">üéâ</div>
                    <h2 id="winModalText" class="modal-title">–ü–æ–±–µ–¥–∞!</h2>
                    <p class="modal-description">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø–æ–±–µ–¥–æ–π –≤ –∏–≥—Ä–µ!</p>
                    <div id="winModalBtns" class="modal-buttons"></div>
                </div>
            </div>
            <!-- –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ª–æ–±–±–∏ -->
            <div class="lobby-section" id="lobbySection">
                <h3 class="lobby-section-title">
                    <i class="fas fa-list"></i>
                    –î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–≥—Ä—ã
                </h3>
                <div class="lobby-grid" id="lobbyList">
                    <!-- –õ–æ–±–±–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>

            <!-- –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ -->
            <div class="game-section fade-enter" id="gameBoard" style="display:none;">
                <div class="game-status">
                    <p class="game-status-text">–•–æ–¥ –∏–≥—Ä–æ–∫–∞</p>
                    <div class="game-status-indicator your-turn" id="gameStatusIndicator">
                        –í–∞—à —Ö–æ–¥
                    </div>
                </div>

                <div class="players-display" id="playersDisplay">
                    <!-- –ò–≥—Ä–æ–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>

                <div class="game-board-container">
                    <div class="board-grid" id="boardGrid">
                        <div class="game-cell" data-index="0"></div>
                        <div class="game-cell" data-index="1"></div>
                        <div class="game-cell" data-index="2"></div>
                        <div class="game-cell" data-index="3"></div>
                        <div class="game-cell" data-index="4"></div>
                        <div class="game-cell" data-index="5"></div>
                        <div class="game-cell" data-index="6"></div>
                        <div class="game-cell" data-index="7"></div>
                        <div class="game-cell" data-index="8"></div>
                    </div>
                </div>

                <div class="game-buttons">
                    <button class="game-btn secondary" id="leaveGameBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        –ü–æ–∫–∏–Ω—É—Ç—å –∏–≥—Ä—É
                    </button>
                    <button class="game-btn primary" id="newGameBtn">
                        <i class="fas fa-redo"></i>
                        –ù–æ–≤–∞—è –∏–≥—Ä–∞
                    </button>
                </div>
            </div>
    </div>
    </div>
            <!-- –û–≤–µ—Ä–ª–µ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
            <div id="authOverlay" class="auth-overlay" style="display:none;">
                <div class="auth-container">
                    <h2 class="auth-title">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram</h2>
                    <p class="auth-description">
                        –î–ª—è –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ª–∏—á–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ –Ω–∞—à–µ–≥–æ Telegram-–±–æ—Ç–∞.
                        –≠—Ç–æ –∑–∞–π–º–µ—Ç –≤—Å–µ–≥–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏–≥—Ä–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞.
                    </p>
                    <button id="authActionBtn" class="auth-button">
                        <i class="fab fa-telegram-plane"></i>
                        –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞
                    </button>
                    <div id="authStatus" class="auth-status">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...</div>
                </div>
            </div>


        <noscript>
            <div style="padding:32px;text-align:center;color:#ff6b6b;font-size:1.2rem;">–î–ª—è —Ä–∞–±–æ—Ç—ã Mini‚ÄëApp —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–∫–ª—é—á–∏—Ç—å JavaScript.</div>
        </noscript>
        <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
        <script>

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let socket;
        let currentLobby = null;
        let currentPlayer = null;
        let playerName = '';
        let playerAvatar = '';
        let webUserId = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
            let savedProfile = null;
            try {
                savedProfile = JSON.parse(localStorage.getItem('tic_profile'));
            } catch (e) { savedProfile = null; }

            if (savedProfile && savedProfile.user_id) {
                // –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                webUserId = savedProfile.user_id;
                playerName = savedProfile.name || '–ò–≥—Ä–æ–∫';
                playerAvatar = savedProfile.avatar || '';
                startApp();
            } else if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready(); // –°–æ–æ–±—â–∞–µ–º Telegram, —á—Ç–æ Mini-App –≥–æ—Ç–æ–≤–∞
                tg.expand(); // –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ


                // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –∏ –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                setTimeout(() => {
                    const user = tg.initDataUnsafe?.user;
                    if (user && user.id) {
                        webUserId = user.id;
                        playerName = user.first_name || user.username || '–ò–≥—Ä–æ–∫';
                        playerAvatar = '';
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –≤ localStorage
                        localStorage.setItem('tic_profile', JSON.stringify({ user_id: webUserId, name: playerName, avatar: playerAvatar }));
                        startApp();
                    } else {
                        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç
                        playerName = '–ì–æ—Å—Ç—å';
                        playerAvatar = '';
                        webUserId = null;
                        startApp();
                    }
                }, 500);
            } else {
                // –ù–µ –≤ Telegram, –¥–µ—Ñ–æ–ª—Ç
                playerName = '–ì–æ—Å—Ç—å';
                playerAvatar = '';
                webUserId = null;
                startApp();
            }
        });

        function startApp() {
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
            socket = io();

            socket.on('connect', () => {
              console.log('‚úÖ Socket.IO: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            });
            socket.on('connect_error', (err) => {
              console.error('‚õî Socket.IO: –æ—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è ‚Äî', err);
            });
            socket.on('disconnect', () => {
              console.log('‚õî Socket.IO: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ');
            });

            // –ï—Å–ª–∏ –µ—Å—Ç—å user_id, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
            if (webUserId && socket) {
                socket.emit('identify', { user_id: webUserId, name: playerName, avatar: playerAvatar });
            }

            // –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–æ—Ñ–∏–ª—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            if (!webUserId) {
                showAuthOverlay();
                // Fallback: –µ—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –ø—Ä–∏–¥—ë—Ç –∑–∞ 10 —Å–µ–∫—É–Ω–¥ ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
                setTimeout(() => {
                    if (document.getElementById('mainContainer').style.display === 'none') {
                        document.getElementById('authStatus').textContent = '‚õî –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
                        document.getElementById('authActionBtn').textContent = '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é';
                    }
                }, 10000);
            } else {
                hideAuthOverlay();
            }

            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏
            setupSocketListeners();
            setupEventListeners();
            getLobbies();
        }

        function setupSocketListeners() {
            socket.on('connect', () => {
            });

            socket.on('disconnect', () => {
            });


            socket.on('lobby_created', (data) => {
                currentLobby = data.lobby;
                currentPlayer = data.lobby.players[0];
                showLobbyRoom();
            });

            socket.on('update_lobby', (lobby) => {
                currentLobby = lobby;
                // –µ—Å–ª–∏ –≤ —Å–ø–∏—Å–∫–µ –∏–≥—Ä–æ–∫–æ–≤ –µ—Å—Ç—å –∑–∞–ø–∏—Å—å —Å –Ω–∞—à–∏–º sid ‚Äî –Ω–∞–∑–Ω–∞—á–∏–º currentPlayer
                try {
                    if (lobby.players && socket.id) {
                        const me = lobby.players.find(p => p.sid === socket.id);
                        if (me) {
                            currentPlayer = me;
                        }
                    }
                } catch (e) {}
                // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å waiting ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–Ω–∞—Ç—É –æ–∂–∏–¥–∞–Ω–∏—è, –µ—Å–ª–∏ playing ‚Äî –∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ
                if (lobby.status === 'waiting') {
                    showLobbyRoom();
                } else if (lobby.status === 'playing') {
                    showGameBoard();
                } else {
                    showLobbyList();
                }
            });
        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –æ–∂–∏–¥–∞–Ω–∏—è –ª–æ–±–±–∏
        function showLobbyRoom() {
            // –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ –∫–æ–º–Ω–∞—Ç–µ –ª–æ–±–±–∏
            document.getElementById('gameBoard').style.display = 'none';
            document.getElementById('lobbySection').style.display = 'none';
            document.querySelector('.main-menu').style.display = 'none';

            const lobbyRoom = document.getElementById('lobbyRoom');
            lobbyRoom.style.display = 'block';
            lobbyRoom.classList.add('fade-enter-active');

            renderLobbyRoom();
        }

        function renderPlayers() {
            if (!currentLobby || !currentLobby.players) return;

            const playersContainer = document.getElementById('playersDisplay');
            playersContainer.innerHTML = '';

            currentLobby.players.forEach(player => {
                const playerEl = document.createElement('div');
                playerEl.className = `player-display ${player.symbol === currentLobby.current_player ? 'active' : ''}`;
                playerEl.innerHTML = `
                    <img src="${player.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(player.name)}&background=5865f2&color=ffffff&size=128`}" alt="${player.name}" class="player-display-avatar-img" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(player.name)}&background=5865f2&color=ffffff&size=128';">
                    <div class="player-display-info">
                        <p class="player-display-name">${player.name}</p>
                        <p class="player-display-symbol">–ò–≥—Ä–æ–∫ ${player.symbol}</p>
                    </div>
                `;
                playersContainer.appendChild(playerEl);
            });

            // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É –∏–≥—Ä–æ–∫–∞–º–∏
            if (currentLobby.players.length === 2) {
                const divider = document.createElement('div');
                divider.className = 'vs-divider';
                divider.innerHTML = 'VS';
                playersContainer.appendChild(divider);
            }
        }

        function renderLobbyRoom() {
            if (!currentLobby) return;

            // –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
            const list = document.getElementById('lobbyPlayersList');
            list.innerHTML = '';

            currentLobby.players.forEach((p, idx) => {
                const div = document.createElement('div');
                div.className = 'lobby-player';
                div.innerHTML = `
                    <img src="${p.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}&background=5865f2&color=ffffff&size=96`}" alt="${p.name}" class="lobby-player-avatar-img" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}&background=5865f2&color=ffffff&size=96';">
                    <div class="lobby-player-info">
                        <h3>${p.name} ${idx === 0 ? '<span style="color: var(--discord-primary); font-size: 0.85em;">(—Å–æ–∑–¥–∞—Ç–µ–ª—å)</span>' : ''}</h3>
                        <span class="symbol">–ò–≥—Ä–æ–∫ ${p.symbol}</span>
                    </div>
                `;
                list.appendChild(div);
            });

            // –ü—É—Å—Ç—ã–µ –º–µ—Å—Ç–∞ –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            for (let i = currentLobby.players.length; i < 2; i++) {
                const div = document.createElement('div');
                div.className = 'lobby-player';
                div.innerHTML = `
                    <div class="lobby-player-avatar" style="background: var(--text-muted);">?</div>
                    <div class="lobby-player-info">
                        <h3 style="color: var(--text-muted); font-style: italic;">–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞</h3>
                        <span class="symbol" style="color: var(--text-muted);">–°–≤–æ–±–æ–¥–Ω–æ</span>
                    </div>
                `;
                list.appendChild(div);
            }

            // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            const btns = document.getElementById('lobbyRoomBtns');
            btns.innerHTML = '';

            let isOwner = false;
            if (currentLobby && currentPlayer && currentLobby.players && currentLobby.players.length > 0) {
                isOwner = currentLobby.players[0].user_id === currentPlayer.user_id;
            }

            if (isOwner) {
                if (currentLobby.players.length === 2) {
                    btns.innerHTML += `
                        <button class="game-btn primary" onclick="startGame()">
                            <i class="fas fa-play"></i>
                            –ù–∞—á–∞—Ç—å –∏–≥—Ä—É
                        </button>
                    `;
                }
                btns.innerHTML += `
                    <button class="game-btn danger" onclick="dissolveLobby()">
                        <i class="fas fa-trash"></i>
                        –†–∞—Å–ø—É—Å—Ç–∏—Ç—å –ª–æ–±–±–∏
                    </button>
                `;
            } else {
                btns.innerHTML += `
                    <button class="game-btn secondary" onclick="leaveLobby()">
                        <i class="fas fa-sign-out-alt"></i>
                        –ü–æ–∫–∏–Ω—É—Ç—å –ª–æ–±–±–∏
                    </button>
                `;
            }
        }

        function startGame() {
            if (currentLobby) {
                socket.emit('start_game', { lobby_id: currentLobby.id });
            }
        }

        function dissolveLobby() {
            if (currentLobby && socket) {
                socket.emit('dissolve_lobby', { lobby_id: currentLobby.id });
                currentLobby = null;
                currentPlayer = null;
                showLobbyList();
            }
        }

        function startGame() {
            if (currentLobby && socket) {
                socket.emit('start_game', { lobby_id: currentLobby.id });
            }
        }

            socket.on('lobbies_list', (lobbies) => {
                renderLobbyList(lobbies);
            });

            // –ö–æ–≥–¥–∞ –±–µ–∫ –≤–µ—Ä–Ω—É–ª –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ Telegram (–≤–∫–ª—é—á–∞—è —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–æ—Ç–æ)
            socket.on('telegram_profile', (profile) => {
                try {
                    if (profile && profile.name) playerName = profile.name;
                    if (profile && profile.avatar) playerAvatar = profile.avatar;
                    if (profile && profile.user_id) webUserId = profile.user_id;
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –≤ localStorage
                    localStorage.setItem('tic_profile', JSON.stringify({ user_id: webUserId, name: playerName, avatar: playerAvatar }));
                    // –µ—Å–ª–∏ —É–∂–µ –≤ –ª–æ–±–±–∏ ‚Äî –æ–±–Ω–æ–≤–∏–º
                    if (currentLobby) {
                        socket.emit('get_lobbies');
                    }
                    // –£–±–∏—Ä–∞–µ–º –æ–≤–µ—Ä–ª–µ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    hideAuthOverlay();
                } catch (e) { }
            });

            socket.on('error', (data) => {
                alert(data.message);
            });
        }

        function setupEventListeners() {
            // –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
            document.getElementById('createLobbyBtn').addEventListener('click', createLobby);
            document.getElementById('refreshProfileBtn').addEventListener('click', refreshProfile);
            document.getElementById('authorizeBtn').addEventListener('click', authorizeWithBot);

            // –ö–Ω–æ–ø–∫–∏ –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è
            document.getElementById('leaveGameBtn').addEventListener('click', leaveLobby);
            document.getElementById('newGameBtn').addEventListener('click', resetGame);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –∏–≥—Ä–æ–≤—ã–º –∫–ª–µ—Ç–∫–∞–º
            document.querySelectorAll('.game-cell').forEach((cell, index) => {
                cell.addEventListener('click', () => makeMove(index));
                cell.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('taken')) {
                        this.style.transform = 'scale(1.05)';
                    }
                });
                cell.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('taken')) {
                        this.style.transform = '';
                    }
                });
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('winModal');
                    if (modal.style.display === 'flex') {
                        hideWinModal();
                    }
                }
            });
        }

        async function authorizeWithBot() {
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É –±–µ–∫–µ–Ω–¥–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            try {
                const body = { sid: socket.id };
                const resp = await fetch('/auth_code', { method: 'POST', body: JSON.stringify(body), headers: { 'Content-Type': 'application/json' } });
                const data = await resp.json();
                if (data && data.code) {
                    const code = data.code;
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ –∫–æ–¥ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
                    console.log('auth code:', code);

                    // –§–æ—Ä–º–∏—Ä—É–µ–º deeplink –Ω–∞ –±–æ—Ç–∞ —Å payload auth:<code>
                    const botUsername = 'hesusinsidemegabot';
                    const link = `https://t.me/${botUsername}?start=auth:${encodeURIComponent(code)}`;

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–¥ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è —Ä—É—á–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    document.getElementById('authStatus').innerHTML =
                        `<b>1.</b> <a href="${link}" target="_blank" style="color:#5865f2;">–û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram</a><br>` +
                        `<b>2.</b> –ï—Å–ª–∏ –±–æ—Ç –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, <b>–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–º–∞–Ω–¥—É –Ω–∏–∂–µ</b> —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –µ—ë, –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É:<br>` +
                        `<div id="copyAuthCode" style="margin:8px 0;padding:6px 10px;background:#40444b;border:1px solid #202225;border-radius:8px;font-size:1.08em;word-break:break-all;cursor:pointer;user-select:all;transition:background 0.2s;color:#dcddde;">/start auth:${code}</div>` +
                        `<span id="copyHint" style="display:none;color:#5865f2;font-size:0.97em;">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!</span>` +
                        `<span style="color:#b9bbbe;font-size:0.98em;display:block;margin-top:4px;">–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ Mini‚ÄëApp ‚Äî –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</span>`;
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
                    setTimeout(() => {
                        const copyDiv = document.getElementById('copyAuthCode');
                        if (copyDiv) {
                            copyDiv.onclick = function() {
                                const text = copyDiv.textContent;
                                if (navigator.clipboard) {
                                    navigator.clipboard.writeText(text);
                                } else {
                                    // fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                                    const textarea = document.createElement('textarea');
                                    textarea.value = text;
                                    document.body.appendChild(textarea);
                                    textarea.select();
                                    document.execCommand('copy');
                                    document.body.removeChild(textarea);
                                }
                                const hint = document.getElementById('copyHint');
                                if (hint) {
                                    hint.style.display = 'inline';
                                    setTimeout(()=>{hint.style.display='none';}, 1200);
                                }
                                copyDiv.style.background = '#5865f2';
                                setTimeout(()=>{copyDiv.style.background='#40444b';}, 600);
                            };
                        }
                    }, 100);
                } else {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                }
            } catch (e) {
                console.error('auth error', e);
                alert('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É.');
            }
        }

        function showAuthOverlay() {
            const ov = document.getElementById('authOverlay');
            ov.style.display = 'flex';
            document.getElementById('mainContainer').style.display = 'none';
            // bind default action
            document.getElementById('authActionBtn').onclick = authorizeWithBot;
        }

        function hideAuthOverlay() {
            const ov = document.getElementById('authOverlay');
            ov.style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
        }

        function createLobby() {
            if (socket) {
                const name = '–õ–æ–±–±–∏';
                socket.emit('create_lobby', { name: name, player_name: playerName, player_avatar: playerAvatar, user_id: webUserId });
            }
        }

        function refreshProfile() {
            if (window.Telegram && window.Telegram.WebApp && socket) {
                const tg = window.Telegram.WebApp;
                const user = (tg.initDataUnsafe && tg.initDataUnsafe.user) || null;
                if (user && user.id) {
                    webUserId = user.id;
                    playerName = user.first_name || user.username || '–ì–æ—Å—Ç—å';
                    playerAvatar = '';
                    socket.emit('identify', { user_id: user.id, name: playerName, avatar: '' });
                }
            }
        }

        function joinLobby(lobbyId) {
            if (socket) {
                socket.emit('join_lobby', { lobby_id: lobbyId, player_name: playerName, player_avatar: playerAvatar, user_id: webUserId });
                // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º UI —Å—Ä–∞–∑—É ‚Äî —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏—à–ª—ë—Ç update_lobby —á—Ç–æ–±—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                showGameBoard();
            }
        }

        function leaveLobby() {
            if (currentLobby && socket) {
                socket.emit('leave_lobby', { lobby_id: currentLobby.id });
                currentLobby = null;
                currentPlayer = null;
                showLobbyList();
            }
        }

        function makeMove(position) {
            if (currentLobby && currentPlayer && currentLobby.current_player === currentPlayer.symbol && socket) {
                socket.emit('make_move', { lobby_id: currentLobby.id, position: position });
            }
        }

        function resetGame() {
            // –°–±—Ä–æ—Å –∏–≥—Ä—ã - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É
            if (currentLobby) {
                currentLobby.board = ['', '', '', '', '', '', '', '', ''];
                currentLobby.status = 'playing';
                currentLobby.current_player = 'X';
                // –£–±–∏—Ä–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ–±–µ–¥—ã —Å–æ –≤—Å–µ—Ö –∫–ª–µ—Ç–æ–∫
                document.querySelectorAll('.game-cell').forEach(cell => {
                    cell.classList.remove('win');
                });
                updateGameDisplay();
            }
        }

        function getLobbies() {
            if (socket) {
                socket.emit('get_lobbies');
            }
        }

        function renderLobbyList(lobbies) {
            const lobbyList = document.getElementById('lobbyList');
            lobbyList.innerHTML = '';

            if (lobbies.length === 0) {
                lobbyList.innerHTML = `
                    <div style="text-align: center; color: var(--text-muted); padding: 40px 20px;">
                        <i class="fas fa-gamepad" style="font-size: 3rem; margin-bottom: 16px; opacity: 0.5;"></i>
                        <p style="margin: 0; font-size: 1.1rem;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä</p>
                        <p style="margin: 8px 0 0 0; font-size: 0.9rem;">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∏–≥—Ä—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!</p>
                    </div>
                `;
                return;
            }

            lobbies.forEach(lobby => {
                const lobbyCard = document.createElement('div');
                lobbyCard.className = 'lobby-card';
                lobbyCard.innerHTML = `
                    <div class="lobby-header">
                        <h3 class="lobby-name">${lobby.name}</h3>
                        <span class="lobby-status ${lobby.status}">${getStatusText(lobby.status)}</span>
                    </div>
                    <div class="lobby-players">
                        ${lobby.players.map(p => `
                            <div class="player-info">
                                <img src="${p.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}&background=5865f2&color=ffffff&size=64`}" alt="${p.name}" class="player-avatar-img" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}&background=5865f2&color=ffffff&size=64';">
                                <div class="player-details">
                                    <div class="player-name">${p.name}</div>
                                    <div class="player-symbol">–ò–≥—Ä–æ–∫ ${p.symbol}</div>
                                </div>
                            </div>
                        `).join('')}
                        ${lobby.players.length < 2 ? '<div class="empty-slot">–°–≤–æ–±–æ–¥–Ω–æ</div>' : ''}
                    </div>
                    <div class="lobby-actions">
                        <button class="action-btn join-btn" data-id="${lobby.id}">
                            <i class="fas fa-sign-in-alt"></i> –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                        </button>
                        <button class="action-btn info-btn" data-id="${lobby.id}">
                            <i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ
                        </button>
                    </div>
                `;

                lobbyList.appendChild(lobbyCard);
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.querySelectorAll('.join-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const lobbyId = this.getAttribute('data-id');
                    joinLobby(lobbyId);
                });
            });

            document.querySelectorAll('.info-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const lobbyId = this.getAttribute('data-id');
                    const lobby = lobbies.find(l => l.id === lobbyId);
                    if (lobby) {
                        showLobbyInfo(lobby);
                    }
                });
            });
        }

        function showLobbyInfo(lobby) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-icon">‚ÑπÔ∏è</div>
                    <h2 class="modal-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–æ–±–±–∏</h2>
                    <p class="modal-description">
                        <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${lobby.name}<br>
                        <strong>–ò–≥—Ä–æ–∫–∏:</strong> ${lobby.players.map(p => p.name + ' (' + p.symbol + ')').join(', ')}<br>
                        <strong>–°—Ç–∞—Ç—É—Å:</strong> ${getStatusText(lobby.status)}<br>
                        <strong>–°–æ–∑–¥–∞–Ω–æ:</strong> –¢–æ–ª—å–∫–æ —á—Ç–æ
                    </p>
                    <div class="modal-buttons">
                        <button class="game-btn primary" onclick="this.closest('.modal-overlay').remove()">–ü–æ–Ω—è—Ç–Ω–æ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª–∫–∏
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function getStatusText(status) {
            switch(status) {
                case 'waiting': return '–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞';
                case 'playing': return '–ò–≥—Ä–∞ –∏–¥–µ—Ç';
                case 'finished': return '–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
                default: return status;
            }
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∏–≥—Ä—ã
        function updateGameStatus() {
            if (!currentLobby) return;

            const statusText = document.querySelector('.game-status-text');
            const statusIndicator = document.getElementById('gameStatusIndicator');

            switch(currentLobby.status) {
                case 'playing':
                    if (currentPlayer) {
                        const isMyTurn = currentLobby.current_player === currentPlayer.symbol;
                        statusText.textContent = isMyTurn ? '–í–∞—à —Ö–æ–¥' : '–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞';
                        statusIndicator.textContent = isMyTurn ? `–ò–≥—Ä–∞–π—Ç–µ –∫–∞–∫ –∏–≥—Ä–æ–∫ ${currentPlayer.symbol}` : '–û–∂–∏–¥–∞–Ω–∏–µ —Ö–æ–¥–∞ –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞';
                        statusIndicator.className = `game-status-indicator ${isMyTurn ? 'your-turn' : 'waiting'}`;
                    }
                    break;
                case 'waiting':
                    statusText.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞';
                    statusIndicator.textContent = '–î–æ–∂–¥–∏—Ç–µ—Å—å –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞';
                    statusIndicator.className = 'game-status-indicator waiting';
                    break;
                case 'finished':
                    statusText.textContent = '–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
                    if (currentLobby.winner === 'draw') {
                        statusIndicator.textContent = '–ù–∏—á—å—è!';
                    } else {
                        const winner = currentLobby.players.find(p => p.symbol === currentLobby.winner);
                        statusIndicator.textContent = `–ü–æ–±–µ–¥–∏–ª ${winner ? winner.name : currentLobby.winner}!`;
                    }
                    statusIndicator.className = 'game-status-indicator';
                    break;
            }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —ç–∫—Ä–∞–Ω–∞–º–∏
        function switchToScreen(screenId) {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã
            document.querySelectorAll('.app-content > div').forEach(div => {
                if (div.id !== screenId && div.style.display !== 'none') {
                    div.classList.remove('fade-enter-active');
                    div.classList.add('fade-exit');
                }
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–ª–µ–≤–æ–π —ç–∫—Ä–∞–Ω
            setTimeout(() => {
                const targetScreen = document.getElementById(screenId);
                targetScreen.style.display = 'block';
                targetScreen.classList.add('fade-enter-active');
            }, 150);
        }

        function showGameBoard() {
            // –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ –∏–≥—Ä–æ–≤–æ–º—É –ø–æ–ª—é
            document.getElementById('lobbySection').style.display = 'none';
            document.querySelector('.main-menu').style.display = 'none';
            document.getElementById('lobbyRoom').style.display = 'none';

            const gameBoard = document.getElementById('gameBoard');
            gameBoard.style.display = 'block';
            gameBoard.classList.add('fade-enter-active');

            updateGameDisplay();
        }

        function showLobbyList() {
            // –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ø–∏—Å–∫—É –ª–æ–±–±–∏
            document.getElementById('gameBoard').style.display = 'none';
            document.getElementById('lobbyRoom').style.display = 'none';

            const lobbySection = document.getElementById('lobbySection');
            const mainMenu = document.querySelector('.main-menu');

            lobbySection.style.display = 'block';
            mainMenu.style.display = 'block';

            lobbySection.classList.add('fade-enter-active');
            mainMenu.classList.add('fade-enter-active');

            getLobbies();
        }


        function updateGameDisplay() {
            if (!currentLobby) return;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ
            currentLobby.board.forEach((cell, index) => {
                const cellElement = document.querySelector(`[data-index="${index}"]`);
                cellElement.textContent = cell;
                cellElement.className = 'game-cell';
                if (cell) {
                    cellElement.classList.add(cell.toLowerCase());
                    cellElement.classList.add('taken');
                }
            });

            // –†–µ–Ω–¥–µ—Ä–∏–º –∏–≥—Ä–æ–∫–æ–≤ –∏ —Å—Ç–∞—Ç—É—Å
            renderPlayers();

            const statusIndicator = document.getElementById('gameStatusIndicator');
            const statusText = document.querySelector('.game-status-text');

            if (currentPlayer) {
                const isMyTurn = currentLobby.status === 'playing' && currentLobby.current_player === currentPlayer.symbol;
                statusText.textContent = isMyTurn ? '–í–∞—à —Ö–æ–¥' : '–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞';
                statusIndicator.textContent = isMyTurn ? `–ò–≥—Ä–∞–π—Ç–µ –∫–∞–∫ ${currentPlayer.symbol}` : '–û–∂–∏–¥–∞–Ω–∏–µ —Ö–æ–¥–∞';
                statusIndicator.className = `game-status-indicator ${isMyTurn ? 'your-turn' : 'waiting'}`;
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã
            if (currentLobby.status === 'finished') {
                setTimeout(() => {
                    highlightWinningCells();
                    showGameResult();
                }, 200);
            }
        }

        function showGameResult() {
            if (!currentLobby) return;

            let winnerName = '';
            let isDraw = false;
            let icon = 'üéâ';

            if (currentLobby.winner === 'draw') {
                winnerName = '–ù–∏—á—å—è!';
                isDraw = true;
                icon = 'ü§ù';
            } else {
                const winner = currentLobby.players.find(p => p.symbol === currentLobby.winner);
                winnerName = winner ? `–ü–æ–±–µ–¥–∏–ª ${winner.name}!` : `–ü–æ–±–µ–¥–∏–ª ${currentLobby.winner}!`;
                icon = 'üéâ';
            }

            showWinModal(winnerName, isDraw, icon);
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–ª–µ—Ç–∫–∞–º
        function makeMove(position) {
            if (currentLobby && currentPlayer && currentLobby.current_player === currentPlayer.symbol) {
                // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
                const cell = document.querySelector(`[data-index="${position}"]`);
                if (!cell.classList.contains('taken')) {
                    cell.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        cell.style.transform = '';
                    }, 150);

                    socket.emit('make_move', { lobby_id: currentLobby.id, position: position });
                }
            }
        }
        // –£–ª—É—á—à–µ–Ω–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–±–µ–¥—ã
        function showWinModal(winnerText, isDraw, icon = 'üéâ') {
            const modal = document.getElementById('winModal');
            const modalIcon = document.getElementById('winModalAnim');
            const modalTitle = document.getElementById('winModalText');
            const modalDescription = document.querySelector('#winModal .modal-description');
            const modalBtns = document.getElementById('winModalBtns');

            modal.style.display = 'flex';
            modalIcon.textContent = icon;
            modalTitle.textContent = winnerText;
            modalDescription.textContent = isDraw ? '–û—Ç–ª–∏—á–Ω–∞—è –∏–≥—Ä–∞! –ù–∏–∫—Ç–æ –Ω–µ –ø–æ–±–µ–¥–∏–ª.' : '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø–æ–±–µ–¥–æ–π!';

            modalBtns.innerHTML = '';

            let isOwner = false;
            if (currentLobby && currentPlayer && currentLobby.players && currentLobby.players.length > 0) {
                isOwner = currentLobby.players[0].user_id === currentPlayer.user_id;
            }

            if (isOwner) {
                modalBtns.innerHTML = `
                    <button class="game-btn danger" onclick="hideWinModal(); leaveLobby();">
                        <i class="fas fa-times"></i>
                        –ó–∞–≤–µ—Ä—à–∏—Ç—å
                    </button>
                    <button class="game-btn primary" onclick="hideWinModal(); resetGame();">
                        <i class="fas fa-redo"></i>
                        –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                `;
            } else {
                modalBtns.innerHTML = `
                    <button class="game-btn primary" onclick="hideWinModal(); leaveLobby();">
                        <i class="fas fa-check"></i>
                        –ü–æ–Ω—è—Ç–Ω–æ
                    </button>
                `;
            }
        }

        function hideWinModal() {
            const modal = document.getElementById('winModal');
            modal.style.display = 'none';
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function showAuthOverlay() {
            const overlay = document.getElementById('authOverlay');
            const mainContent = document.querySelector('.app-container');

            mainContent.style.filter = 'blur(4px)';
            mainContent.style.pointerEvents = 'none';
            overlay.style.display = 'flex';

            // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è
            setTimeout(() => {
                overlay.style.opacity = '1';
            }, 10);
        }

        function hideAuthOverlay() {
            const overlay = document.getElementById('authOverlay');
            const mainContent = document.querySelector('.app-container');

            mainContent.style.filter = '';
            mainContent.style.pointerEvents = '';
            overlay.style.display = 'none';
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–Ω—ã—Ö –∫–ª–µ—Ç–æ–∫
        function highlightWinningCells() {
            if (!currentLobby || currentLobby.status !== 'finished') return;

            const board = currentLobby.board;
            const currentSymbol = currentLobby.winner;

            if (!currentSymbol || currentSymbol === 'draw') return;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–±–µ–¥–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
            const winningConditions = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
                [0, 4, 8], [2, 4, 6] // Diagonals
            ];

            // –ù–∞—Ö–æ–¥–∏–º –∏ –≤—ã–¥–µ–ª—è–µ–º –ø–æ–±–µ–¥–Ω—É—é –∫–æ–º–±–∏–Ω–∞—Ü–∏—é
            winningConditions.forEach((condition, comboIndex) => {
                const [a, b, c] = condition;
                if (board[a] === currentSymbol && board[b] === currentSymbol && board[c] === currentSymbol) {
                    // –í—ã–¥–µ–ª—è–µ–º –ø–æ–±–µ–¥–Ω—ã–µ –∫–ª–µ—Ç–∫–∏ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞
                    setTimeout(() => {
                        document.querySelector(`[data-index="${a}"]`).classList.add('win');
                    }, comboIndex * 100);

                    setTimeout(() => {
                        document.querySelector(`[data-index="${b}"]`).classList.add('win');
                    }, comboIndex * 100 + 50);

                    setTimeout(() => {
                        document.querySelector(`[data-index="${c}"]`).classList.add('win');
                    }, comboIndex * 100 + 100);
                }
            });
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ –∏–≥—Ä—ã
        function resetGame() {
            if (currentLobby) {
                // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–Ω—ã—Ö –∫–ª–µ—Ç–æ–∫ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                const winningCells = document.querySelectorAll('.game-cell.win');
                winningCells.forEach((cell, index) => {
                    setTimeout(() => {
                        cell.classList.remove('win');
                    }, index * 50);
                });

                // –°–±—Ä–æ—Å –∏–≥—Ä–æ–≤–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                setTimeout(() => {
                    currentLobby.board = ['', '', '', '', '', '', '', '', ''];
                    currentLobby.status = 'playing';
                    currentLobby.current_player = 'X';
                    updateGameDisplay();
                }, 300);
            }
        }

            // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –≤ HTML
            function escapeHTML(s) {
                return String(s).replace(/[&<>"']/g, function (c) {
                    return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c];
                });
            }

            // –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä —Å—Ç–∞—Ç—É—Å–∞/–∏–≥—Ä–æ–∫–æ–≤
            function renderStatusAndPlayers(lobby) {
                const statusEl = document.getElementById('statusMessage');
                if (!lobby || !lobby.players) { statusEl.innerHTML = ''; return; }

                const playersHtml = lobby.players.map(p => {
                    const avatar = p.avatar ? escapeHTML(p.avatar) : `https://ui-avatars.com/api/?name=${encodeURIComponent(escapeHTML(p.name))}`;
                    // –ï—Å–ª–∏ –Ω–∏–∫ –¥–ª–∏–Ω–Ω–µ–µ 10 —Å–∏–º–≤–æ–ª–æ–≤ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å marquee
                    const isLong = p.name && p.name.length > 10;
                    return `
                        <div class="player-small">
                            <img src="${avatar}" alt="avatar">
                            <div style="display:flex;flex-direction:column;">
                                <span class="name${isLong ? ' marquee' : ''}">${escapeHTML(p.name)}</span>
                                <span class="symbol">(${escapeHTML(p.symbol)})</span>
                            </div>
                        </div>
                    `;
                }).join('<span class="vs-sep">vs</span>');

                let statusText = '';
                if (lobby.status === 'playing') statusText = `–ò–≥—Ä–∞ –∏–¥–µ—Ç | –•–æ–¥ ${escapeHTML(lobby.current_player)}`;
                else if (lobby.status === 'waiting') statusText = '–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞';
                else if (lobby.status === 'finished') statusText = lobby.winner === 'draw' ? '–ù–∏—á—å—è' : `–ü–æ–±–µ–¥–∏–ª ${escapeHTML(lobby.winner)}`;

                statusEl.innerHTML = `<div class="players-row">${playersHtml}</div><div class="status-line">${statusText}</div>`;
            }
    </script>
</body>
</html>