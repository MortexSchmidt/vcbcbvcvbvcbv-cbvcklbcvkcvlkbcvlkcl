<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏ Mini‚ÄëApp</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { margin:0; font-family:'Segoe UI',Arial,sans-serif; background:#f7faff; color:#222; }
        .container { max-width:520px; margin:0 auto; padding:24px; }
        .header { background:#eaf2ff; padding:18px; border-radius:14px; margin-bottom:18px; text-align:center; }
        .header h1 { margin:0; font-size:1.7rem; letter-spacing:0.01em; color:#1a2a3a; }
        .create-lobby { display:flex; gap:10px; margin-bottom:18px; }
        .btn { border:none; border-radius:8px; padding:10px 16px; font-size:1.05rem; cursor:pointer; transition:background 0.18s; font-weight:500; }
        .btn-primary { background:#1976d2; color:#fff; }
        .btn-primary:hover { background:#1256a6; }
        .btn-secondary { background:#e3eaff; color:#1a2a3a; }
        .btn-secondary:hover { background:#cfe6ff; }
        .btn-accent { background:#fffbe6; color:#bfa100; border:1px solid #ffe066; }
        .btn-accent:hover { background:#fff3bf; }
        .lobby-list { display:grid; gap:14px; margin-bottom:18px; }
        .lobby-card { background:#fff; border-radius:10px; box-shadow:0 2px 8px 0 rgba(0,0,0,0.04); padding:14px 16px; display:flex; flex-direction:row; align-items:center; justify-content:space-between; }
        .lobby-info { display:flex; flex-direction:column; gap:4px; }
        .lobby-players { display:flex; gap:8px; align-items:center; }
        .player { display:flex; align-items:center; gap:6px; }
        .player img { width:24px; height:24px; border-radius:50%; object-fit:cover; }
        .player.empty { color:#aaa; font-style:italic; }
        .lobby-status { font-size:0.97rem; color:#1976d2; }
        .lobby-actions { display:flex; gap:8px; }
        .lobby-actions .btn { flex:1; }
        .game-board { background:#fff; border-radius:12px; box-shadow:0 2px 8px 0 rgba(0,0,0,0.04); padding:18px; margin-bottom:18px; }
        .board-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; max-width:420px; margin:0 auto 12px auto; }
        .cell { background:#eaf2ff; border-radius:8px; min-height:64px; font-size:2.1rem; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:background 0.15s; }
        .cell.x { color:#1976d2; }
        .cell.o { color:#bfa100; }
        .cell:hover { background:#cfe6ff; }
        .game-info { display:flex; flex-direction:row; align-items:center; justify-content:space-between; margin-bottom:10px; }
        .current-player { font-size:1.1rem; font-weight:500; }
        .status-message { font-size:0.97rem; color:#1976d2; }
        .players-row {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 18px;
            margin-bottom: 6px;
            max-width: 100%;
            flex-wrap: wrap;
            overflow-x: hidden;
        }
        .player-small {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f7faff;
            border-radius: 8px;
            padding: 4px 10px 4px 4px;
            box-shadow: 0 1px 4px 0 rgba(0,0,0,0.03);
            min-width: 0;
            max-width: 140px;
            overflow: hidden;
        }
        .player-small img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
        }
        .player-small .name {
            font-weight: 500;
            font-size: 1.01em;
            color: #1a2a3a;
            white-space: nowrap;
            overflow: hidden;
            max-width: 90px;
            display: inline-block;
            position: relative;
            /* –î–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ */
        }
        .player-small .name.marquee {
            animation: marquee-x 3.5s linear infinite alternate;
        }
        @keyframes marquee-x {
            0% { transform: translateX(0); }
            90% { transform: translateX(calc(-100% + 90px)); }
            100% { transform: translateX(calc(-100% + 90px)); }
        }
        .player-small .symbol {
            color: #1976d2;
            font-size: 1em;
            margin-left: 2px;
        }
        .vs-sep {
            color: #bfa100;
            font-size: 1.2em;
            margin: 0 8px;
        }
        @media (max-width:720px) {
            .container { padding:12px; }
            .header { padding:12px; border-radius:10px; }
            .create-lobby { flex-direction:column; align-items:stretch; gap:8px; }
            .create-lobby .btn { width:100%; }
            .lobby-card { flex-direction:column; align-items:flex-start; gap:10px; }
            .lobby-info { width:100%; justify-content:space-between; }
            .lobby-actions { width:100%; display:flex; gap:8px; }
            .lobby-actions .btn { flex:1; }
            .board-grid { width:100%; max-width:420px; grid-auto-rows: calc((100vw - 48px) / 3); }
            .cell { height: auto; min-height: calc((100vw - 48px) / 3); font-size: calc(1.6rem + (100vw - 320px) / 300); }
            .game-board { padding:14px; }
            .status-message { font-size:0.95rem; }
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer" style="display:none;">
        <!-- –≠–∫—Ä–∞–Ω –æ–∂–∏–¥–∞–Ω–∏—è –ª–æ–±–±–∏ -->
        <div id="lobbyRoom" style="display:none;">
            <div class="header"><h2>–õ–æ–±–±–∏</h2></div>
            <div id="lobbyPlayersList" style="margin-bottom:18px;"></div>
            <div id="lobbyRoomBtns" style="display:flex;gap:12px;justify-content:center;"></div>
        </div>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–±–µ–¥—ã -->
    <div id="winModal" style="display:none;position:fixed;inset:0;z-index:2000;background:rgba(30,40,60,0.32);align-items:center;justify-content:center;">
        <div id="winModalBox" style="background:#fff;max-width:340px;width:92%;border-radius:16px;box-shadow:0 6px 32px 0 #0002;padding:32px 18px 24px 18px;text-align:center;animation:popWin .5s cubic-bezier(.23,1.12,.62,1.01);position:relative;">
            <div id="winModalAnim" style="font-size:2.5rem;margin-bottom:12px;">üéâ</div>
            <div id="winModalText" style="font-size:1.25rem;font-weight:600;margin-bottom:18px;">–ü–æ–±–µ–¥–∞!</div>
            <div id="winModalBtns" style="display:flex;gap:12px;justify-content:center;"></div>
        </div>
        <style>
        @keyframes popWin {
            0% { transform: scale(0.7); opacity: 0; }
            60% { transform: scale(1.08); opacity: 1; }
            100% { transform: scale(1); }
        }
        </style>
    </div>
        <div class="header">
            <h1>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</h1>
        </div>

        <div class="create-lobby">
            <button class="btn btn-primary" id="createLobbyBtn">
                <i class="fas fa-plus" aria-hidden="true"></i>
                <span>–°–æ–∑–¥–∞—Ç—å –ª–æ–±–±–∏</span>
            </button>
            <button class="btn btn-secondary" id="refreshProfileBtn">
                <i class="fas fa-sync-alt" aria-hidden="true"></i>
                <span>–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</span>
            </button>
            <button class="btn btn-accent" id="authorizeBtn">
                <i class="fas fa-user-check" aria-hidden="true"></i>
                <span>–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ –±–æ—Ç–µ</span>
            </button>
        </div>

        <div class="lobby-list" id="lobbyList">
            <!-- –õ–æ–±–±–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>

        <div class="game-board" id="gameBoard">
            <div class="game-info">
                <div class="current-player">
                    <span id="currentPlayer" class="player-turn">–¢–≤–æ–π —Ö–æ–¥!</span>
                </div>
                <div class="status-message status-playing" id="statusMessage">
                    –ò–≥—Ä–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...
                </div>
            </div>
            
            <div class="board-grid" id="boardGrid">
                <div class="cell" data-index="0"></div>
                <div class="cell" data-index="1"></div>
                <div class="cell" data-index="2"></div>
                <div class="cell" data-index="3"></div>
                <div class="cell" data-index="4"></div>
                <div class="cell" data-index="5"></div>
                <div class="cell" data-index="6"></div>
                <div class="cell" data-index="7"></div>
                <div class="cell" data-index="8"></div>
            </div>
            
            <div class="game-actions">
                <button class="btn btn-secondary" id="leaveGameBtn">
                    –ü–æ–∫–∏–Ω—É—Ç—å
                </button>
                <button class="btn btn-primary" id="newGameBtn">
                    –ù–æ–≤–∞—è
                </button>
            </div>
        </div>
    </div>
    <!-- –û–≤–µ—Ä–ª–µ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚Äî –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø –ø–æ–∫–∞ –Ω–µ –ø—Ä–∏–¥—ë—Ç –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ –±–æ—Ç–∞ -->
    <div id="authOverlay" style="display:none;position:fixed;inset:0;z-index:1000;align-items:center;justify-content:center;pointer-events:auto;">
        <div style="max-width:340px;width:92%;background:rgba(255,255,255,0.97);box-shadow:0 2px 16px 0 rgba(0,0,0,0.10);padding:22px 18px 18px 18px;border-radius:14px;text-align:center;backdrop-filter:blur(2px);border:1.5px solid #e3eaff;animation:fadeIn .3s;">
            <h2 style="margin:0 0 8px 0;font-size:1.25rem;color:#1a2a3a;font-weight:700;letter-spacing:0.01em;">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
            <p style="margin:0 0 14px 0;color:#3a4a5a;font-size:1.01rem;">–î–ª—è –∏–≥—Ä—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞.<br>–≠—Ç–æ –∑–∞–π–º—ë—Ç 5 —Å–µ–∫—É–Ω–¥.</p>
            <button id="authActionBtn" class="btn btn-primary" style="font-size:1.07rem;padding:10px 18px;margin-bottom:8px;">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞</button>
            <div id="authStatus" style="margin-top:8px;color:#6a7a8a;font-size:0.97rem;">–û–∂–∏–¥–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏‚Ä¶</div>
        </div>
        <style>
        #authOverlay {
            background: rgba(240,245,255,0.82);
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.25s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        </style>
    </div>

    <div id="debugStatus" style="display:none;padding:10px 0 0 0;text-align:center;color:#b00;font-size:1.05rem;"></div>

        <noscript>
            <div style="padding:32px;text-align:center;color:#b00;font-size:1.2rem;">–î–ª—è —Ä–∞–±–æ—Ç—ã Mini‚ÄëApp —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–∫–ª—é—á–∏—Ç—å JavaScript.</div>
        </noscript>
        <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
        <script>
        // Fallback: –µ—Å–ª–∏ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –Ω–∏ mainContainer, –Ω–∏ authOverlay –Ω–µ –≤–∏–¥–Ω—ã ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        setTimeout(() => {
          const main = document.getElementById('mainContainer');
          const auth = document.getElementById('authOverlay');
          if (main && auth && main.style.display === 'none' && auth.style.display === 'none') {
            document.body.innerHTML = '<div style="padding:32px;text-align:center;color:#b00;font-size:1.2rem;">‚õî –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Mini‚ÄëApp.<br>–í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –∏–ª–∏ Telegram.<br>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–∑–∂–µ.</div>';
          }
        }, 2000);

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let socket;
        let currentLobby = null;
        let currentPlayer = null;
        let playerName = '';
        let playerAvatar = '';
        let webUserId = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
            let savedProfile = null;
            try {
                savedProfile = JSON.parse(localStorage.getItem('tic_profile'));
            } catch (e) { savedProfile = null; }

            if (savedProfile && savedProfile.user_id) {
                // –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                webUserId = savedProfile.user_id;
                playerName = savedProfile.name || '–ò–≥—Ä–æ–∫';
                playerAvatar = savedProfile.avatar || '';
                startApp();
            } else if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready(); // –°–æ–æ–±—â–∞–µ–º Telegram, —á—Ç–æ Mini-App –≥–æ—Ç–æ–≤–∞
                tg.expand(); // –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ

                // DEBUG: –≤—ã–≤–æ–¥–∏–º initDataUnsafe –Ω–∞ —ç–∫—Ä–∞–Ω
                const debugDiv = document.getElementById('debugStatus');
                debugDiv.style.display = 'block';
                debugDiv.innerHTML = '<b>tg.initDataUnsafe:</b><br><pre style="white-space:pre-wrap;text-align:left;font-size:0.95em;background:#fffbe6;padding:8px 10px;border-radius:8px;max-width:95vw;overflow-x:auto;">' +
                  JSON.stringify(tg.initDataUnsafe, null, 2) + '</pre>';

                // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –∏ –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                setTimeout(() => {
                    const user = tg.initDataUnsafe?.user;
                    if (user && user.id) {
                        webUserId = user.id;
                        playerName = user.first_name || user.username || '–ò–≥—Ä–æ–∫';
                        playerAvatar = '';
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –≤ localStorage
                        localStorage.setItem('tic_profile', JSON.stringify({ user_id: webUserId, name: playerName, avatar: playerAvatar }));
                        startApp();
                    } else {
                        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç
                        playerName = '–ì–æ—Å—Ç—å';
                        playerAvatar = '';
                        webUserId = null;
                        startApp();
                    }
                }, 500);
            } else {
                // –ù–µ –≤ Telegram, –¥–µ—Ñ–æ–ª—Ç
                playerName = '–ì–æ—Å—Ç—å';
                playerAvatar = '';
                webUserId = null;
                startApp();
            }
        });

        function startApp() {
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
            socket = io();

            const debugDiv = document.getElementById('debugStatus');
            let socketUrl = window.location.origin;
            debugDiv.style.display = 'block';
            debugDiv.innerHTML = 'Socket.IO URL: <b>' + socketUrl + '</b><br>';

            socket.on('connect', () => {
              debugDiv.style.display = 'block';
              debugDiv.textContent = '‚úÖ Socket.IO: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
              setTimeout(()=>{debugDiv.style.display='none';}, 2000);
            });
            socket.on('connect_error', (err) => {
              debugDiv.style.display = 'block';
              debugDiv.textContent = '‚õî Socket.IO: –æ—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è ‚Äî ' + (err && err.message ? err.message : err);
            });
            socket.on('disconnect', () => {
              debugDiv.style.display = 'block';
              debugDiv.textContent = '‚õî Socket.IO: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ';
            });

            // –ï—Å–ª–∏ –µ—Å—Ç—å user_id, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
            if (webUserId) {
                socket.emit('identify', { user_id: webUserId, name: playerName, avatar: playerAvatar });
            }

            // –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–æ—Ñ–∏–ª—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            if (!webUserId) {
                showAuthOverlay();
                // Fallback: –µ—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –ø—Ä–∏–¥—ë—Ç –∑–∞ 10 —Å–µ–∫—É–Ω–¥ ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
                setTimeout(() => {
                    if (document.getElementById('mainContainer').style.display === 'none') {
                        document.getElementById('authStatus').textContent = '‚õî –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
                        document.getElementById('authActionBtn').textContent = '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é';
                    }
                }, 10000);
            } else {
                hideAuthOverlay();
            }

            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏
            setupSocketListeners();
            setupEventListeners();
            getLobbies();
        }

        function setupSocketListeners() {
            socket.on('connect', () => {
            });

            socket.on('disconnect', () => {
            });


            socket.on('lobby_created', (data) => {
                currentLobby = data.lobby;
                currentPlayer = data.lobby.players[0];
                showLobbyRoom();
            });

            socket.on('update_lobby', (lobby) => {
                currentLobby = lobby;
                // –µ—Å–ª–∏ –≤ —Å–ø–∏—Å–∫–µ –∏–≥—Ä–æ–∫–æ–≤ –µ—Å—Ç—å –∑–∞–ø–∏—Å—å —Å –Ω–∞—à–∏–º sid ‚Äî –Ω–∞–∑–Ω–∞—á–∏–º currentPlayer
                try {
                    if (lobby.players && socket.id) {
                        const me = lobby.players.find(p => p.sid === socket.id);
                        if (me) {
                            currentPlayer = me;
                        }
                    }
                } catch (e) {}
                // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å waiting ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–Ω–∞—Ç—É –æ–∂–∏–¥–∞–Ω–∏—è, –µ—Å–ª–∏ playing ‚Äî –∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ
                if (lobby.status === 'waiting') {
                    showLobbyRoom();
                } else if (lobby.status === 'playing') {
                    showGameBoard();
                } else {
                    showLobbyList();
                }
            });
        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –æ–∂–∏–¥–∞–Ω–∏—è –ª–æ–±–±–∏
        function showLobbyRoom() {
            document.getElementById('gameBoard').style.display = 'none';
            document.querySelector('.lobby-list').style.display = 'none';
            document.querySelector('.create-lobby').style.display = 'none';
            document.getElementById('lobbyRoom').style.display = 'block';
            renderLobbyRoom();
        }

        function renderLobbyRoom() {
            if (!currentLobby) return;
            // –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
            const list = document.getElementById('lobbyPlayersList');
            list.innerHTML = '';
            currentLobby.players.forEach((p, idx) => {
                const div = document.createElement('div');
                div.style = 'display:flex;align-items:center;gap:10px;margin-bottom:8px;';
                div.innerHTML = `<img src="${p.avatar ? p.avatar : 'https://ui-avatars.com/api/?name=' + encodeURIComponent(p.name)}" alt="avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;"> <b>${p.name}</b> <span style="color:#888;">(${p.symbol})</span> ${idx === 0 ? '<span style="color:#1976d2;font-size:0.98em;">—Å–æ–∑–¥–∞—Ç–µ–ª—å</span>' : ''}`;
                list.appendChild(div);
            });
            // –ü—É—Å—Ç—ã–µ –º–µ—Å—Ç–∞
            for (let i = currentLobby.players.length; i < 2; i++) {
                const div = document.createElement('div');
                div.style = 'display:flex;align-items:center;gap:10px;margin-bottom:8px;color:#aaa;';
                div.innerHTML = `<span style="width:32px;height:32px;display:inline-block;background:#eaf2ff;border-radius:50%;"></span> <i>–°–≤–æ–±–æ–¥–Ω–æ</i>`;
                list.appendChild(div);
            }
            // –ö–Ω–æ–ø–∫–∏
            const btns = document.getElementById('lobbyRoomBtns');
            btns.innerHTML = '';
            // –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫–∏
            let isOwner = false;
            if (currentLobby && currentPlayer && currentLobby.players && currentLobby.players.length > 0) {
                isOwner = currentLobby.players[0].user_id === currentPlayer.user_id;
            }
            if (isOwner) {
                // –ö–Ω–æ–ø–∫–∞ "–ò–≥—Ä–∞—Ç—å" —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ 2 –∏–≥—Ä–æ–∫–∞
                if (currentLobby.players.length === 2) {
                    btns.innerHTML += `<button class="btn btn-primary" onclick="startGame()">–ò–≥—Ä–∞—Ç—å</button>`;
                }
                btns.innerHTML += `<button class="btn btn-secondary" onclick="dissolveLobby()">–†–∞—Å–ø—É—Å—Ç–∏—Ç—å –ª–æ–±–±–∏</button>`;
            } else {
                btns.innerHTML += `<button class="btn btn-secondary" onclick="leaveLobby()">–ü–æ–∫–∏–Ω—É—Ç—å –ª–æ–±–±–∏</button>`;
            }
        }

        function startGame() {
            if (currentLobby) {
                socket.emit('start_game', { lobby_id: currentLobby.id });
            }
        }

        function dissolveLobby() {
            if (currentLobby) {
                socket.emit('dissolve_lobby', { lobby_id: currentLobby.id });
                currentLobby = null;
                currentPlayer = null;
                showLobbyList();
            }
        }

            socket.on('lobbies_list', (lobbies) => {
                renderLobbyList(lobbies);
            });

            // –ö–æ–≥–¥–∞ –±–µ–∫ –≤–µ—Ä–Ω—É–ª –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ Telegram (–≤–∫–ª—é—á–∞—è —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–æ—Ç–æ)
            socket.on('telegram_profile', (profile) => {
                try {
                    if (profile && profile.name) playerName = profile.name;
                    if (profile && profile.avatar) playerAvatar = profile.avatar;
                    if (profile && profile.user_id) webUserId = profile.user_id;
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –≤ localStorage
                    localStorage.setItem('tic_profile', JSON.stringify({ user_id: webUserId, name: playerName, avatar: playerAvatar }));
                    // –µ—Å–ª–∏ —É–∂–µ –≤ –ª–æ–±–±–∏ ‚Äî –æ–±–Ω–æ–≤–∏–º
                    if (currentLobby) {
                        socket.emit('get_lobbies');
                    }
                    // –£–±–∏—Ä–∞–µ–º –æ–≤–µ—Ä–ª–µ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    hideAuthOverlay();
                } catch (e) { }
            });

            socket.on('error', (data) => {
                alert(data.message);
            });
        }

        function setupEventListeners() {
            document.getElementById('createLobbyBtn').addEventListener('click', createLobby);
            document.getElementById('refreshProfileBtn').addEventListener('click', refreshProfile);
            document.getElementById('authorizeBtn').addEventListener('click', authorizeWithBot);
            document.getElementById('leaveGameBtn').addEventListener('click', leaveLobby);
            document.getElementById('newGameBtn').addEventListener('click', resetGame);

            document.querySelectorAll('.cell').forEach((cell, index) => {
                cell.addEventListener('click', () => makeMove(index));
            });
        }

        async function authorizeWithBot() {
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É –±–µ–∫–µ–Ω–¥–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            try {
                const body = { sid: socket.id };
                const resp = await fetch('/auth_code', { method: 'POST', body: JSON.stringify(body), headers: { 'Content-Type': 'application/json' } });
                const data = await resp.json();
                if (data && data.code) {
                    const code = data.code;
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ –∫–æ–¥ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
                    console.log('auth code:', code);

                    // –§–æ—Ä–º–∏—Ä—É–µ–º deeplink –Ω–∞ –±–æ—Ç–∞ —Å payload auth:<code>
                    const botUsername = 'hesusinsidemegabot';
                    const link = `https://t.me/${botUsername}?start=auth:${encodeURIComponent(code)}`;

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–¥ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è —Ä—É—á–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    document.getElementById('authStatus').innerHTML =
                        `<b>1.</b> <a href="${link}" target="_blank">–û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram</a><br>` +
                        `<b>2.</b> –ï—Å–ª–∏ –±–æ—Ç –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, <b>–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–º–∞–Ω–¥—É –Ω–∏–∂–µ</b> —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –µ—ë, –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É:<br>` +
                        `<div id="copyAuthCode" style="margin:8px 0;padding:6px 10px;background:#fffbe6;border-radius:8px;font-size:1.08em;word-break:break-all;cursor:pointer;user-select:all;transition:background 0.2s;">/start auth:${code}</div>` +
                        `<span id="copyHint" style="display:none;color:#1976d2;font-size:0.97em;">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!</span>` +
                        `<span style="color:#b00;font-size:0.98em;display:block;margin-top:4px;">–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ Mini‚ÄëApp ‚Äî –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</span>`;
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
                    setTimeout(() => {
                        const copyDiv = document.getElementById('copyAuthCode');
                        if (copyDiv) {
                            copyDiv.onclick = function() {
                                const text = copyDiv.textContent;
                                if (navigator.clipboard) {
                                    navigator.clipboard.writeText(text);
                                } else {
                                    // fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                                    const textarea = document.createElement('textarea');
                                    textarea.value = text;
                                    document.body.appendChild(textarea);
                                    textarea.select();
                                    document.execCommand('copy');
                                    document.body.removeChild(textarea);
                                }
                                const hint = document.getElementById('copyHint');
                                if (hint) {
                                    hint.style.display = 'inline';
                                    setTimeout(()=>{hint.style.display='none';}, 1200);
                                }
                                copyDiv.style.background = '#e3eaff';
                                setTimeout(()=>{copyDiv.style.background='#fffbe6';}, 600);
                            };
                        }
                    }, 100);
                } else {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                }
            } catch (e) {
                console.error('auth error', e);
                alert('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É.');
            }
        }

        function showAuthOverlay() {
            const ov = document.getElementById('authOverlay');
            ov.style.display = 'flex';
            document.getElementById('mainContainer').style.display = 'none';
            // bind default action
            document.getElementById('authActionBtn').onclick = authorizeWithBot;
        }

        function hideAuthOverlay() {
            const ov = document.getElementById('authOverlay');
            ov.style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
        }

        function createLobby() {
            const name = '–õ–æ–±–±–∏';
            socket.emit('create_lobby', { name: name, player_name: playerName, player_avatar: playerAvatar, user_id: webUserId });
        }

        function refreshProfile() {
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                const user = (tg.initDataUnsafe && tg.initDataUnsafe.user) || null;
                if (user && user.id) {
                    webUserId = user.id;
                    playerName = user.first_name || user.username || '–ì–æ—Å—Ç—å';
                    playerAvatar = '';
                    socket.emit('identify', { user_id: user.id, name: playerName, avatar: '' });
                }
            }
        }

        function joinLobby(lobbyId) {
            socket.emit('join_lobby', { lobby_id: lobbyId, player_name: playerName, player_avatar: playerAvatar, user_id: webUserId });
            // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º UI —Å—Ä–∞–∑—É ‚Äî —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏—à–ª—ë—Ç update_lobby —á—Ç–æ–±—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
            showGameBoard();
        }

        function leaveLobby() {
            if (currentLobby) {
                socket.emit('leave_lobby', { lobby_id: currentLobby.id });
                currentLobby = null;
                currentPlayer = null;
                showLobbyList();
            }
        }

        function makeMove(position) {
            if (currentLobby && currentPlayer && currentLobby.current_player === currentPlayer.symbol) {
                socket.emit('make_move', { lobby_id: currentLobby.id, position: position });
            }
        }

        function resetGame() {
            // –°–±—Ä–æ—Å –∏–≥—Ä—ã - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É
            if (currentLobby) {
                currentLobby.board = ['', '', '', '', '', '', '', '', ''];
                currentLobby.status = 'playing';
                currentLobby.current_player = 'X';
                updateGameDisplay();
            }
        }

        function getLobbies() {
            socket.emit('get_lobbies');
        }

        function renderLobbyList(lobbies) {
            const lobbyList = document.getElementById('lobbyList');
            lobbyList.innerHTML = '';

            lobbies.forEach(lobby => {
                const lobbyCard = document.createElement('div');
                lobbyCard.className = 'lobby-card';
                lobbyCard.innerHTML = `
                    <h3>${lobby.name}</h3>
                    <div class="lobby-info">
                        <div class="lobby-players">
                            ${lobby.players.map(p => `
                                <div class="player" style="display:flex;align-items:center;gap:6px;">
                                    <img src="${p.avatar ? p.avatar : 'https://ui-avatars.com/api/?name=' + encodeURIComponent(p.name)}" alt="avatar" style="width:24px;height:24px;border-radius:50%;object-fit:cover;">
                                    <span>${p.name} <b>(${p.symbol})</b></span>
                                </div>
                            `).join('')}
                            ${lobby.players.length < 2 ? '<div class="player empty">–°–≤–æ–±–æ–¥–Ω–æ</div>' : ''}
                        </div>
                        <div class="lobby-status">${getStatusText(lobby.status)}</div>
                    </div>
                    <div class="lobby-actions">
                        <button class="btn btn-primary join-btn" data-id="${lobby.id}">
                            <i class="fas fa-sign-in-alt"></i> –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                        </button>
                        <button class="btn btn-secondary info-btn" data-id="${lobby.id}">
                            <i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ
                        </button>
                    </div>
                `;

                lobbyList.appendChild(lobbyCard);
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            document.querySelectorAll('.join-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const lobbyId = this.getAttribute('data-id');
                    joinLobby(lobbyId);
                });
            });

            document.querySelectorAll('.info-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const lobbyId = this.getAttribute('data-id');
                    const lobby = lobbies.find(l => l.id === lobbyId);
                    if (lobby) {
                        alert(`–õ–æ–±–±–∏: ${lobby.name}\n–ò–≥—Ä–æ–∫–∏: ${lobby.players.map(p => p.name + ' (' + p.symbol + ')').join(', ')}\n–°—Ç–∞—Ç—É—Å: ${getStatusText(lobby.status)}`);
                    }
                });
            });
        }

        function getStatusText(status) {
            switch(status) {
                case 'waiting': return '–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞';
                case 'playing': return '–ò–≥—Ä–∞ –∏–¥–µ—Ç';
                case 'finished': return '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞';
                default: return status;
            }
        }

        function showGameBoard() {
            document.querySelector('.lobby-list').style.display = 'none';
            document.querySelector('.create-lobby').style.display = 'none';
            document.getElementById('gameBoard').style.display = 'block';
            updateGameDisplay();
        }

        function showLobbyList() {
            document.getElementById('gameBoard').style.display = 'none';
            document.querySelector('.lobby-list').style.display = 'grid';
            document.querySelector('.create-lobby').style.display = 'block';
            getLobbies();
        }


        function updateGameDisplay() {
            if (!currentLobby) return;

            // –û–±–Ω–æ–≤–∏—Ç—å –¥–æ—Å–∫—É
            currentLobby.board.forEach((cell, index) => {
                const cellElement = document.querySelector(`[data-index="${index}"]`);
                cellElement.textContent = cell;
                cellElement.className = 'cell';
                if (cell) {
                    cellElement.classList.add(cell.toLowerCase());
                }
            });

            // –†–µ–Ω–¥–µ—Ä–∏–º –∏–≥—Ä–æ–∫–æ–≤ –∏ —Å—Ç–∞—Ç—É—Å
            renderStatusAndPlayers(currentLobby);
            document.getElementById('statusMessage').className = `status-message status-${currentLobby.status === 'finished' ? 'win' : currentLobby.status === 'playing' ? 'playing' : 'waiting'}`;

            // –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
            if (currentPlayer) {
                const isMyTurn = currentLobby.status === 'playing' && currentLobby.current_player === currentPlayer.symbol;
                document.getElementById('currentPlayer').textContent = isMyTurn ? `–í–∞—à —Ö–æ–¥ (${currentPlayer.symbol})` : `–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞`;
                document.getElementById('currentPlayer').className = isMyTurn ? 'player-turn' : 'player-wait';
            }

            // –ú–æ–¥–∞–ª–∫–∞ –ø–æ–±–µ–¥—ã
            if (currentLobby.status === 'finished') {
                let winnerName = '';
                let isDraw = false;
                if (currentLobby.winner === 'draw') {
                    winnerName = '–ù–∏—á—å—è!';
                    isDraw = true;
                } else {
                    const winner = currentLobby.players.find(p => p.symbol === currentLobby.winner);
                    winnerName = winner ? `–ü–æ–±–µ–¥–∏–ª ${winner.name}!` : `–ü–æ–±–µ–¥–∏–ª ${currentLobby.winner}!`;
                }
                showWinModal(winnerName, isDraw);
            } else {
                hideWinModal();
            }
        }
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–±–µ–¥—ã
        function showWinModal(winnerText, isDraw) {
            const modal = document.getElementById('winModal');
            const anim = document.getElementById('winModalAnim');
            const text = document.getElementById('winModalText');
            const btns = document.getElementById('winModalBtns');
            modal.style.display = 'flex';
            anim.textContent = isDraw ? 'ü§ù' : 'üéâ';
            text.textContent = winnerText;
            btns.innerHTML = '';
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫—Ç–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –ª–æ–±–±–∏
            let isOwner = false;
            if (currentLobby && currentPlayer && currentLobby.players && currentLobby.players.length > 0) {
                isOwner = currentLobby.players[0].user_id === currentPlayer.user_id;
            }
            if (isOwner) {
                btns.innerHTML = `
                    <button class="btn btn-secondary" onclick="hideWinModal();showLobbyList();">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É</button>
                    <button class="btn btn-primary" onclick="hideWinModal();resetGame();">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
                `;
            } else {
                btns.innerHTML = `<button class="btn btn-secondary" onclick="hideWinModal();leaveLobby();">–ü–æ–∫–∏–Ω—É—Ç—å –∏–≥—Ä—É</button>`;
            }
        }

        function hideWinModal() {
            const modal = document.getElementById('winModal');
            modal.style.display = 'none';
        }

            // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –≤ HTML
            function escapeHTML(s) {
                return String(s).replace(/[&<>"']/g, function (c) {
                    return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c];
                });
            }

            // –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä —Å—Ç–∞—Ç—É—Å–∞/–∏–≥—Ä–æ–∫–æ–≤
            function renderStatusAndPlayers(lobby) {
                const statusEl = document.getElementById('statusMessage');
                if (!lobby || !lobby.players) { statusEl.innerHTML = ''; return; }

                const playersHtml = lobby.players.map(p => {
                    const avatar = p.avatar ? escapeHTML(p.avatar) : `https://ui-avatars.com/api/?name=${encodeURIComponent(escapeHTML(p.name))}`;
                    // –ï—Å–ª–∏ –Ω–∏–∫ –¥–ª–∏–Ω–Ω–µ–µ 10 —Å–∏–º–≤–æ–ª–æ–≤ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å marquee
                    const isLong = p.name && p.name.length > 10;
                    return `
                        <div class="player-small">
                            <img src="${avatar}" alt="avatar">
                            <div style="display:flex;flex-direction:column;">
                                <span class="name${isLong ? ' marquee' : ''}">${escapeHTML(p.name)}</span>
                                <span class="symbol">(${escapeHTML(p.symbol)})</span>
                            </div>
                        </div>
                    `;
                }).join('<span class="vs-sep">vs</span>');

                let statusText = '';
                if (lobby.status === 'playing') statusText = `–ò–≥—Ä–∞ –∏–¥–µ—Ç | –•–æ–¥ ${escapeHTML(lobby.current_player)}`;
                else if (lobby.status === 'waiting') statusText = '–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞';
                else if (lobby.status === 'finished') statusText = lobby.winner === 'draw' ? '–ù–∏—á—å—è' : `–ü–æ–±–µ–¥–∏–ª ${escapeHTML(lobby.winner)}`;

                statusEl.innerHTML = `<div class="players-row">${playersHtml}</div><div class="status-line">${statusText}</div>`;
            }
    </script>
</body>
</html>