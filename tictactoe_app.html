<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
    /* Максимально современный Discord ремастер */
    :root {
      --discord-primary: #5865f2;
      --discord-success: #23a559;
      --discord-warning: #fee75c;
      --discord-danger: #f23f43;
      --discord-brand: #5865f2;
      --discord-blurple: #5865f2;

      /* Темная палитра */
      --bg-primary: #313338;
      --bg-secondary: #2b2d31;
      --bg-tertiary: #1e1f22;
      --bg-accent: #404eed;

      /* Текст */
      --text-primary: #dbdee1;
      --text-secondary: #b5bac1;
      --text-muted: #80848e;
      --text-link: #00aff4;

      /* Границы и разделители */
      --border-primary: #3f4248;
      --border-secondary: #202225;

      /* Тени */
      --shadow-high: 0 8px 16px rgba(0, 0, 0, 0.24);
      --shadow-medium: 0 4px 8px rgba(0, 0, 0, 0.16);
      --shadow-low: 0 2px 4px rgba(0, 0, 0, 0.08);

      /* Радиусы */
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;

      /* Анимации */
      --transition-fast: 0.15s ease-out;
      --transition-medium: 0.25s ease-out;
      --transition-slow: 0.35s ease-out;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', 'Whitney', 'Helvetica Neue', Arial, sans-serif;
      font-size: 16px;
      line-height: 1.4;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Основной контейнер */
    .app-container {
      width: 100%;
      max-width: 520px;
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-high);
      overflow: hidden;
      position: relative;
    }

    /* Шапка приложения */
    .app-header {
      background: var(--bg-primary);
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-primary);
      position: relative;
    }

    .app-header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--discord-primary), var(--discord-success));
    }

    .app-title {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: center;
    }

    .app-title::before {
      content: '\f1e7';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      font-size: 1.2rem;
      color: var(--discord-primary);
    }

    /* Основной контент */
    .app-content {
      padding: 24px;
    }

    /* Секция главного меню */
    .main-menu {
      text-align: center;
      margin-bottom: 24px;
    }

    .menu-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 20px 0;
    }

    .menu-description {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin: 0 0 24px 0;
      line-height: 1.5;
    }

    /* Кнопки главного меню */
    .menu-buttons {
      display: grid;
      gap: 12px;
      margin-bottom: 24px;
    }

    .menu-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 16px 20px;
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-lg);
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: 500;
      text-decoration: none;
      transition: all var(--transition-medium);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .menu-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s;
    }

    .menu-btn:hover::before {
      left: 100%;
    }

    .menu-btn:hover {
      background: var(--bg-accent);
      border-color: var(--discord-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .menu-btn:active {
      transform: translateY(0);
    }

    .menu-btn.primary {
      background: var(--discord-primary);
      color: white;
      border-color: var(--discord-primary);
    }

    .menu-btn.primary:hover {
      background: #4752c4;
      border-color: #4752c4;
    }

    .menu-btn i {
      font-size: 1.1rem;
    }

    /* Список лобби */
    .lobby-section {
      margin-bottom: 24px;
    }

    .lobby-section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 16px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .lobby-section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-primary);
    }

    .lobby-grid {
      display: grid;
      gap: 12px;
      margin-bottom: 16px;
    }

    .lobby-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-lg);
      padding: 16px;
      transition: all var(--transition-medium);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .lobby-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--discord-primary), var(--discord-success));
      opacity: 0;
      transition: opacity var(--transition-medium);
    }

    .lobby-card:hover {
      border-color: var(--discord-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .lobby-card:hover::before {
      opacity: 1;
    }

    .lobby-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .lobby-name {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .lobby-status {
      padding: 4px 8px;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .lobby-status.playing {
      background: rgba(88, 101, 242, 0.2);
      color: var(--discord-primary);
    }

    .lobby-status.waiting {
      background: rgba(254, 231, 92, 0.2);
      color: var(--discord-warning);
    }

    .lobby-players {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .player-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .player-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--discord-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.9rem;
      color: white;
      object-fit: cover;
    }

    .player-avatar-img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--border-primary);
    }

    .player-details {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .player-name {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .player-symbol {
      font-size: 0.8rem;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .empty-slot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--border-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .lobby-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .action-btn {
      flex: 1;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .action-btn:hover {
      background: var(--discord-primary);
      border-color: var(--discord-primary);
      color: white;
    }

    /* Игровое поле */
    .game-section {
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      padding: 24px;
      text-align: center;
      position: relative;
    }

    .game-status {
      margin-bottom: 20px;
    }

    .game-status-text {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 8px 0;
    }

    .game-status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      font-size: 0.9rem;
      font-weight: 500;
    }

    .game-status-indicator.your-turn {
      background: rgba(88, 101, 242, 0.2);
      color: var(--discord-primary);
    }

    .game-status-indicator.waiting {
      background: rgba(128, 132, 142, 0.2);
      color: var(--text-secondary);
    }

    .players-display {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .player-display {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      border: 2px solid transparent;
      transition: all var(--transition-medium);
    }

    .player-display.active {
      border-color: var(--discord-primary);
      background: rgba(88, 101, 242, 0.1);
    }

    .player-display-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--discord-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.1rem;
      color: white;
      object-fit: cover;
    }

    .player-display-avatar-img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--border-primary);
    }

    .player-display-info {
      text-align: left;
    }

    .player-display-name {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .player-display-symbol {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin: 0;
    }

    .vs-divider {
      color: var(--discord-warning);
      font-size: 1.2rem;
      font-weight: 700;
    }

    /* Игровое поле */
    .game-board-container {
      margin: 24px 0;
    }

    .board-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
    }

    .game-cell {
      aspect-ratio: 1;
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: calc(2rem + 1vw);
      font-weight: 700;
      cursor: pointer;
      transition: all var(--transition-medium);
      border: 3px solid transparent;
      position: relative;
      overflow: hidden;
    }

    .game-cell::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center, transparent 70%, rgba(255, 255, 255, 0.05));
      opacity: 0;
      transition: opacity var(--transition-medium);
    }

    .game-cell:hover:not(.taken)::before {
      opacity: 1;
    }

    .game-cell:hover:not(.taken) {
      background: var(--bg-accent);
      border-color: var(--discord-primary);
      transform: scale(1.05);
      box-shadow: var(--shadow-medium);
    }

    .game-cell.taken {
      cursor: default;
      opacity: 0.8;
    }

    .game-cell.x {
      color: var(--discord-success);
      background: rgba(35, 165, 89, 0.15);
    }

    .game-cell.o {
      color: var(--discord-warning);
      background: rgba(254, 231, 92, 0.15);
    }

    .game-cell.win {
      animation: winAnimation 0.8s ease-in-out;
      border-color: var(--discord-success);
      box-shadow: 0 0 20px rgba(35, 165, 89, 0.5);
    }

    @keyframes winAnimation {
      0%, 100% { transform: scale(1); }
      25% { transform: scale(1.1); }
      50% { transform: scale(1.05); }
      75% { transform: scale(1.08); }
    }

    /* Кнопки игры */
    .game-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 24px;
    }

    .game-btn {
      padding: 12px 24px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-lg);
      color: var(--text-primary);
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-medium);
      position: relative;
      overflow: hidden;
    }

    .game-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, var(--discord-primary), var(--discord-success));
      opacity: 0;
      transition: opacity var(--transition-medium);
    }

    .game-btn > * {
      position: relative;
      z-index: 1;
    }

    .game-btn:hover::before {
      opacity: 0.1;
    }

    .game-btn:hover {
      background: var(--bg-accent);
      border-color: var(--discord-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .game-btn.primary {
      background: var(--discord-primary);
      color: white;
      border-color: var(--discord-primary);
    }

    .game-btn.primary:hover {
      background: #4752c4;
    }

    .game-btn.danger {
      background: var(--discord-danger);
      color: white;
      border-color: var(--discord-danger);
    }

    .game-btn.danger:hover {
      background: #c2332f;
    }

    /* Комната лобби */
    .lobby-room {
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      padding: 24px;
      text-align: center;
    }

    .lobby-room-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 20px 0;
    }

    .lobby-players-display {
      margin-bottom: 24px;
    }

    .lobby-player {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 16px;
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      margin-bottom: 12px;
    }

    .lobby-player-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--discord-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.3rem;
      color: white;
      object-fit: cover;
    }

    .lobby-player-avatar-img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--border-primary);
    }

    .lobby-player-info h3 {
      margin: 0;
      font-size: 1.1rem;
      color: var(--text-primary);
    }

    .lobby-player-info .symbol {
      color: var(--discord-primary);
      font-weight: 600;
    }

    .lobby-room-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    /* Модальные окна */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      backdrop-filter: blur(4px);
    }

    .modal-content {
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      padding: 32px;
      max-width: 420px;
      width: 90%;
      text-align: center;
      border: 1px solid var(--border-primary);
      box-shadow: var(--shadow-high);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-icon {
      font-size: 3rem;
      margin-bottom: 16px;
    }

    .modal-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 12px 0;
    }

    .modal-description {
      font-size: 1rem;
      color: var(--text-secondary);
      margin: 0 0 24px 0;
      line-height: 1.5;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    /* Оверлей авторизации */
    .auth-overlay {
      position: fixed;
      inset: 0;
      background: rgba(30, 31, 34, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(8px);
    }

    .auth-container {
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      padding: 32px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      border: 2px solid var(--discord-primary);
      box-shadow: 0 0 40px rgba(88, 101, 242, 0.2);
      animation: authPulse 2s ease-in-out infinite;
    }

    @keyframes authPulse {
      0%, 100% { box-shadow: 0 0 40px rgba(88, 101, 242, 0.2); }
      50% { box-shadow: 0 0 60px rgba(88, 101, 242, 0.3); }
    }

    .auth-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 12px 0;
    }

    .auth-description {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin: 0 0 20px 0;
      line-height: 1.5;
    }

    .auth-button {
      width: 100%;
      padding: 14px 20px;
      background: var(--discord-primary);
      border: none;
      border-radius: var(--radius-lg);
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-medium);
      margin-bottom: 16px;
    }

    .auth-button:hover {
      background: #4752c4;
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .auth-status {
      font-size: 0.9rem;
      color: var(--text-muted);
      padding: 12px;
      background: var(--bg-primary);
      border-radius: var(--radius-md);
    }

    .auth-code {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      word-break: break-all;
      cursor: pointer;
      transition: all var(--transition-fast);
      margin: 8px 0;
    }

    .auth-code:hover {
      background: var(--bg-accent);
      border-color: var(--discord-primary);
    }

    /* Адаптивность */
    @media (max-width: 640px) {
      body {
        padding: 8px;
      }

      .app-container {
        max-width: 100%;
        border-radius: var(--radius-lg);
      }

      .app-content {
        padding: 16px;
      }

      .menu-buttons {
        gap: 8px;
      }

      .menu-btn {
        padding: 12px 16px;
        font-size: 0.9rem;
      }

      .board-grid {
        gap: 8px;
      }

      .game-cell {
        font-size: calc(1.8rem + 1vw);
      }

      .players-display {
        gap: 12px;
      }

      .player-display {
        padding: 8px 12px;
      }

      .player-display-avatar {
        width: 32px;
        height: 32px;
        font-size: 1rem;
      }

      .modal-content {
        padding: 24px;
        margin: 16px;
      }

      .auth-container {
        padding: 24px;
        margin: 16px;
      }
    }

    /* Улучшенная анимация загрузки */
    .loading-pulse {
      animation: loadingPulse 1.5s ease-in-out infinite;
    }

    @keyframes loadingPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Плавные переходы между состояниями */
    .fade-enter {
      opacity: 0;
      transform: translateY(10px);
    }

    .fade-enter-active {
      opacity: 1;
      transform: translateY(0);
      transition: opacity 0.3s, transform 0.3s;
    }

    .fade-exit {
      opacity: 1;
      transform: translateY(0);
    }

    .fade-exit-active {
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.3s, transform 0.3s;
    }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <h1 class="app-title">Крестики-нолики</h1>
        </div>

        <div class="app-content">
            <!-- Главное меню -->
            <div class="main-menu">
                <h2 class="menu-title">Добро пожаловать!</h2>
                <p class="menu-description">Создайте новое лобби или присоединяйтесь к существующей игре</p>

                <div class="menu-buttons">
                    <button class="menu-btn primary" id="createLobbyBtn">
                        <i class="fas fa-plus-circle"></i>
                        Создать лобби
                    </button>
                    <button class="menu-btn" id="refreshProfileBtn">
                        <i class="fas fa-sync-alt"></i>
                        Обновить профиль
                    </button>
                    <button class="menu-btn" id="authorizeBtn">
                        <i class="fas fa-user-check"></i>
                        Авторизоваться в боте
                    </button>
                </div>
            </div>

            <!-- Комната лобби -->
            <div id="lobbyRoom" class="lobby-room fade-enter" style="display:none;">
                <h2 class="lobby-room-title">Ожидание игроков</h2>
                <div id="lobbyPlayersList" class="lobby-players-display"></div>
                <div id="lobbyRoomBtns" class="lobby-room-buttons"></div>
            </div>
            <!-- Модальное окно победы -->
            <div id="winModal" class="modal-overlay" style="display:none;">
                <div class="modal-content">
                    <div id="winModalAnim" class="modal-icon">🎉</div>
                    <h2 id="winModalText" class="modal-title">Победа!</h2>
                    <p class="modal-description">Поздравляем с победой в игре!</p>
                    <div id="winModalBtns" class="modal-buttons"></div>
                </div>
            </div>
            <!-- Список доступных лобби -->
            <div class="lobby-section" id="lobbySection">
                <h3 class="lobby-section-title">
                    <i class="fas fa-list"></i>
                    Доступные игры
                </h3>
                <div class="lobby-grid" id="lobbyList">
                    <!-- Лобби будут добавляться динамически -->
                </div>
            </div>

            <!-- Игровое поле -->
            <div class="game-section fade-enter" id="gameBoard" style="display:none;">
                <div class="game-status">
                    <p class="game-status-text">Ход игрока</p>
                    <div class="game-status-indicator your-turn" id="gameStatusIndicator">
                        Ваш ход
                    </div>
                </div>

                <div class="players-display" id="playersDisplay">
                    <!-- Игроки будут добавляться динамически -->
                </div>

                <div class="game-board-container">
                    <div class="board-grid" id="boardGrid">
                        <div class="game-cell" data-index="0"></div>
                        <div class="game-cell" data-index="1"></div>
                        <div class="game-cell" data-index="2"></div>
                        <div class="game-cell" data-index="3"></div>
                        <div class="game-cell" data-index="4"></div>
                        <div class="game-cell" data-index="5"></div>
                        <div class="game-cell" data-index="6"></div>
                        <div class="game-cell" data-index="7"></div>
                        <div class="game-cell" data-index="8"></div>
                    </div>
                </div>

                <div class="game-buttons">
                    <button class="game-btn secondary" id="leaveGameBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        Покинуть игру
                    </button>
                    <button class="game-btn primary" id="newGameBtn">
                        <i class="fas fa-redo"></i>
                        Новая игра
                    </button>
                </div>
            </div>
    </div>
    </div>
            <!-- Оверлей авторизации -->
            <div id="authOverlay" class="auth-overlay" style="display:none;">
                <div class="auth-container">
                    <h2 class="auth-title">Авторизация в Telegram</h2>
                    <p class="auth-description">
                        Для начала игры необходимо подтвердить личность через нашего Telegram-бота.
                        Это займет всего несколько секунд и обеспечит безопасность игрового процесса.
                    </p>
                    <button id="authActionBtn" class="auth-button">
                        <i class="fab fa-telegram-plane"></i>
                        Авторизоваться через бота
                    </button>
                    <div id="authStatus" class="auth-status">Подготовка к авторизации...</div>
                </div>
            </div>


        <noscript>
            <div style="padding:32px;text-align:center;color:#ff6b6b;font-size:1.2rem;">Для работы Mini‑App требуется включить JavaScript.</div>
        </noscript>
        <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
        <script>

        // Глобальные переменные
        let socket;
        let currentLobby = null;
        let currentPlayer = null;
        let playerName = '';
        let playerAvatar = '';
        let webUserId = null;

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', function() {
            // Проверяем localStorage на наличие сохранённого профиля
            let savedProfile = null;
            try {
                savedProfile = JSON.parse(localStorage.getItem('tic_profile'));
            } catch (e) { savedProfile = null; }

            if (savedProfile && savedProfile.user_id) {
                // Если профиль сохранён — используем его
                webUserId = savedProfile.user_id;
                playerName = savedProfile.name || 'Игрок';
                playerAvatar = savedProfile.avatar || '';
                startApp();
            } else if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready(); // Сообщаем Telegram, что Mini-App готова
                tg.expand(); // Расширяем на весь экран если возможно


                // Ждем немного и пытаемся получить профиль
                setTimeout(() => {
                    const user = tg.initDataUnsafe?.user;
                    if (user && user.id) {
                        webUserId = user.id;
                        playerName = user.first_name || user.username || 'Игрок';
                        playerAvatar = '';
                        // Сохраняем профиль в localStorage
                        localStorage.setItem('tic_profile', JSON.stringify({ user_id: webUserId, name: playerName, avatar: playerAvatar }));
                        startApp();
                    } else {
                        // Если не удалось, используем дефолт
                        playerName = 'Гость';
                        playerAvatar = '';
                        webUserId = null;
                        startApp();
                    }
                }, 500);
            } else {
                // Не в Telegram, дефолт
                playerName = 'Гость';
                playerAvatar = '';
                webUserId = null;
                startApp();
            }
        });

        function startApp() {
            // Подключаемся к серверу
            socket = io();

            socket.on('connect', () => {
              console.log('✅ Socket.IO: соединение установлено');
            });
            socket.on('connect_error', (err) => {
              console.error('⛔ Socket.IO: ошибка соединения —', err);
            });
            socket.on('disconnect', () => {
              console.log('⛔ Socket.IO: соединение потеряно');
            });

            // Если есть user_id, отправляем профиль
            if (webUserId && socket) {
                socket.emit('identify', { user_id: webUserId, name: playerName, avatar: playerAvatar });
            }

            // Если нет профиля — показываем обязательный оверлей авторизации
            if (!webUserId) {
                showAuthOverlay();
                // Fallback: если профиль не придёт за 10 секунд — показать ошибку
                setTimeout(() => {
                    if (document.getElementById('mainContainer').style.display === 'none') {
                        document.getElementById('authStatus').textContent = '⛔ Не удалось получить профиль. Проверьте Telegram и попробуйте ещё раз.';
                        document.getElementById('authActionBtn').textContent = 'Повторить авторизацию';
                    }
                }, 10000);
            } else {
                hideAuthOverlay();
            }

            // Настраиваем слушатели
            setupSocketListeners();
            setupEventListeners();
            getLobbies();
        }

        function setupSocketListeners() {
            socket.on('connect', () => {
            });

            socket.on('disconnect', () => {
            });


            socket.on('lobby_created', (data) => {
                currentLobby = data.lobby;
                currentPlayer = data.lobby.players[0];
                showLobbyRoom();
            });

            socket.on('update_lobby', (lobby) => {
                currentLobby = lobby;
                // если в списке игроков есть запись с нашим sid — назначим currentPlayer
                try {
                    if (lobby.players && socket.id) {
                        const me = lobby.players.find(p => p.sid === socket.id);
                        if (me) {
                            currentPlayer = me;
                        }
                    }
                } catch (e) {}
                // Если статус waiting — показываем комнату ожидания, если playing — игровое поле
                if (lobby.status === 'waiting') {
                    showLobbyRoom();
                } else if (lobby.status === 'playing') {
                    showGameBoard();
                } else {
                    showLobbyList();
                }
            });
        // Показать экран ожидания лобби
        function showLobbyRoom() {
            // Плавный переход к комнате лобби
            document.getElementById('gameBoard').style.display = 'none';
            document.getElementById('lobbySection').style.display = 'none';
            document.querySelector('.main-menu').style.display = 'none';

            const lobbyRoom = document.getElementById('lobbyRoom');
            lobbyRoom.style.display = 'block';
            lobbyRoom.classList.add('fade-enter-active');

            renderLobbyRoom();
        }

        function renderPlayers() {
            if (!currentLobby || !currentLobby.players) return;

            const playersContainer = document.getElementById('playersDisplay');
            playersContainer.innerHTML = '';

            currentLobby.players.forEach(player => {
                const playerEl = document.createElement('div');
                playerEl.className = `player-display ${player.symbol === currentLobby.current_player ? 'active' : ''}`;
                playerEl.innerHTML = `
                    <img src="${player.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(player.name)}&background=5865f2&color=ffffff&size=128`}" alt="${player.name}" class="player-display-avatar-img" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(player.name)}&background=5865f2&color=ffffff&size=128';">
                    <div class="player-display-info">
                        <p class="player-display-name">${player.name}</p>
                        <p class="player-display-symbol">Игрок ${player.symbol}</p>
                    </div>
                `;
                playersContainer.appendChild(playerEl);
            });

            // Добавляем разделитель между игроками
            if (currentLobby.players.length === 2) {
                const divider = document.createElement('div');
                divider.className = 'vs-divider';
                divider.innerHTML = 'VS';
                playersContainer.appendChild(divider);
            }
        }

        function renderLobbyRoom() {
            if (!currentLobby) return;

            // Список игроков
            const list = document.getElementById('lobbyPlayersList');
            list.innerHTML = '';

            currentLobby.players.forEach((p, idx) => {
                const div = document.createElement('div');
                div.className = 'lobby-player';
                div.innerHTML = `
                    <img src="${p.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}&background=5865f2&color=ffffff&size=96`}" alt="${p.name}" class="lobby-player-avatar-img" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}&background=5865f2&color=ffffff&size=96';">
                    <div class="lobby-player-info">
                        <h3>${p.name} ${idx === 0 ? '<span style="color: var(--discord-primary); font-size: 0.85em;">(создатель)</span>' : ''}</h3>
                        <span class="symbol">Игрок ${p.symbol}</span>
                    </div>
                `;
                list.appendChild(div);
            });

            // Пустые места для второго игрока
            for (let i = currentLobby.players.length; i < 2; i++) {
                const div = document.createElement('div');
                div.className = 'lobby-player';
                div.innerHTML = `
                    <div class="lobby-player-avatar" style="background: var(--text-muted);">?</div>
                    <div class="lobby-player-info">
                        <h3 style="color: var(--text-muted); font-style: italic;">Ожидание игрока</h3>
                        <span class="symbol" style="color: var(--text-muted);">Свободно</span>
                    </div>
                `;
                list.appendChild(div);
            }

            // Кнопки управления
            const btns = document.getElementById('lobbyRoomBtns');
            btns.innerHTML = '';

            let isOwner = false;
            if (currentLobby && currentPlayer && currentLobby.players && currentLobby.players.length > 0) {
                isOwner = currentLobby.players[0].user_id === currentPlayer.user_id;
            }

            if (isOwner) {
                if (currentLobby.players.length === 2) {
                    btns.innerHTML += `
                        <button class="game-btn primary" onclick="startGame()">
                            <i class="fas fa-play"></i>
                            Начать игру
                        </button>
                    `;
                }
                btns.innerHTML += `
                    <button class="game-btn danger" onclick="dissolveLobby()">
                        <i class="fas fa-trash"></i>
                        Распустить лобби
                    </button>
                `;
            } else {
                btns.innerHTML += `
                    <button class="game-btn secondary" onclick="leaveLobby()">
                        <i class="fas fa-sign-out-alt"></i>
                        Покинуть лобби
                    </button>
                `;
            }
        }

        function startGame() {
            if (currentLobby) {
                socket.emit('start_game', { lobby_id: currentLobby.id });
            }
        }

        function dissolveLobby() {
            if (currentLobby && socket) {
                socket.emit('dissolve_lobby', { lobby_id: currentLobby.id });
                currentLobby = null;
                currentPlayer = null;
                showLobbyList();
            }
        }

        function startGame() {
            if (currentLobby && socket) {
                socket.emit('start_game', { lobby_id: currentLobby.id });
            }
        }

            socket.on('lobbies_list', (lobbies) => {
                renderLobbyList(lobbies);
            });

            // Когда бек вернул профиль из Telegram (включая ссылку на фото)
            socket.on('telegram_profile', (profile) => {
                try {
                    if (profile && profile.name) playerName = profile.name;
                    if (profile && profile.avatar) playerAvatar = profile.avatar;
                    if (profile && profile.user_id) webUserId = profile.user_id;
                    // Сохраняем профиль в localStorage
                    localStorage.setItem('tic_profile', JSON.stringify({ user_id: webUserId, name: playerName, avatar: playerAvatar }));
                    // если уже в лобби — обновим
                    if (currentLobby) {
                        socket.emit('get_lobbies');
                    }
                    // Убираем оверлей авторизации
                    hideAuthOverlay();
                } catch (e) { }
            });

            socket.on('error', (data) => {
                alert(data.message);
            });
        }

        function setupEventListeners() {
            // Основные кнопки меню
            document.getElementById('createLobbyBtn').addEventListener('click', createLobby);
            document.getElementById('refreshProfileBtn').addEventListener('click', refreshProfile);
            document.getElementById('authorizeBtn').addEventListener('click', authorizeWithBot);

            // Кнопки игрового поля
            document.getElementById('leaveGameBtn').addEventListener('click', leaveLobby);
            document.getElementById('newGameBtn').addEventListener('click', resetGame);

            // Обработка кликов по игровым клеткам
            document.querySelectorAll('.game-cell').forEach((cell, index) => {
                cell.addEventListener('click', () => makeMove(index));
                cell.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('taken')) {
                        this.style.transform = 'scale(1.05)';
                    }
                });
                cell.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('taken')) {
                        this.style.transform = '';
                    }
                });
            });

            // Добавляем обработчик для Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('winModal');
                    if (modal.style.display === 'flex') {
                        hideWinModal();
                    }
                }
            });
        }

        async function authorizeWithBot() {
            // Запрашиваем у бекенда уникальный код для авторизации
            try {
                const body = { sid: socket.id };
                const resp = await fetch('/auth_code', { method: 'POST', body: JSON.stringify(body), headers: { 'Content-Type': 'application/json' } });
                const data = await resp.json();
                if (data && data.code) {
                    const code = data.code;
                    // Сохраняем временно код (для отладки)
                    console.log('auth code:', code);

                    // Формируем deeplink на бота с payload auth:<code>
                    const botUsername = 'hesusinsidemegabot';
                    const link = `https://t.me/${botUsername}?start=auth:${encodeURIComponent(code)}`;

                    // Показываем код и инструкцию для ручной авторизации
                    document.getElementById('authStatus').innerHTML =
                        `<b>1.</b> <a href="${link}" target="_blank" style="color:#5865f2;">Откройте бота в Telegram</a><br>` +
                        `<b>2.</b> Если бот не авторизует автоматически, <b>нажмите на команду ниже</b> чтобы скопировать её, и отправьте боту:<br>` +
                        `<div id="copyAuthCode" style="margin:8px 0;padding:6px 10px;background:#40444b;border:1px solid #202225;border-radius:8px;font-size:1.08em;word-break:break-all;cursor:pointer;user-select:all;transition:background 0.2s;color:#dcddde;">/start auth:${code}</div>` +
                        `<span id="copyHint" style="display:none;color:#5865f2;font-size:0.97em;">Скопировано!</span>` +
                        `<span style="color:#b9bbbe;font-size:0.98em;display:block;margin-top:4px;">После этого вернитесь в Mini‑App — авторизация завершится автоматически.</span>`;
                    // Добавляем обработчик для копирования
                    setTimeout(() => {
                        const copyDiv = document.getElementById('copyAuthCode');
                        if (copyDiv) {
                            copyDiv.onclick = function() {
                                const text = copyDiv.textContent;
                                if (navigator.clipboard) {
                                    navigator.clipboard.writeText(text);
                                } else {
                                    // fallback для старых браузеров
                                    const textarea = document.createElement('textarea');
                                    textarea.value = text;
                                    document.body.appendChild(textarea);
                                    textarea.select();
                                    document.execCommand('copy');
                                    document.body.removeChild(textarea);
                                }
                                const hint = document.getElementById('copyHint');
                                if (hint) {
                                    hint.style.display = 'inline';
                                    setTimeout(()=>{hint.style.display='none';}, 1200);
                                }
                                copyDiv.style.background = '#5865f2';
                                setTimeout(()=>{copyDiv.style.background='#40444b';}, 600);
                            };
                        }
                    }, 100);
                } else {
                    alert('Не удалось получить код авторизации. Попробуйте позже.');
                }
            } catch (e) {
                console.error('auth error', e);
                alert('Ошибка запроса к серверу.');
            }
        }

        function showAuthOverlay() {
            const ov = document.getElementById('authOverlay');
            ov.style.display = 'flex';
            document.getElementById('mainContainer').style.display = 'none';
            // bind default action
            document.getElementById('authActionBtn').onclick = authorizeWithBot;
        }

        function hideAuthOverlay() {
            const ov = document.getElementById('authOverlay');
            ov.style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
        }

        function createLobby() {
            if (socket) {
                const name = 'Лобби';
                socket.emit('create_lobby', { name: name, player_name: playerName, player_avatar: playerAvatar, user_id: webUserId });
            }
        }

        function refreshProfile() {
            if (window.Telegram && window.Telegram.WebApp && socket) {
                const tg = window.Telegram.WebApp;
                const user = (tg.initDataUnsafe && tg.initDataUnsafe.user) || null;
                if (user && user.id) {
                    webUserId = user.id;
                    playerName = user.first_name || user.username || 'Гость';
                    playerAvatar = '';
                    socket.emit('identify', { user_id: user.id, name: playerName, avatar: '' });
                }
            }
        }

        function joinLobby(lobbyId) {
            if (socket) {
                socket.emit('join_lobby', { lobby_id: lobbyId, player_name: playerName, player_avatar: playerAvatar, user_id: webUserId });
                // показываем UI сразу — сервер пришлёт update_lobby чтобы синхронизировать
                showGameBoard();
            }
        }

        function leaveLobby() {
            if (currentLobby && socket) {
                socket.emit('leave_lobby', { lobby_id: currentLobby.id });
                currentLobby = null;
                currentPlayer = null;
                showLobbyList();
            }
        }

        function makeMove(position) {
            if (currentLobby && currentPlayer && currentLobby.current_player === currentPlayer.symbol && socket) {
                socket.emit('make_move', { lobby_id: currentLobby.id, position: position });
            }
        }

        function resetGame() {
            // Сброс игры - можно добавить логику
            if (currentLobby) {
                currentLobby.board = ['', '', '', '', '', '', '', '', ''];
                currentLobby.status = 'playing';
                currentLobby.current_player = 'X';
                // Убираем анимацию победы со всех клеток
                document.querySelectorAll('.game-cell').forEach(cell => {
                    cell.classList.remove('win');
                });
                updateGameDisplay();
            }
        }

        function getLobbies() {
            if (socket) {
                socket.emit('get_lobbies');
            }
        }

        function renderLobbyList(lobbies) {
            const lobbyList = document.getElementById('lobbyList');
            lobbyList.innerHTML = '';

            if (lobbies.length === 0) {
                lobbyList.innerHTML = `
                    <div style="text-align: center; color: var(--text-muted); padding: 40px 20px;">
                        <i class="fas fa-gamepad" style="font-size: 3rem; margin-bottom: 16px; opacity: 0.5;"></i>
                        <p style="margin: 0; font-size: 1.1rem;">Нет активных игр</p>
                        <p style="margin: 8px 0 0 0; font-size: 0.9rem;">Создайте новую игру, чтобы начать!</p>
                    </div>
                `;
                return;
            }

            lobbies.forEach(lobby => {
                const lobbyCard = document.createElement('div');
                lobbyCard.className = 'lobby-card';
                lobbyCard.innerHTML = `
                    <div class="lobby-header">
                        <h3 class="lobby-name">${lobby.name}</h3>
                        <span class="lobby-status ${lobby.status}">${getStatusText(lobby.status)}</span>
                    </div>
                    <div class="lobby-players">
                        ${lobby.players.map(p => `
                            <div class="player-info">
                                <img src="${p.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}&background=5865f2&color=ffffff&size=64`}" alt="${p.name}" class="player-avatar-img" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}&background=5865f2&color=ffffff&size=64';">
                                <div class="player-details">
                                    <div class="player-name">${p.name}</div>
                                    <div class="player-symbol">Игрок ${p.symbol}</div>
                                </div>
                            </div>
                        `).join('')}
                        ${lobby.players.length < 2 ? '<div class="empty-slot">Свободно</div>' : ''}
                    </div>
                    <div class="lobby-actions">
                        <button class="action-btn join-btn" data-id="${lobby.id}">
                            <i class="fas fa-sign-in-alt"></i> Присоединиться
                        </button>
                        <button class="action-btn info-btn" data-id="${lobby.id}">
                            <i class="fas fa-info-circle"></i> Инфо
                        </button>
                    </div>
                `;

                lobbyList.appendChild(lobbyCard);
            });

            // Обработчики событий
            document.querySelectorAll('.join-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const lobbyId = this.getAttribute('data-id');
                    joinLobby(lobbyId);
                });
            });

            document.querySelectorAll('.info-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const lobbyId = this.getAttribute('data-id');
                    const lobby = lobbies.find(l => l.id === lobbyId);
                    if (lobby) {
                        showLobbyInfo(lobby);
                    }
                });
            });
        }

        function showLobbyInfo(lobby) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-icon">ℹ️</div>
                    <h2 class="modal-title">Информация о лобби</h2>
                    <p class="modal-description">
                        <strong>Название:</strong> ${lobby.name}<br>
                        <strong>Игроки:</strong> ${lobby.players.map(p => p.name + ' (' + p.symbol + ')').join(', ')}<br>
                        <strong>Статус:</strong> ${getStatusText(lobby.status)}<br>
                        <strong>Создано:</strong> Только что
                    </p>
                    <div class="modal-buttons">
                        <button class="game-btn primary" onclick="this.closest('.modal-overlay').remove()">Понятно</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Закрытие по клику вне модалки
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function getStatusText(status) {
            switch(status) {
                case 'waiting': return 'Ожидание игрока';
                case 'playing': return 'Игра идет';
                case 'finished': return 'Игра завершена';
                default: return status;
            }
        }

        // Улучшенная функция обновления статуса игры
        function updateGameStatus() {
            if (!currentLobby) return;

            const statusText = document.querySelector('.game-status-text');
            const statusIndicator = document.getElementById('gameStatusIndicator');

            switch(currentLobby.status) {
                case 'playing':
                    if (currentPlayer) {
                        const isMyTurn = currentLobby.current_player === currentPlayer.symbol;
                        statusText.textContent = isMyTurn ? 'Ваш ход' : 'Ход соперника';
                        statusIndicator.textContent = isMyTurn ? `Играйте как игрок ${currentPlayer.symbol}` : 'Ожидание хода оппонента';
                        statusIndicator.className = `game-status-indicator ${isMyTurn ? 'your-turn' : 'waiting'}`;
                    }
                    break;
                case 'waiting':
                    statusText.textContent = 'Ожидание игрока';
                    statusIndicator.textContent = 'Дождитесь второго игрока';
                    statusIndicator.className = 'game-status-indicator waiting';
                    break;
                case 'finished':
                    statusText.textContent = 'Игра завершена';
                    if (currentLobby.winner === 'draw') {
                        statusIndicator.textContent = 'Ничья!';
                    } else {
                        const winner = currentLobby.players.find(p => p.symbol === currentLobby.winner);
                        statusIndicator.textContent = `Победил ${winner ? winner.name : currentLobby.winner}!`;
                    }
                    statusIndicator.className = 'game-status-indicator';
                    break;
            }
        }

        // Добавляем плавные переходы между экранами
        function switchToScreen(screenId) {
            // Убираем активные экраны
            document.querySelectorAll('.app-content > div').forEach(div => {
                if (div.id !== screenId && div.style.display !== 'none') {
                    div.classList.remove('fade-enter-active');
                    div.classList.add('fade-exit');
                }
            });

            // Показываем целевой экран
            setTimeout(() => {
                const targetScreen = document.getElementById(screenId);
                targetScreen.style.display = 'block';
                targetScreen.classList.add('fade-enter-active');
            }, 150);
        }

        function showGameBoard() {
            // Плавный переход к игровому полю
            document.getElementById('lobbySection').style.display = 'none';
            document.querySelector('.main-menu').style.display = 'none';
            document.getElementById('lobbyRoom').style.display = 'none';

            const gameBoard = document.getElementById('gameBoard');
            gameBoard.style.display = 'block';
            gameBoard.classList.add('fade-enter-active');

            updateGameDisplay();
        }

        function showLobbyList() {
            // Плавный переход к списку лобби
            document.getElementById('gameBoard').style.display = 'none';
            document.getElementById('lobbyRoom').style.display = 'none';

            const lobbySection = document.getElementById('lobbySection');
            const mainMenu = document.querySelector('.main-menu');

            lobbySection.style.display = 'block';
            mainMenu.style.display = 'block';

            lobbySection.classList.add('fade-enter-active');
            mainMenu.classList.add('fade-enter-active');

            getLobbies();
        }


        function updateGameDisplay() {
            if (!currentLobby) return;

            // Обновляем игровое поле
            currentLobby.board.forEach((cell, index) => {
                const cellElement = document.querySelector(`[data-index="${index}"]`);
                cellElement.textContent = cell;
                cellElement.className = 'game-cell';
                if (cell) {
                    cellElement.classList.add(cell.toLowerCase());
                    cellElement.classList.add('taken');
                }
            });

            // Рендерим игроков и статус
            renderPlayers();

            const statusIndicator = document.getElementById('gameStatusIndicator');
            const statusText = document.querySelector('.game-status-text');

            if (currentPlayer) {
                const isMyTurn = currentLobby.status === 'playing' && currentLobby.current_player === currentPlayer.symbol;
                statusText.textContent = isMyTurn ? 'Ваш ход' : 'Ход соперника';
                statusIndicator.textContent = isMyTurn ? `Играйте как ${currentPlayer.symbol}` : 'Ожидание хода';
                statusIndicator.className = `game-status-indicator ${isMyTurn ? 'your-turn' : 'waiting'}`;
            }

            // Обработка завершения игры
            if (currentLobby.status === 'finished') {
                setTimeout(() => {
                    highlightWinningCells();
                    showGameResult();
                }, 200);
            }
        }

        function showGameResult() {
            if (!currentLobby) return;

            let winnerName = '';
            let isDraw = false;
            let icon = '🎉';

            if (currentLobby.winner === 'draw') {
                winnerName = 'Ничья!';
                isDraw = true;
                icon = '🤝';
            } else {
                const winner = currentLobby.players.find(p => p.symbol === currentLobby.winner);
                winnerName = winner ? `Победил ${winner.name}!` : `Победил ${currentLobby.winner}!`;
                icon = '🎉';
            }

            showWinModal(winnerName, isDraw, icon);
        }

        // Улучшенная обработка кликов по клеткам
        function makeMove(position) {
            if (currentLobby && currentPlayer && currentLobby.current_player === currentPlayer.symbol) {
                // Добавляем визуальную обратную связь
                const cell = document.querySelector(`[data-index="${position}"]`);
                if (!cell.classList.contains('taken')) {
                    cell.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        cell.style.transform = '';
                    }, 150);

                    socket.emit('make_move', { lobby_id: currentLobby.id, position: position });
                }
            }
        }
        // Улучшенное модальное окно победы
        function showWinModal(winnerText, isDraw, icon = '🎉') {
            const modal = document.getElementById('winModal');
            const modalIcon = document.getElementById('winModalAnim');
            const modalTitle = document.getElementById('winModalText');
            const modalDescription = document.querySelector('#winModal .modal-description');
            const modalBtns = document.getElementById('winModalBtns');

            modal.style.display = 'flex';
            modalIcon.textContent = icon;
            modalTitle.textContent = winnerText;
            modalDescription.textContent = isDraw ? 'Отличная игра! Никто не победил.' : 'Поздравляем с победой!';

            modalBtns.innerHTML = '';

            let isOwner = false;
            if (currentLobby && currentPlayer && currentLobby.players && currentLobby.players.length > 0) {
                isOwner = currentLobby.players[0].user_id === currentPlayer.user_id;
            }

            if (isOwner) {
                modalBtns.innerHTML = `
                    <button class="game-btn danger" onclick="hideWinModal(); leaveLobby();">
                        <i class="fas fa-times"></i>
                        Завершить
                    </button>
                    <button class="game-btn primary" onclick="hideWinModal(); resetGame();">
                        <i class="fas fa-redo"></i>
                        Играть снова
                    </button>
                `;
            } else {
                modalBtns.innerHTML = `
                    <button class="game-btn primary" onclick="hideWinModal(); leaveLobby();">
                        <i class="fas fa-check"></i>
                        Понятно
                    </button>
                `;
            }
        }

        function hideWinModal() {
            const modal = document.getElementById('winModal');
            modal.style.display = 'none';
        }

        // Улучшенная функция авторизации
        function showAuthOverlay() {
            const overlay = document.getElementById('authOverlay');
            const mainContent = document.querySelector('.app-container');

            mainContent.style.filter = 'blur(4px)';
            mainContent.style.pointerEvents = 'none';
            overlay.style.display = 'flex';

            // Добавляем анимацию появления
            setTimeout(() => {
                overlay.style.opacity = '1';
            }, 10);
        }

        function hideAuthOverlay() {
            const overlay = document.getElementById('authOverlay');
            const mainContent = document.querySelector('.app-container');

            mainContent.style.filter = '';
            mainContent.style.pointerEvents = '';
            overlay.style.display = 'none';
        }

        // Улучшенная функция выделения победных клеток
        function highlightWinningCells() {
            if (!currentLobby || currentLobby.status !== 'finished') return;

            const board = currentLobby.board;
            const currentSymbol = currentLobby.winner;

            if (!currentSymbol || currentSymbol === 'draw') return;

            // Определяем победные комбинации
            const winningConditions = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
                [0, 4, 8], [2, 4, 6] // Diagonals
            ];

            // Находим и выделяем победную комбинацию
            winningConditions.forEach((condition, comboIndex) => {
                const [a, b, c] = condition;
                if (board[a] === currentSymbol && board[b] === currentSymbol && board[c] === currentSymbol) {
                    // Выделяем победные клетки с небольшой задержкой для эффекта
                    setTimeout(() => {
                        document.querySelector(`[data-index="${a}"]`).classList.add('win');
                    }, comboIndex * 100);

                    setTimeout(() => {
                        document.querySelector(`[data-index="${b}"]`).classList.add('win');
                    }, comboIndex * 100 + 50);

                    setTimeout(() => {
                        document.querySelector(`[data-index="${c}"]`).classList.add('win');
                    }, comboIndex * 100 + 100);
                }
            });
        }

        // Улучшенная функция сброса игры
        function resetGame() {
            if (currentLobby) {
                // Убираем выделение победных клеток с анимацией
                const winningCells = document.querySelectorAll('.game-cell.win');
                winningCells.forEach((cell, index) => {
                    setTimeout(() => {
                        cell.classList.remove('win');
                    }, index * 50);
                });

                // Сброс игрового состояния
                setTimeout(() => {
                    currentLobby.board = ['', '', '', '', '', '', '', '', ''];
                    currentLobby.status = 'playing';
                    currentLobby.current_player = 'X';
                    updateGameDisplay();
                }, 300);
            }
        }

            // Безопасная вставка текста в HTML
            function escapeHTML(s) {
                return String(s).replace(/[&<>"']/g, function (c) {
                    return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c];
                });
            }

            // Обновлённый рендер статуса/игроков
            function renderStatusAndPlayers(lobby) {
                const statusEl = document.getElementById('statusMessage');
                if (!lobby || !lobby.players) { statusEl.innerHTML = ''; return; }

                const playersHtml = lobby.players.map(p => {
                    const avatar = p.avatar ? escapeHTML(p.avatar) : `https://ui-avatars.com/api/?name=${encodeURIComponent(escapeHTML(p.name))}`;
                    // Если ник длиннее 10 символов — добавляем класс marquee
                    const isLong = p.name && p.name.length > 10;
                    return `
                        <div class="player-small">
                            <img src="${avatar}" alt="avatar">
                            <div style="display:flex;flex-direction:column;">
                                <span class="name${isLong ? ' marquee' : ''}">${escapeHTML(p.name)}</span>
                                <span class="symbol">(${escapeHTML(p.symbol)})</span>
                            </div>
                        </div>
                    `;
                }).join('<span class="vs-sep">vs</span>');

                let statusText = '';
                if (lobby.status === 'playing') statusText = `Игра идет | Ход ${escapeHTML(lobby.current_player)}`;
                else if (lobby.status === 'waiting') statusText = 'Ожидание игрока';
                else if (lobby.status === 'finished') statusText = lobby.winner === 'draw' ? 'Ничья' : `Победил ${escapeHTML(lobby.winner)}`;

                statusEl.innerHTML = `<div class="players-row">${playersHtml}</div><div class="status-line">${statusText}</div>`;
            }
    </script>
</body>
</html>