<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
    /* Modern Discord-style theme */
    :root {
      --discord-dark: #313338;
      --discord-darker: #2b2d31;
      --discord-darkest: #1e1f22;
      --discord-light: #dbdee1;
      --discord-accent: #5865f2;
      --discord-green: #23a559;
      --discord-yellow: #fee75c;
      --discord-red: #f23f43;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      background: var(--discord-darkest);
      color: var(--discord-light);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 20px;
    }

    .discord-container {
      width: 100%;
      max-width: 480px;
      background: var(--discord-darker);
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .discord-header {
      background: var(--discord-dark);
      padding: 16px 20px;
      border-bottom: 1px solid var(--discord-darkest);
    }

    .discord-header h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--discord-light);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .discord-header h1::before {
      content: '\f1e7';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      color: var(--discord-accent);
    }

    .discord-content {
      padding: 20px;
    }

    /* Game Status */
    .status-message {
      font-size: 0.95rem;
      text-align: center;
      margin-bottom: 20px;
      padding: 12px;
      background: var(--discord-dark);
      border-radius: 6px;
      color: var(--discord-light);
    }

    .status-message.status-playing {
      background: var(--discord-accent);
      color: white;
    }

    .status-message.status-win {
      background: var(--discord-green);
      color: white;
    }

    .status-message.status-waiting {
      background: var(--discord-yellow);
      color: #000;
    }

    /* Game Board */
    .game-board {
      background: var(--discord-dark);
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 20px;
    }

    .board-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
    }

    .cell {
      background: var(--discord-darker);
      border-radius: 6px;
      min-height: calc((100vw - 48px) / 3);
      height: auto;
      font-size: calc(1.6rem + (100vw - 320px) / 300);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
      border: 2px solid transparent;
      color: var(--discord-light);
      font-weight: 600;
    }

    .cell:hover {
      background: var(--discord-accent);
      border-color: var(--discord-light);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(88, 101, 242, 0.3);
    }

    .cell.x {
      color: var(--discord-green);
      background: rgba(35, 165, 89, 0.1);
    }

    .cell.o {
      color: var(--discord-yellow);
      background: rgba(254, 231, 92, 0.1);
    }

    .cell.taken {
      cursor: not-allowed;
      opacity: 0.6;
    }

    .cell.taken:hover {
      background: var(--discord-darker);
      border-color: transparent;
      transform: none;
      box-shadow: none;
    }

    /* Current Player Indicator */
    .current-player {
      font-size: 1.08rem;
      font-weight: 600;
      color: var(--discord-light);
      text-align: center;
      margin-bottom: 12px;
    }

    .player-turn {
      color: var(--discord-accent);
    }

    .player-wait {
      color: var(--discord-light);
      opacity: 0.7;
    }

    /* Players Row */
    .players-row {
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 16px;
      overflow-x: hidden;
    }

    .player-small {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--discord-dark);
      border: 1px solid var(--discord-darkest);
      border-radius: 8px;
      padding: 8px 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      min-width: 0;
      max-width: 160px;
      overflow: hidden;
    }

    .player-small img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }

    .player-small .name {
      font-weight: 600;
      font-size: 0.95em;
      color: var(--discord-light);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100px;
    }

    .player-small .symbol {
      color: var(--discord-accent);
      font-weight: 600;
      margin-left: 4px;
    }

    .vs-sep {
      color: var(--discord-yellow);
      font-size: 1.1em;
      margin: 0 6px;
    }

    /* Game Actions */
    .game-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 16px;
    }

    /* Buttons */
    .discord-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 18px;
    }

    .discord-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 120px;
    }

    .discord-btn.primary {
      background: var(--discord-accent);
      color: white;
    }

    .discord-btn.primary:hover {
      background: #4752c4;
      transform: translateY(-1px);
    }

    .discord-btn.secondary {
      background: var(--discord-darkest);
      color: var(--discord-light);
      border: 1px solid var(--discord-light);
    }

    .discord-btn.secondary:hover {
      background: var(--discord-light);
      color: var(--discord-darkest);
    }

    .discord-btn.accent {
      background: var(--discord-yellow);
      color: #000;
    }

    .discord-btn.accent:hover {
      background: #e6d847;
      transform: translateY(-1px);
    }

    .discord-btn:active {
      transform: translateY(1px);
    }

    /* Lobby Section */
    .lobby-section {
      background: var(--discord-dark);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .lobby-list {
      display: grid;
      gap: 12px;
      margin-bottom: 16px;
    }

    .lobby-card {
      background: var(--discord-darker);
      border: 1px solid var(--discord-darkest);
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--discord-light);
    }

    .lobby-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
    }

    .lobby-players {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .player {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .player img {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
    }

    .player.empty {
      color: #72767d;
      font-style: italic;
    }

    .lobby-status {
      font-size: 0.9rem;
      color: #72767d;
    }

    .lobby-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .lobby-actions .discord-btn {
      min-width: 100px;
      font-size: 0.85rem;
    }

    /* Lobby Room */
    .lobby-room {
      background: var(--discord-dark);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .lobby-room h2 {
      margin: 0 0 16px 0;
      color: var(--discord-light);
      font-size: 1.2rem;
    }

    .lobby-players-list {
      margin-bottom: 18px;
    }

    .lobby-player-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      color: var(--discord-light);
    }

    .lobby-player-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--discord-accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: white;
    }

    .lobby-player-info {
      flex: 1;
    }

    .lobby-player-name {
      font-weight: 600;
    }

    .lobby-player-symbol {
      color: var(--discord-accent);
    }

    .lobby-room-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    /* Win Modal */
    .win-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .win-modal-content {
      background: var(--discord-darker);
      border: 1px solid var(--discord-darkest);
      border-radius: 8px;
      max-width: 340px;
      width: 92%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      padding: 32px 20px 24px 20px;
      text-align: center;
      color: var(--discord-light);
      animation: popWin 0.5s cubic-bezier(0.23, 1.12, 0.62, 1.01);
    }

    .win-modal-emoji {
      font-size: 2.5rem;
      margin-bottom: 12px;
    }

    .win-modal-text {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 18px;
      color: var(--discord-light);
    }

    .win-modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    @keyframes popWin {
      0% { transform: scale(0.7); opacity: 0; }
      60% { transform: scale(1.08); opacity: 1; }
      100% { transform: scale(1); }
    }

    /* Auth Overlay */
    .auth-overlay {
      position: fixed;
      inset: 0;
      background: rgba(49, 51, 56, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .auth-content {
      background: var(--discord-darker);
      border: 1px solid var(--discord-accent);
      border-radius: 8px;
      max-width: 340px;
      width: 92%;
      padding: 24px 20px;
      text-align: center;
      color: var(--discord-light);
      backdrop-filter: blur(2px);
      animation: fadeIn 0.3s;
    }

    .auth-title {
      margin: 0 0 8px 0;
      font-size: 1.25rem;
      color: var(--discord-light);
      font-weight: 700;
    }

    .auth-description {
      margin: 0 0 16px 0;
      color: #b9bbbe;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    .auth-status {
      margin-top: 12px;
      color: #b9bbbe;
      font-size: 0.9rem;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Responsive */
    @media (max-width: 600px) {
      .discord-container {
        max-width: 100%;
        border-radius: 0;
      }

      body {
        padding: 0;
      }

      .discord-content {
        padding: 16px;
      }

      .board-grid {
        gap: 6px;
      }

      .cell {
        font-size: calc(1.4rem + (100vw - 320px) / 400);
      }

      .discord-buttons {
        gap: 8px;
      }

      .discord-btn {
        min-width: 90px;
        font-size: 0.85rem;
      }
    }

    /* Animation for winning cells */
    .cell.win {
      animation: winPulse 0.6s ease-in-out;
    }

    @keyframes winPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    </style>
            .board-grid { width:100%; max-width:420px; grid-auto-rows: calc((100vw - 48px) / 3); }
            .cell { height: auto; min-height: calc((100vw - 48px) / 3); font-size: calc(1.6rem + (100vw - 320px) / 300); }
            .game-board { padding:14px; }
            .status-message { font-size:0.95rem; }
        }
    </style>
</head>
<body>
    <div class="discord-container">
        <div class="discord-header">
            <h1>Крестики-нолики</h1>
        </div>

        <div class="discord-content">
            <!-- Экран ожидания лобби -->
            <div id="lobbyRoom" class="lobby-room" style="display:none;">
                <h2>Лобби</h2>
                <div id="lobbyPlayersList" class="lobby-players-list"></div>
                <div id="lobbyRoomBtns" class="lobby-room-buttons"></div>
            </div>
            <!-- Модальное окно победы -->
            <div id="winModal" class="win-modal" style="display:none;">
                <div class="win-modal-content">
                    <div id="winModalAnim" class="win-modal-emoji">🎉</div>
                    <div id="winModalText" class="win-modal-text">Победа!</div>
                    <div id="winModalBtns" class="win-modal-buttons"></div>
                </div>
            </div>
            <!-- Кнопки действий -->
            <div class="discord-buttons">
                <button class="discord-btn primary" id="createLobbyBtn">
                    <i class="fas fa-plus" aria-hidden="true"></i>
                    Создать лобби
                </button>
                <button class="discord-btn secondary" id="refreshProfileBtn">
                    <i class="fas fa-sync-alt" aria-hidden="true"></i>
                    Обновить профиль
                </button>
                <button class="discord-btn accent" id="authorizeBtn">
                    <i class="fas fa-user-check" aria-hidden="true"></i>
                    Авторизоваться
                </button>
            </div>

            <!-- Список лобби -->
            <div class="lobby-list" id="lobbyList">
                <!-- Лобби будут добавляться сюда динамически -->
            </div>

            <!-- Игровое поле -->
            <div class="game-board" id="gameBoard" style="display:none;">
                <div class="current-player">
                    <span id="currentPlayer" class="player-turn">Твой ход!</span>
                </div>

                <div class="status-message status-playing" id="statusMessage">
                    Игра в процессе...
                </div>

                <div class="board-grid" id="boardGrid">
                    <div class="cell" data-index="0"></div>
                    <div class="cell" data-index="1"></div>
                    <div class="cell" data-index="2"></div>
                    <div class="cell" data-index="3"></div>
                    <div class="cell" data-index="4"></div>
                    <div class="cell" data-index="5"></div>
                    <div class="cell" data-index="6"></div>
                    <div class="cell" data-index="7"></div>
                    <div class="cell" data-index="8"></div>
                </div>

                <div class="game-actions">
                    <button class="discord-btn secondary" id="leaveGameBtn">
                        Покинуть
                    </button>
                    <button class="discord-btn primary" id="newGameBtn">
                        Новая игра
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div>
            <!-- Оверлей авторизации — блокирует доступ пока не придёт профиль из бота -->
            <div id="authOverlay" class="auth-overlay" style="display:none;">
                <div class="auth-content">
                    <h2 class="auth-title">Авторизация</h2>
                    <p class="auth-description">Для игры требуется подтверждение через Telegram-бота.<br>Это займёт 5 секунд.</p>
                    <button id="authActionBtn" class="discord-btn primary">Войти через бота</button>
                    <div id="authStatus" class="auth-status">Ожидание авторизации…</div>
                </div>
            </div>

    <div id="debugStatus" style="display:none;padding:10px 0 0 0;text-align:center;color:#ff6b6b;font-size:1.05rem;"></div>

        <noscript>
            <div style="padding:32px;text-align:center;color:#ff6b6b;font-size:1.2rem;">Для работы Mini‑App требуется включить JavaScript.</div>
        </noscript>
        <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
        <script>
        // Fallback: если через 2 секунды ни mainContainer, ни authOverlay не видны — показать ошибку
        setTimeout(() => {
          const main = document.getElementById('mainContainer');
          const auth = document.getElementById('authOverlay');
          if (main && auth && main.style.display === 'none' && auth.style.display === 'none') {
            document.body.innerHTML = '<div style="padding:32px;text-align:center;color:#b00;font-size:1.2rem;">⛔ Ошибка загрузки Mini‑App.<br>Возможно, не удалось подключиться к серверу или Telegram.<br>Попробуйте обновить страницу или открыть позже.</div>';
          }
        }, 2000);

        // Глобальные переменные
        let socket;
        let currentLobby = null;
        let currentPlayer = null;
        let playerName = '';
        let playerAvatar = '';
        let webUserId = null;

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', function() {
            // Проверяем localStorage на наличие сохранённого профиля
            let savedProfile = null;
            try {
                savedProfile = JSON.parse(localStorage.getItem('tic_profile'));
            } catch (e) { savedProfile = null; }

            if (savedProfile && savedProfile.user_id) {
                // Если профиль сохранён — используем его
                webUserId = savedProfile.user_id;
                playerName = savedProfile.name || 'Игрок';
                playerAvatar = savedProfile.avatar || '';
                startApp();
            } else if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready(); // Сообщаем Telegram, что Mini-App готова
                tg.expand(); // Расширяем на весь экран если возможно

                // DEBUG: выводим initDataUnsafe на экран
                const debugDiv = document.getElementById('debugStatus');
                debugDiv.style.display = 'block';
                debugDiv.innerHTML = '<b>tg.initDataUnsafe:</b><br><pre style="white-space:pre-wrap;text-align:left;font-size:0.95em;background:#2f3136;padding:8px 10px;border:1px solid #202225;border-radius:8px;max-width:95vw;overflow-x:auto;color:#dcddde;">' +
                  JSON.stringify(tg.initDataUnsafe, null, 2) + '</pre>';

                // Ждем немного и пытаемся получить профиль
                setTimeout(() => {
                    const user = tg.initDataUnsafe?.user;
                    if (user && user.id) {
                        webUserId = user.id;
                        playerName = user.first_name || user.username || 'Игрок';
                        playerAvatar = '';
                        // Сохраняем профиль в localStorage
                        localStorage.setItem('tic_profile', JSON.stringify({ user_id: webUserId, name: playerName, avatar: playerAvatar }));
                        startApp();
                    } else {
                        // Если не удалось, используем дефолт
                        playerName = 'Гость';
                        playerAvatar = '';
                        webUserId = null;
                        startApp();
                    }
                }, 500);
            } else {
                // Не в Telegram, дефолт
                playerName = 'Гость';
                playerAvatar = '';
                webUserId = null;
                startApp();
            }
        });

        function startApp() {
            // Подключаемся к серверу
            socket = io();

            const debugDiv = document.getElementById('debugStatus');
            let socketUrl = window.location.origin;
            debugDiv.style.display = 'block';
            debugDiv.innerHTML = 'Socket.IO URL: <b>' + socketUrl + '</b><br>';

            socket.on('connect', () => {
              debugDiv.style.display = 'block';
              debugDiv.textContent = '✅ Socket.IO: соединение установлено';
              setTimeout(()=>{debugDiv.style.display='none';}, 2000);
            });
            socket.on('connect_error', (err) => {
              debugDiv.style.display = 'block';
              debugDiv.textContent = '⛔ Socket.IO: ошибка соединения — ' + (err && err.message ? err.message : err);
            });
            socket.on('disconnect', () => {
              debugDiv.style.display = 'block';
              debugDiv.textContent = '⛔ Socket.IO: соединение потеряно';
            });

            // Если есть user_id, отправляем профиль
            if (webUserId) {
                socket.emit('identify', { user_id: webUserId, name: playerName, avatar: playerAvatar });
            }

            // Если нет профиля — показываем обязательный оверлей авторизации
            if (!webUserId) {
                showAuthOverlay();
                // Fallback: если профиль не придёт за 10 секунд — показать ошибку
                setTimeout(() => {
                    if (document.getElementById('mainContainer').style.display === 'none') {
                        document.getElementById('authStatus').textContent = '⛔ Не удалось получить профиль. Проверьте Telegram и попробуйте ещё раз.';
                        document.getElementById('authActionBtn').textContent = 'Повторить авторизацию';
                    }
                }, 10000);
            } else {
                hideAuthOverlay();
            }

            // Настраиваем слушатели
            setupSocketListeners();
            setupEventListeners();
            getLobbies();
        }

        function setupSocketListeners() {
            socket.on('connect', () => {
            });

            socket.on('disconnect', () => {
            });


            socket.on('lobby_created', (data) => {
                currentLobby = data.lobby;
                currentPlayer = data.lobby.players[0];
                showLobbyRoom();
            });

            socket.on('update_lobby', (lobby) => {
                currentLobby = lobby;
                // если в списке игроков есть запись с нашим sid — назначим currentPlayer
                try {
                    if (lobby.players && socket.id) {
                        const me = lobby.players.find(p => p.sid === socket.id);
                        if (me) {
                            currentPlayer = me;
                        }
                    }
                } catch (e) {}
                // Если статус waiting — показываем комнату ожидания, если playing — игровое поле
                if (lobby.status === 'waiting') {
                    showLobbyRoom();
                } else if (lobby.status === 'playing') {
                    showGameBoard();
                } else {
                    showLobbyList();
                }
            });
        // Показать экран ожидания лобби
        function showLobbyRoom() {
            document.getElementById('gameBoard').style.display = 'none';
            document.getElementById('lobbyList').style.display = 'none';
            document.querySelector('.discord-buttons').style.display = 'none';
            document.getElementById('lobbyRoom').style.display = 'block';
            renderLobbyRoom();
        }

        function renderLobbyRoom() {
            if (!currentLobby) return;
            // Список игроков
            const list = document.getElementById('lobbyPlayersList');
            list.innerHTML = '';
            currentLobby.players.forEach((p, idx) => {
                const div = document.createElement('div');
                div.className = 'lobby-player-item';
                const avatarUrl = p.avatar ? p.avatar : `https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}`;
                div.innerHTML = `
                    <div class="lobby-player-avatar">${p.name.charAt(0).toUpperCase()}</div>
                    <div class="lobby-player-info">
                        <div class="lobby-player-name">${p.name}</div>
                        <div class="lobby-player-symbol">(${p.symbol})</div>
                    </div>
                    ${idx === 0 ? '<span style="color: var(--discord-accent); font-size: 0.9em;">создатель</span>' : ''}
                `;
                list.appendChild(div);
            });
            // Пустые места
            for (let i = currentLobby.players.length; i < 2; i++) {
                const div = document.createElement('div');
                div.className = 'lobby-player-item';
                div.innerHTML = `
                    <div class="lobby-player-avatar" style="background: #4f545c;">?</div>
                    <div class="lobby-player-info">
                        <div class="lobby-player-name" style="color: #72767d; font-style: italic;">Свободно</div>
                    </div>
                `;
                list.appendChild(div);
            }
            // Кнопки
            const btns = document.getElementById('lobbyRoomBtns');
            btns.innerHTML = '';
            // Только создатель видит кнопки
            let isOwner = false;
            if (currentLobby && currentPlayer && currentLobby.players && currentLobby.players.length > 0) {
                isOwner = currentLobby.players[0].user_id === currentPlayer.user_id;
            }
            if (isOwner) {
                // Кнопка "Играть" только если 2 игрока
                if (currentLobby.players.length === 2) {
                    btns.innerHTML += `<button class="discord-btn primary" onclick="startGame()">Играть</button>`;
                }
                btns.innerHTML += `<button class="discord-btn secondary" onclick="dissolveLobby()">Распустить лобби</button>`;
            } else {
                btns.innerHTML += `<button class="discord-btn secondary" onclick="leaveLobby()">Покинуть лобби</button>`;
            }
        }

        function startGame() {
            if (currentLobby) {
                socket.emit('start_game', { lobby_id: currentLobby.id });
            }
        }

        function dissolveLobby() {
            if (currentLobby) {
                socket.emit('dissolve_lobby', { lobby_id: currentLobby.id });
                currentLobby = null;
                currentPlayer = null;
                showLobbyList();
            }
        }

            socket.on('lobbies_list', (lobbies) => {
                renderLobbyList(lobbies);
            });

            // Когда бек вернул профиль из Telegram (включая ссылку на фото)
            socket.on('telegram_profile', (profile) => {
                try {
                    if (profile && profile.name) playerName = profile.name;
                    if (profile && profile.avatar) playerAvatar = profile.avatar;
                    if (profile && profile.user_id) webUserId = profile.user_id;
                    // Сохраняем профиль в localStorage
                    localStorage.setItem('tic_profile', JSON.stringify({ user_id: webUserId, name: playerName, avatar: playerAvatar }));
                    // если уже в лобби — обновим
                    if (currentLobby) {
                        socket.emit('get_lobbies');
                    }
                    // Убираем оверлей авторизации
                    hideAuthOverlay();
                } catch (e) { }
            });

            socket.on('error', (data) => {
                alert(data.message);
            });
        }

        function setupEventListeners() {
            document.getElementById('createLobbyBtn').addEventListener('click', createLobby);
            document.getElementById('refreshProfileBtn').addEventListener('click', refreshProfile);
            document.getElementById('authorizeBtn').addEventListener('click', authorizeWithBot);
            document.getElementById('leaveGameBtn').addEventListener('click', leaveLobby);
            document.getElementById('newGameBtn').addEventListener('click', resetGame);

            document.querySelectorAll('.cell').forEach((cell, index) => {
                cell.addEventListener('click', () => makeMove(index));
            });
        }

        async function authorizeWithBot() {
            // Запрашиваем у бекенда уникальный код для авторизации
            try {
                const body = { sid: socket.id };
                const resp = await fetch('/auth_code', { method: 'POST', body: JSON.stringify(body), headers: { 'Content-Type': 'application/json' } });
                const data = await resp.json();
                if (data && data.code) {
                    const code = data.code;
                    // Сохраняем временно код (для отладки)
                    console.log('auth code:', code);

                    // Формируем deeplink на бота с payload auth:<code>
                    const botUsername = 'hesusinsidemegabot';
                    const link = `https://t.me/${botUsername}?start=auth:${encodeURIComponent(code)}`;

                    // Показываем код и инструкцию для ручной авторизации
                    document.getElementById('authStatus').innerHTML =
                        `<b>1.</b> <a href="${link}" target="_blank" style="color:#5865f2;">Откройте бота в Telegram</a><br>` +
                        `<b>2.</b> Если бот не авторизует автоматически, <b>нажмите на команду ниже</b> чтобы скопировать её, и отправьте боту:<br>` +
                        `<div id="copyAuthCode" style="margin:8px 0;padding:6px 10px;background:#40444b;border:1px solid #202225;border-radius:8px;font-size:1.08em;word-break:break-all;cursor:pointer;user-select:all;transition:background 0.2s;color:#dcddde;">/start auth:${code}</div>` +
                        `<span id="copyHint" style="display:none;color:#5865f2;font-size:0.97em;">Скопировано!</span>` +
                        `<span style="color:#b9bbbe;font-size:0.98em;display:block;margin-top:4px;">После этого вернитесь в Mini‑App — авторизация завершится автоматически.</span>`;
                    // Добавляем обработчик для копирования
                    setTimeout(() => {
                        const copyDiv = document.getElementById('copyAuthCode');
                        if (copyDiv) {
                            copyDiv.onclick = function() {
                                const text = copyDiv.textContent;
                                if (navigator.clipboard) {
                                    navigator.clipboard.writeText(text);
                                } else {
                                    // fallback для старых браузеров
                                    const textarea = document.createElement('textarea');
                                    textarea.value = text;
                                    document.body.appendChild(textarea);
                                    textarea.select();
                                    document.execCommand('copy');
                                    document.body.removeChild(textarea);
                                }
                                const hint = document.getElementById('copyHint');
                                if (hint) {
                                    hint.style.display = 'inline';
                                    setTimeout(()=>{hint.style.display='none';}, 1200);
                                }
                                copyDiv.style.background = '#5865f2';
                                setTimeout(()=>{copyDiv.style.background='#40444b';}, 600);
                            };
                        }
                    }, 100);
                } else {
                    alert('Не удалось получить код авторизации. Попробуйте позже.');
                }
            } catch (e) {
                console.error('auth error', e);
                alert('Ошибка запроса к серверу.');
            }
        }

        function showAuthOverlay() {
            const ov = document.getElementById('authOverlay');
            ov.style.display = 'flex';
            document.getElementById('mainContainer').style.display = 'none';
            // bind default action
            document.getElementById('authActionBtn').onclick = authorizeWithBot;
        }

        function hideAuthOverlay() {
            const ov = document.getElementById('authOverlay');
            ov.style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
        }

        function createLobby() {
            const name = 'Лобби';
            socket.emit('create_lobby', { name: name, player_name: playerName, player_avatar: playerAvatar, user_id: webUserId });
        }

        function refreshProfile() {
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                const user = (tg.initDataUnsafe && tg.initDataUnsafe.user) || null;
                if (user && user.id) {
                    webUserId = user.id;
                    playerName = user.first_name || user.username || 'Гость';
                    playerAvatar = '';
                    socket.emit('identify', { user_id: user.id, name: playerName, avatar: '' });
                }
            }
        }

        function joinLobby(lobbyId) {
            socket.emit('join_lobby', { lobby_id: lobbyId, player_name: playerName, player_avatar: playerAvatar, user_id: webUserId });
            // показываем UI сразу — сервер пришлёт update_lobby чтобы синхронизировать
            showGameBoard();
        }

        function leaveLobby() {
            if (currentLobby) {
                socket.emit('leave_lobby', { lobby_id: currentLobby.id });
                currentLobby = null;
                currentPlayer = null;
                showLobbyList();
            }
        }

        function makeMove(position) {
            if (currentLobby && currentPlayer && currentLobby.current_player === currentPlayer.symbol) {
                socket.emit('make_move', { lobby_id: currentLobby.id, position: position });
            }
        }

        function resetGame() {
            // Сброс игры - можно добавить логику
            if (currentLobby) {
                currentLobby.board = ['', '', '', '', '', '', '', '', ''];
                currentLobby.status = 'playing';
                currentLobby.current_player = 'X';
                // Убираем анимацию победы со всех клеток
                document.querySelectorAll('.cell').forEach(cell => {
                    cell.classList.remove('win');
                });
                updateGameDisplay();
            }
        }

        function getLobbies() {
            socket.emit('get_lobbies');
        }

        function renderLobbyList(lobbies) {
            const lobbyList = document.getElementById('lobbyList');
            lobbyList.innerHTML = '';

            lobbies.forEach(lobby => {
                const lobbyCard = document.createElement('div');
                lobbyCard.className = 'lobby-card';
                lobbyCard.innerHTML = `
                    <div class="lobby-info">
                        <h3 style="margin:0 0 8px 0;color:var(--discord-light);font-size:1rem;">${lobby.name}</h3>
                        <div class="lobby-players">
                            ${lobby.players.map(p => `
                                <div class="player">
                                    <img src="${p.avatar ? p.avatar : 'https://ui-avatars.com/api/?name=' + encodeURIComponent(p.name)}" alt="avatar">
                                    <span>${p.name} <b style="color:var(--discord-accent);">(${p.symbol})</b></span>
                                </div>
                            `).join('')}
                            ${lobby.players.length < 2 ? '<div class="player empty">Свободно</div>' : ''}
                        </div>
                        <div class="lobby-status">${getStatusText(lobby.status)}</div>
                    </div>
                    <div class="lobby-actions">
                        <button class="discord-btn primary join-btn" data-id="${lobby.id}">
                            <i class="fas fa-sign-in-alt"></i> Присоединиться
                        </button>
                        <button class="discord-btn secondary info-btn" data-id="${lobby.id}">
                            <i class="fas fa-info-circle"></i> Инфо
                        </button>
                    </div>
                `;

                lobbyList.appendChild(lobbyCard);
            });

            // Обработчики
            document.querySelectorAll('.join-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const lobbyId = this.getAttribute('data-id');
                    joinLobby(lobbyId);
                });
            });

            document.querySelectorAll('.info-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const lobbyId = this.getAttribute('data-id');
                    const lobby = lobbies.find(l => l.id === lobbyId);
                    if (lobby) {
                        alert(`Лобби: ${lobby.name}\nИгроки: ${lobby.players.map(p => p.name + ' (' + p.symbol + ')').join(', ')}\nСтатус: ${getStatusText(lobby.status)}`);
                    }
                });
            });
        }

        function getStatusText(status) {
            switch(status) {
                case 'waiting': return 'Ожидание игрока';
                case 'playing': return 'Игра идет';
                case 'finished': return 'Игра окончена';
                default: return status;
            }
        }

        function showGameBoard() {
            document.getElementById('lobbyList').style.display = 'none';
            document.querySelector('.discord-buttons').style.display = 'none';
            document.getElementById('gameBoard').style.display = 'block';
            updateGameDisplay();
        }

        function showLobbyList() {
            document.getElementById('gameBoard').style.display = 'none';
            document.getElementById('lobbyList').style.display = 'grid';
            document.querySelector('.discord-buttons').style.display = 'flex';
            getLobbies();
        }


        function updateGameDisplay() {
            if (!currentLobby) return;

            // Обновить доску
            currentLobby.board.forEach((cell, index) => {
                const cellElement = document.querySelector(`[data-index="${index}"]`);
                cellElement.textContent = cell;
                cellElement.className = 'cell';
                if (cell) {
                    cellElement.classList.add(cell.toLowerCase());
                }
            });

            // Рендерим игроков и статус
            renderStatusAndPlayers(currentLobby);
            const statusEl = document.getElementById('statusMessage');
            statusEl.className = `status-message ${currentLobby.status === 'playing' ? 'status-playing' : currentLobby.status === 'finished' ? 'status-win' : 'status-waiting'}`;

            // Обновить текущего игрока
            if (currentPlayer) {
                const isMyTurn = currentLobby.status === 'playing' && currentLobby.current_player === currentPlayer.symbol;
                document.getElementById('currentPlayer').textContent = isMyTurn ? `Ваш ход (${currentPlayer.symbol})` : `Ход соперника`;
                document.getElementById('currentPlayer').className = isMyTurn ? 'player-turn' : 'player-wait';
            }

            // Модалка победы
            if (currentLobby.status === 'finished') {
                // Выделяем победные клетки перед показом модалки
                setTimeout(() => highlightWinningCells(), 100);

                let winnerName = '';
                let isDraw = false;
                if (currentLobby.winner === 'draw') {
                    winnerName = 'Ничья!';
                    isDraw = true;
                } else {
                    const winner = currentLobby.players.find(p => p.symbol === currentLobby.winner);
                    winnerName = winner ? `Победил ${winner.name}!` : `Победил ${currentLobby.winner}!`;
                }
                showWinModal(winnerName, isDraw);
            } else {
                hideWinModal();
            }
        }
        // Модальное окно победы
        function showWinModal(winnerText, isDraw) {
            const modal = document.getElementById('winModal');
            const anim = document.getElementById('winModalAnim');
            const text = document.getElementById('winModalText');
            const btns = document.getElementById('winModalBtns');
            modal.style.display = 'flex';
            anim.textContent = isDraw ? '🤝' : '🎉';
            text.textContent = winnerText;
            btns.innerHTML = '';
            // Определяем, кто создатель лобби
            let isOwner = false;
            if (currentLobby && currentPlayer && currentLobby.players && currentLobby.players.length > 0) {
                isOwner = currentLobby.players[0].user_id === currentPlayer.user_id;
            }
            if (isOwner) {
                btns.innerHTML = `
                    <button class="discord-btn secondary" onclick="hideWinModal();showLobbyList();">Завершить игру</button>
                    <button class="discord-btn primary" onclick="hideWinModal();resetGame();">Начать заново</button>
                `;
            } else {
                btns.innerHTML = `<button class="discord-btn secondary" onclick="hideWinModal();leaveLobby();">Покинуть игру</button>`;
            }
        }

        function hideWinModal() {
            const modal = document.getElementById('winModal');
            modal.style.display = 'none';
        }

        // Функция для выделения победных клеток
        function highlightWinningCells() {
            // Найти победную комбинацию для текущего игрока
            if (!currentLobby || currentLobby.status !== 'finished') return;

            // Определяем победные клетки (упрощённая логика для демонстрации)
            const board = currentLobby.board;
            const currentSymbol = currentLobby.winner;

            // Проверяем возможные победные комбинации
            const winningConditions = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
                [0, 4, 8], [2, 4, 6] // Diagonals
            ];

            winningConditions.forEach(condition => {
                const [a, b, c] = condition;
                if (board[a] === currentSymbol && board[b] === currentSymbol && board[c] === currentSymbol) {
                    // Выделяем победные клетки
                    document.querySelector(`[data-index="${a}"]`).classList.add('win');
                    document.querySelector(`[data-index="${b}"]`).classList.add('win');
                    document.querySelector(`[data-index="${c}"]`).classList.add('win');
                }
            });
        }

            // Безопасная вставка текста в HTML
            function escapeHTML(s) {
                return String(s).replace(/[&<>"']/g, function (c) {
                    return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c];
                });
            }

            // Обновлённый рендер статуса/игроков
            function renderStatusAndPlayers(lobby) {
                const statusEl = document.getElementById('statusMessage');
                if (!lobby || !lobby.players) { statusEl.innerHTML = ''; return; }

                const playersHtml = lobby.players.map(p => {
                    const avatar = p.avatar ? escapeHTML(p.avatar) : `https://ui-avatars.com/api/?name=${encodeURIComponent(escapeHTML(p.name))}`;
                    // Если ник длиннее 10 символов — добавляем класс marquee
                    const isLong = p.name && p.name.length > 10;
                    return `
                        <div class="player-small">
                            <img src="${avatar}" alt="avatar">
                            <div style="display:flex;flex-direction:column;">
                                <span class="name${isLong ? ' marquee' : ''}">${escapeHTML(p.name)}</span>
                                <span class="symbol">(${escapeHTML(p.symbol)})</span>
                            </div>
                        </div>
                    `;
                }).join('<span class="vs-sep">vs</span>');

                let statusText = '';
                if (lobby.status === 'playing') statusText = `Игра идет | Ход ${escapeHTML(lobby.current_player)}`;
                else if (lobby.status === 'waiting') statusText = 'Ожидание игрока';
                else if (lobby.status === 'finished') statusText = lobby.winner === 'draw' ? 'Ничья' : `Победил ${escapeHTML(lobby.winner)}`;

                statusEl.innerHTML = `<div class="players-row">${playersHtml}</div><div class="status-line">${statusText}</div>`;
            }
    </script>
</body>
</html>